=== lib/cms.ts ===
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL || 'https://ephdzjkgpkuydpbkxnfw.supabase.co'
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.SUPABASE_SERVICE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || ''

const supabase = createClient(supabaseUrl, supabaseKey)

const MERCHANT = process.env.MERCHANT_CODE || 'minjie'

// Banner æŸ¥è©¢
export async function getBanners(placement: string) {
  const now = new Date().toISOString()
  const { data, error } = await supabase
    .from('cms_banners')
    .select('*')
    .eq('merchant_code', MERCHANT)
    .eq('placement', placement)
    .eq('is_active', true)
    .or(`valid_from.is.null,valid_from.lte.${now}`)
    .or(`valid_until.is.null,valid_until.gte.${now}`)
    .order('sort_order', { ascending: true })

  if (error) console.error('[CMS] getBanners error:', error)
  return data || []
}

// é é¢å€å¡ŠæŸ¥è©¢
export async function getSection(page: string, sectionKey: string) {
  const { data, error } = await supabase
    .from('cms_sections')
    .select('content')
    .eq('merchant_code', MERCHANT)
    .eq('page', page)
    .eq('section_key', sectionKey)
    .eq('is_active', true)
    .single()

  if (error && error.code !== 'PGRST116') {
    console.error('[CMS] getSection error:', error)
  }
  return data?.content || null
}

// æ‰€æœ‰é é¢å€å¡Šï¼ˆä¸€æ¬¡æŸ¥å®Œï¼‰
export async function getAllSections(page: string) {
  const { data, error } = await supabase
    .from('cms_sections')
    .select('section_key, content')
    .eq('merchant_code', MERCHANT)
    .eq('page', page)
    .eq('is_active', true)
    .order('sort_order', { ascending: true })

  if (error) console.error('[CMS] getAllSections error:', error)

  const sections: Record<string, any> = {}
  data?.forEach(row => {
    sections[row.section_key] = row.content
  })
  return sections
}

// å…¬å‘ŠæŸ¥è©¢
export async function getAnnouncements() {
  const now = new Date().toISOString()
  const { data, error } = await supabase
    .from('cms_announcements')
    .select('*')
    .eq('merchant_code', MERCHANT)
    .eq('is_active', true)
    .or(`valid_from.is.null,valid_from.lte.${now}`)
    .or(`valid_until.is.null,valid_until.gte.${now}`)
    .order('sort_order', { ascending: true })

  if (error) console.error('[CMS] getAnnouncements error:', error)
  return data || []
}

// æ¨è–¦å•†å“ ID æŸ¥è©¢
export async function getFeaturedProductIds(placement: string) {
  const { data, error } = await supabase
    .from('cms_featured_products')
    .select('product_id')
    .eq('merchant_code', MERCHANT)
    .eq('placement', placement)
    .eq('is_active', true)
    .order('sort_order', { ascending: true })

  if (error) console.error('[CMS] getFeaturedProductIds error:', error)
  return data?.map(d => d.product_id) || []
}

// ä¿ƒéŠ·æ´»å‹•æŸ¥è©¢
export async function getCampaigns() {
  const now = new Date().toISOString()
  const { data, error } = await supabase
    .from('cms_campaigns')
    .select('*')
    .eq('merchant_code', MERCHANT)
    .eq('is_active', true)
    .or(`valid_from.is.null,valid_from.lte.${now}`)
    .or(`valid_until.is.null,valid_until.gte.${now}`)
    .order('sort_order', { ascending: true })

  if (error) console.error('[CMS] getCampaigns error:', error)
  return data || []
}

// LINE Bot å›ºå®šå›è¦†æŸ¥è©¢
export async function getBotReply(triggerKey: string) {
  const { data, error } = await supabase
    .from('cms_bot_replies')
    .select('reply_type, reply_content')
    .eq('merchant_code', MERCHANT)
    .eq('trigger_key', triggerKey)
    .eq('is_active', true)
    .single()

  if (error && error.code !== 'PGRST116') {
    console.error('[CMS] getBotReply error:', error)
  }
  return data || null
}

// Supabase Storage åœ–ç‰‡ URL
export function getCmsImageUrl(path: string) {
  return `${supabaseUrl}/storage/v1/object/public/cms-assets/${path}`
}


=== lib/medusa.ts ===
import { medusa } from './config';

const BACKEND_URL = medusa.backendUrl;
const PUBLISHABLE_KEY = medusa.publishableKey;
const REGION_ID = medusa.regionId;

// é€šç”¨ fetch å‡½å¼
async function medusaFetch<T>(
  endpoint: string,
  options: RequestInit = {}
): Promise<T> {
  const url = `${BACKEND_URL}${endpoint}`;
  
  const headers: HeadersInit = {
    'Content-Type': 'application/json',
    'x-publishable-api-key': PUBLISHABLE_KEY,
    ...options.headers,
  };

  const response = await fetch(url, {
    ...options,
    headers,
  });

  if (!response.ok) {
    const error = await response.json().catch(() => ({}));
    throw new Error(error.message || `API Error: ${response.status}`);
  }

  return response.json();
}

// ============ å•†å“ API ============

export interface Product {
  id: string;
  title: string;
  handle: string;
  subtitle: string | null;
  description: string | null;
  thumbnail: string | null;
  images: Array<{ id: string; url: string }>;
  options: Array<{
    id: string;
    title: string;
    values: Array<{ id: string; value: string }>;
  }>;
  variants: Array<{
    id: string;
    title: string;
    sku: string | null;
    prices: Array<{
      amount: number;
      currency_code: string;
    }>;
    options: Array<{
      id: string;
      value: string;
      option_id: string;
    }>;
    inventory_quantity?: number;
    calculated_price?: {
      calculated_amount: number;
      original_amount: number;
      currency_code: string;
    };
  }>;
  created_at: string;
  updated_at: string;
}

export interface ProductsResponse {
  products: Product[];
  count: number;
  offset: number;
  limit: number;
}

export async function getProducts(params?: {
  limit?: number;
  offset?: number;
  collection_id?: string[];
}): Promise<ProductsResponse> {
  const searchParams = new URLSearchParams();
  searchParams.set('region_id', REGION_ID);
  
  if (params?.limit) searchParams.set('limit', String(params.limit));
  if (params?.offset) searchParams.set('offset', String(params.offset));
  if (params?.collection_id) {
    params.collection_id.forEach(id => searchParams.append('collection_id[]', id));
  }

  return medusaFetch<ProductsResponse>(`/store/products?${searchParams}`);
}

export async function getProduct(handle: string): Promise<{ product: Product }> {
  const searchParams = new URLSearchParams();
  searchParams.set('region_id', REGION_ID);
  
  return medusaFetch<{ product: Product }>(`/store/products/${handle}?${searchParams}`);
}

export async function getProductByHandle(handle: string): Promise<Product | null> {
  const searchParams = new URLSearchParams();
  searchParams.set('region_id', REGION_ID);
  searchParams.set('handle', handle);

  const response = await medusaFetch<ProductsResponse>(`/store/products?${searchParams}`);
  return response.products[0] || null;
}

// ============ å•†å“åˆ†é¡ API ============

export interface Collection {
  id: string;
  title: string;
  handle: string;
  created_at: string;
  updated_at: string;
}

export interface CollectionsResponse {
  collections: Collection[];
  count: number;
}

export async function getCollections(): Promise<CollectionsResponse> {
  const url = `${BACKEND_URL}/store/collections?limit=50`;
  const res = await fetch(url, {
    headers: {
      'x-publishable-api-key': PUBLISHABLE_KEY,
    },
    next: { revalidate: 3600 },
  });

  if (!res.ok) {
    return { collections: [], count: 0 };
  }

  return res.json();
}

// ============ è³¼ç‰©è»Š API ============

export interface CartItemAdjustment {
  id: string;
  code: string;
  amount: number;
  promotion_id?: string;
}

export interface CartItem {
  id: string;
  title: string;
  description: string | null;
  thumbnail: string | null;
  quantity: number;
  unit_price: number;
  subtotal: number;
  total: number;
  variant: {
    id: string;
    title: string;
    sku: string | null;
    product: {
      id: string;
      title: string;
      handle: string;
      thumbnail: string | null;
    };
  };
  adjustments?: CartItemAdjustment[];
}

export interface CartPromotion {
  code: string;
  is_automatic?: boolean;
}

export interface Cart {
  id: string;
  email: string | null;
  items: CartItem[];
  region: {
    id: string;
    name: string;
    currency_code: string;
  };
  subtotal: number;
  shipping_total: number;
  discount_total: number;
  tax_total: number;
  total: number;
  shipping_address: Address | null;
  billing_address: Address | null;
  shipping_methods: ShippingMethod[];
  promotions?: CartPromotion[];
}

export interface Address {
  first_name: string;
  last_name: string;
  phone: string;
  address_1: string;
  address_2: string | null;
  city: string;
  province: string | null;
  postal_code: string;
  country_code: string;
}

export interface ShippingMethod {
  id: string;
  name: string;
  price: number;
}

export async function createCart(): Promise<{ cart: Cart }> {
  return medusaFetch<{ cart: Cart }>('/store/carts', {
    method: 'POST',
    body: JSON.stringify({
      region_id: REGION_ID,
    }),
  });
}

export async function getCart(cartId: string): Promise<{ cart: Cart }> {
  return medusaFetch<{ cart: Cart }>(`/store/carts/${cartId}`);
}

export async function addToCart(
  cartId: string,
  variantId: string,
  quantity: number = 1
): Promise<{ cart: Cart }> {
  return medusaFetch<{ cart: Cart }>(`/store/carts/${cartId}/line-items`, {
    method: 'POST',
    body: JSON.stringify({
      variant_id: variantId,
      quantity,
    }),
  });
}

export async function updateCartItem(
  cartId: string,
  itemId: string,
  quantity: number
): Promise<{ cart: Cart }> {
  return medusaFetch<{ cart: Cart }>(`/store/carts/${cartId}/line-items/${itemId}`, {
    method: 'POST',
    body: JSON.stringify({ quantity }),
  });
}

export async function removeCartItem(
  cartId: string,
  itemId: string
): Promise<{ cart: Cart }> {
  return medusaFetch<{ cart: Cart }>(`/store/carts/${cartId}/line-items/${itemId}`, {
    method: 'DELETE',
  });
}

export async function updateCart(
  cartId: string,
  data: {
    email?: string;
    shipping_address?: Partial<Address>;
    billing_address?: Partial<Address>;
  }
): Promise<{ cart: Cart }> {
  return medusaFetch<{ cart: Cart }>(`/store/carts/${cartId}`, {
    method: 'POST',
    body: JSON.stringify(data),
  });
}

// ============ Payment Collection API ============

export interface PaymentInitResult {
  success: boolean;
  collectionId?: string;
  sessionId?: string;
  provider?: string;
  error?: string;
}

export interface CustomerInfo {
  firstName?: string;
  lastName?: string;
  email?: string;
  phone?: string;
  address?: string;
  city?: string;
  postalCode?: string;
}

/**
 * åˆå§‹åŒ– Paymentï¼ˆé€é Next.js API Route é¿å… CORSï¼‰
 * POST /api/payment/init â†’ Medusa payment collection + session
 * @param cartId - Medusa cart ID
 * @param customerInfo - Optional customer info to update cart
 * @param metadata - Optional metadata
 * @param shippingMethod - 'cvs' or 'home'
 */
export async function initPaymentForCart(
  cartId: string,
  customerInfo?: CustomerInfo,
  metadata?: Record<string, any>,
  shippingMethod?: 'cvs' | 'home',
  shippingOptionId?: string
): Promise<PaymentInitResult> {
  const res = await fetch('/api/payment/init', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ cartId, customerInfo, metadata, shippingMethod, shippingOptionId }),
  });

  const data = await res.json();

  if (!res.ok || !data.success) {
    throw new Error(data.error || 'Payment initialization failed');
  }

  return data;
}

// ============ å·¥å…·å‡½å¼ ============

// å–å¾—è®Šé«”åƒ¹æ ¼ï¼ˆTWDï¼‰
export function getVariantPrice(variant: Product['variants'][0]): number {
  // å„ªå…ˆä½¿ç”¨è¨ˆç®—å¾Œçš„åƒ¹æ ¼ï¼ˆå«æŠ˜æ‰£ï¼‰
  if (variant.calculated_price) {
    return variant.calculated_price.calculated_amount;
  }
  
  // å¾ prices é™£åˆ—æ‰¾ TWD
  const twdPrice = variant.prices?.find(p => p.currency_code === 'twd');
  return twdPrice?.amount || 0;
}

// å–å¾—å•†å“æœ€ä½åƒ¹æ ¼
export function getProductLowestPrice(product: Product): number {
  if (!product.variants?.length) return 0;
  
  const prices = product.variants.map(v => getVariantPrice(v));
  return Math.min(...prices);
}

// æª¢æŸ¥æ˜¯å¦æœ‰æŠ˜æ‰£
export function hasDiscount(variant: Product['variants'][0]): boolean {
  if (!variant.calculated_price) return false;
  return variant.calculated_price.calculated_amount < variant.calculated_price.original_amount;
}


=== lib/config.ts ===
import storeConfig from '@/config/store.json';

// é¡å‹å®šç¾©
export interface StoreConfig {
  store: {
    name: string;
    shortName: string;
    description: string;
    domain: string;
    logo: string;
    favicon: string;
  };
  theme: {
    primaryColor: string;
    secondaryColor: string;
    accentColor: string;
    fontFamily: string;
    borderRadius: string;
  };
  medusa: {
    backendUrl: string;
    publishableKey: string;
    regionId: string;
    salesChannelId: string;
  };
  gateway: {
    url: string;
    paymentApiKey: string;
    logisticsApiKey: string;
  };
  features: {
    cart: boolean;
    checkout: boolean;
    cvsLogistics: boolean;
    homeDelivery: boolean;
    linePay: boolean;
    memberSystem: boolean;
  };
  shipping: {
    freeShippingThreshold: number;
    cvsOptions: string[];
    homeDeliveryFee: number;
    cvsFee: number;
  };
  contact: {
    email: string;
    phone: string;
    lineOA: string;
    instagram: string;
    facebook: string;
  };
  seo: {
    title: string;
    description: string;
    ogImage: string;
  };
}

// åŒ¯å‡ºè¨­å®š
export const config: StoreConfig = storeConfig as StoreConfig;

// ä¾¿æ·å­˜å–
export const store = config.store;
export const theme = config.theme;
export const medusa = config.medusa;
export const gateway = config.gateway;
export const features = config.features;
export const shipping = config.shipping;
export const contact = config.contact;
export const seo = config.seo;

// å·¥å…·å‡½å¼
export function formatPrice(amount: number, currency: string = 'TWD'): string {
  return new Intl.NumberFormat('zh-TW', {
    style: 'currency',
    currency,
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }).format(amount);
}

export function isFreeShipping(total: number): boolean {
  return total >= shipping.freeShippingThreshold;
}

export function getShippingFee(type: 'cvs' | 'home', total: number): number {
  if (isFreeShipping(total)) return 0;
  return type === 'cvs' ? shipping.cvsFee : shipping.homeDeliveryFee;
}


=== app/(website)/page.tsx ===
import { getProducts } from '@/lib/medusa';
import { getAllSections, getBanners, getCampaigns } from '@/lib/cms';
import HeroBanner from '@/components/cms/HeroBanner';
import TrustNumbers from '@/components/cms/TrustNumbers';
import PaymentLogos from '@/components/cms/PaymentLogos';
import CampaignSection from '@/components/cms/CampaignSection';
import BrandStory from '@/components/cms/BrandStory';
import SectionTitle from '@/components/ui/SectionTitle';
import ProductCard from '@/components/ProductCard';

export const revalidate = 60; // ISR: æ¯ 60 ç§’é‡æ–°é©—è­‰ CMS è³‡æ–™

export default async function HomePage() {
  // ä¸¦è¡ŒæŸ¥è©¢ CMS + Medusa
  const [banners, sections, campaigns, productsData] = await Promise.all([
    getBanners('hero'),
    getAllSections('home'),
    getCampaigns(),
    getProducts({ limit: 50 }),
  ]);

  const featured = productsData.products.slice(0, 6);

  return (
    <>
      {/* Hero Bannerï¼ˆCMSï¼‰ */}
      <HeroBanner banners={banners} />

      {/* ä¿¡ä»»æ•¸å­—ï¼ˆCMSï¼‰ */}
      <TrustNumbers data={sections.trust_numbers} />

      {/* ä¿ƒéŠ·æ´»å‹•ï¼ˆCMSï¼‰ */}
      <CampaignSection campaigns={campaigns} />

      {/* ç†±éŠ·æ¨è–¦ï¼ˆMedusa å•†å“ï¼‰ */}
      <section className="max-w-7xl mx-auto px-5 py-20">
        <SectionTitle subtitle="BEST SELLERS" title="ç†±éŠ·æ¨è–¦" />
        <div className="grid grid-cols-2 md:grid-cols-3 gap-4 md:gap-6">
          {featured.map((product) => (
            <ProductCard key={product.id} product={product} />
          ))}
        </div>
        <div className="text-center mt-10">
          <a href="/products" className="btn-gold-outline">æŸ¥çœ‹å…¨éƒ¨å•†å“ â†’</a>
        </div>
      </section>

      {/* å“ç‰Œæ•…äº‹ï¼ˆCMSï¼‰ */}
      <BrandStory data={sections.brand_story} />

      {/* æœƒå“¡ç¦åˆ©ï¼ˆä¿ç•™åŸæœ‰ï¼Œä¹‹å¾Œ CMS åŒ–ï¼‰ */}
      <section id="membership" style={{
        background: 'linear-gradient(180deg, rgba(212,175,55,0.05), transparent)',
        borderTop: '1px solid rgba(212,175,55,0.1)',
      }}>
        <div className="max-w-7xl mx-auto px-5 py-16 text-center">
          <SectionTitle subtitle="MEMBERSHIP" title="åŠ å…¥ LINE äº«æœƒå“¡ç¦åˆ©" />
          <p className="text-sm mb-10" style={{ color: 'rgba(255,255,255,0.5)' }}>
            æ¶ˆè²» 100 å…ƒ = é€ 1 é» ï½œ ç”Ÿæ—¥ç¦®é‡‘ ï½œ å°ˆå±¬å„ªæƒ  ï½œ æ–°å“æ¶å…ˆçœ‹
          </p>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10">
            {[
              { tier: 'ä¸€èˆ¬æœƒå“¡', spend: 'åŠ å…¥å³äº«', gift: '$100', clr: 'rgba(255,255,255,0.6)' },
              { tier: 'éŠ€å¡æœƒå“¡', spend: 'ç´¯è¨ˆ $3,000', gift: '$200', clr: '#C0C0C0' },
              { tier: 'é‡‘å¡æœƒå“¡', spend: 'ç´¯è¨ˆ $10,000', gift: '$500', clr: '#D4AF37' },
              { tier: 'VIP æœƒå“¡', spend: 'ç´¯è¨ˆ $30,000', gift: '$2,000', clr: '#FFD700' },
            ].map((m) => (
              <div key={m.tier} className="p-5 rounded-xl"
                style={{ border: `1px solid ${m.clr}33`, background: 'rgba(255,255,255,0.02)' }}>
                <div className="text-sm font-semibold mb-2" style={{ color: m.clr }}>{m.tier}</div>
                <div className="text-[11px] mb-3" style={{ color: 'rgba(255,255,255,0.4)' }}>{m.spend}</div>
                <div className="text-[11px]" style={{ color: 'rgba(255,255,255,0.5)' }}>ç”Ÿæ—¥ç¦®é‡‘</div>
                <div className="text-xl font-bold" style={{ color: m.clr }}>{m.gift}</div>
              </div>
            ))}
          </div>
          <a href="https://lin.ee/Ro3Fd4p" className="btn-line">ğŸ“± åŠ å…¥ LINE å®˜æ–¹å¸³è™Ÿ</a>
        </div>
      </section>

      {/* ä»˜æ¬¾æ–¹å¼ï¼ˆCMSï¼‰ */}
      <PaymentLogos data={sections.payment_logos} />
    </>
  );
}


=== app/(website)/layout.tsx ===
import WebsiteHeader from '@/components/website/Header';
import WebsiteFooter from '@/components/website/Footer';

export default function WebsiteLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <div className="min-h-screen flex flex-col bg-[#0a0a0a] text-gray-100">
      <WebsiteHeader />
      <main className="flex-grow">{children}</main>
      <WebsiteFooter />
    </div>
  );
}


=== components/cms/BrandStory.tsx ===
interface BrandStoryProps {
  data: {
    subtitle?: string
    title: string
    body: string
    image_url?: string
    badges?: { icon: string; label: string }[]
  } | null
}

export default function BrandStory({ data }: BrandStoryProps) {
  if (!data) return null

  return (
    <section className="max-w-7xl mx-auto px-5 py-20">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-12 items-center">
        <div>
          {data.subtitle && (
            <div className="text-[11px] tracking-[4px] mb-4" style={{ color: 'rgba(212,175,55,0.5)' }}>
              {data.subtitle}
            </div>
          )}
          <h2 className="text-2xl md:text-3xl font-light tracking-wider gold-text mb-6">
            {data.title}
          </h2>
          {data.body.split('\n\n').map((p, i) => (
            <p key={i} className="text-sm leading-loose mb-4" style={{ color: 'rgba(255,255,255,0.6)' }}>
              {p}
            </p>
          ))}
          {data.badges && data.badges.length > 0 && (
            <div className="flex gap-8 mt-6">
              {data.badges.map((badge) => (
                <div key={badge.label} className="text-center">
                  <div className="text-2xl mb-1">{badge.icon}</div>
                  <div className="text-[11px]" style={{ color: 'rgba(212,175,55,0.7)' }}>{badge.label}</div>
                </div>
              ))}
            </div>
          )}
        </div>
        <div className="h-80 md:h-96 rounded-2xl overflow-hidden"
          style={{ border: '1px solid rgba(212,175,55,0.15)' }}>
          {data.image_url && !data.image_url.includes('placeholder') ? (
            <img src={data.image_url} alt={data.title} className="w-full h-full object-cover" />
          ) : (
            <div className="w-full h-full flex items-center justify-center text-sm"
              style={{ background: 'linear-gradient(135deg, #1a1a1a, #111)', color: 'rgba(255,255,255,0.3)' }}>
              [ å½¢è±¡ç…§ç‰‡ ]
            </div>
          )}
        </div>
      </div>
    </section>
  )
}


=== components/cms/CampaignSection.tsx ===
interface Campaign {
  id: string
  title: string
  subtitle?: string
  badge_text?: string
  banner_image_url?: string
  plans: {
    name: string
    price: number
    original_price?: number
    description?: string
    badge?: string
    link_url?: string
  }[]
}

interface CampaignSectionProps {
  campaigns: Campaign[]
}

export default function CampaignSection({ campaigns }: CampaignSectionProps) {
  if (!campaigns || campaigns.length === 0) return null

  return (
    <>
      {campaigns.map((campaign) => (
        <section key={campaign.id} className="py-16" style={{
          background: 'linear-gradient(180deg, rgba(212,175,55,0.08) 0%, rgba(0,0,0,0) 100%)',
          borderTop: '1px solid rgba(212,175,55,0.15)',
        }}>
          <div className="max-w-7xl mx-auto px-5">
            {/* æ¨™é¡Œå€ */}
            <div className="text-center mb-10">
              {campaign.badge_text && (
                <span className="inline-block text-xs px-3 py-1 rounded-full mb-4"
                  style={{ background: 'rgba(212,175,55,0.2)', color: '#D4AF37', border: '1px solid rgba(212,175,55,0.3)' }}>
                  ğŸ”¥ {campaign.badge_text}
                </span>
              )}
              <h2 className="text-2xl md:text-3xl font-light tracking-wider gold-text mb-3">
                {campaign.title}
              </h2>
              {campaign.subtitle && (
                <p className="text-sm" style={{ color: 'rgba(255,255,255,0.5)' }}>
                  {campaign.subtitle}
                </p>
              )}
            </div>

            {/* æ–¹æ¡ˆå¡ç‰‡ */}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              {campaign.plans.map((plan, i) => (
                <a
                  key={i}
                  href={plan.link_url || '/products'}
                  className="group relative p-5 rounded-xl text-center transition-all duration-300 hover:-translate-y-1"
                  style={{
                    background: 'rgba(255,255,255,0.03)',
                    border: '1px solid rgba(212,175,55,0.2)',
                  }}
                >
                  {/* è§’æ¨™ */}
                  {plan.badge && (
                    <span className="absolute -top-2 -right-2 text-[10px] px-2 py-0.5 rounded-full text-black font-bold"
                      style={{ background: 'linear-gradient(135deg, #D4AF37, #F5E6A3)' }}>
                      {plan.badge}
                    </span>
                  )}

                  <div className="text-sm font-medium mb-2" style={{ color: 'rgba(255,255,255,0.8)' }}>
                    {plan.name}
                  </div>

                  {plan.original_price && (
                    <div className="text-xs line-through mb-1" style={{ color: 'rgba(255,255,255,0.3)' }}>
                      NT${plan.original_price.toLocaleString()}
                    </div>
                  )}

                  <div className="text-2xl md:text-3xl font-bold gold-text mb-2">
                    ${plan.price.toLocaleString()}
                  </div>

                  {plan.description && (
                    <div className="text-xs" style={{ color: 'rgba(255,255,255,0.4)' }}>
                      {plan.description}
                    </div>
                  )}

                  <div className="mt-3 text-xs px-3 py-1.5 rounded-full inline-block transition-colors"
                    style={{ border: '1px solid rgba(212,175,55,0.3)', color: '#D4AF37' }}>
                    ç«‹å³æ¶è³¼ â†’
                  </div>
                </a>
              ))}
            </div>
          </div>
        </section>
      ))}
    </>
  )
}


=== components/cms/HeroBanner.tsx ===
'use client'

import { useState, useEffect } from 'react'

interface Banner {
  id: string
  title: string
  subtitle: string
  image_url: string
  image_mobile_url?: string
  link_url?: string
  link_text?: string
}

interface HeroBannerProps {
  banners: Banner[]
}

export default function HeroBanner({ banners }: HeroBannerProps) {
  const [current, setCurrent] = useState(0)

  // è‡ªå‹•è¼ªæ’­ï¼ˆå¤šå¼µæ™‚ï¼‰
  useEffect(() => {
    if (banners.length <= 1) return
    const timer = setInterval(() => {
      setCurrent(prev => (prev + 1) % banners.length)
    }, 5000)
    return () => clearInterval(timer)
  }, [banners.length])

  // Fallbackï¼šæ²’æœ‰ CMS è³‡æ–™æ™‚é¡¯ç¤ºé è¨­
  if (!banners || banners.length === 0) {
    return (
      <section className="relative min-h-[85vh] flex items-center justify-center overflow-hidden">
        <div className="absolute inset-0"
          style={{ background: 'radial-gradient(ellipse at 30% 50%, rgba(212,175,55,0.08) 0%, transparent 60%)' }} />
        <div className="relative text-center px-5 max-w-2xl">
          <div className="text-[11px] tracking-[6px] mb-6" style={{ color: 'rgba(212,175,55,0.6)' }}>
            â”€â”€â”€ HEALTH & BEAUTY â”€â”€â”€
          </div>
          <h1 className="text-4xl md:text-5xl font-light leading-tight mb-2 tracking-wider gold-text">
            æ¯ä¸€ä»½ç´°è†©
          </h1>
          <h2 className="text-2xl md:text-3xl font-light leading-relaxed mb-4" style={{ color: 'rgba(255,255,255,0.9)' }}>
            éƒ½æºè‡ªå°å®¶äººå¥åº·çš„æ„›
          </h2>
          <p className="text-sm leading-loose mb-10 max-w-md mx-auto" style={{ color: 'rgba(255,255,255,0.5)' }}>
            æ—¥å¾©ä¸€æ—¥çš„ç”¨å¿ƒï¼Œåªç‚ºè®“å®¶äººçš„å¥åº·æ›´å®‰å¿ƒ<br/>åš´é¸å…¨çƒé ‚ç´šåŸæ–™ï¼Œæ‰“é€ å°ˆå±¬æ–¼ä½ çš„å¥åº·æ–¹æ¡ˆ
          </p>
          <div className="flex gap-4 justify-center flex-wrap">
            <a href="/products" className="btn-gold">æ¢ç´¢å•†å“</a>
            <a href="https://lin.ee/Ro3Fd4p" className="btn-gold-outline">åŠ å…¥ LINE</a>
          </div>
        </div>
      </section>
    )
  }

  const banner = banners[current]

  return (
    <section className="relative min-h-[85vh] flex items-center overflow-hidden">
      {/* èƒŒæ™¯åœ– */}
      <div className="absolute inset-0">
        <div
          className="absolute inset-0 bg-cover bg-center transition-opacity duration-700"
          style={{
            backgroundImage: `url(${banner.image_url})`,
            opacity: 0.6,
          }}
        />
        {/* æ¼¸å±¤é®ç½© */}
        <div className="absolute inset-0" style={{
          background: 'linear-gradient(90deg, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.4) 50%, rgba(0,0,0,0.2) 100%)',
        }} />
        <div className="absolute inset-0" style={{
          background: 'linear-gradient(180deg, transparent 60%, rgba(0,0,0,0.8) 100%)',
        }} />
      </div>

      {/* å…§å®¹ */}
      <div className="relative z-10 max-w-7xl mx-auto px-5 w-full">
        <div className="max-w-xl">
          <div className="text-[11px] tracking-[6px] mb-6" style={{ color: 'rgba(212,175,55,0.6)' }}>
            â”€â”€â”€ HEALTH & BEAUTY â”€â”€â”€
          </div>
          <h1 className="text-3xl md:text-5xl font-light leading-tight mb-4 tracking-wider gold-text">
            {banner.title}
          </h1>
          {banner.subtitle && (
            <p className="text-sm md:text-base leading-loose mb-8" style={{ color: 'rgba(255,255,255,0.7)' }}>
              {banner.subtitle}
            </p>
          )}
          <div className="flex gap-4 flex-wrap">
            {banner.link_url && (
              <a href={banner.link_url} className="btn-gold">
                {banner.link_text || 'æ¢ç´¢å•†å“'}
              </a>
            )}
            <a href="https://lin.ee/Ro3Fd4p" className="btn-gold-outline">åŠ å…¥ LINE</a>
          </div>
        </div>
      </div>

      {/* è¼ªæ’­æŒ‡ç¤ºå™¨ */}
      {banners.length > 1 && (
        <div className="absolute bottom-8 left-1/2 -translate-x-1/2 flex gap-2 z-10">
          {banners.map((_, i) => (
            <button
              key={i}
              onClick={() => setCurrent(i)}
              className="w-2 h-2 rounded-full transition-all"
              style={{
                background: i === current ? '#D4AF37' : 'rgba(255,255,255,0.3)',
                width: i === current ? '24px' : '8px',
              }}
            />
          ))}
        </div>
      )}
    </section>
  )
}


=== components/cms/PaymentLogos.tsx ===
interface PaymentLogosProps {
  data: {
    logos: { name: string; icon: string }[]
  } | null
}

const DEFAULT_LOGOS = [
  { name: 'ä¿¡ç”¨å¡', icon: 'ğŸ’³' },
  { name: 'LINE Pay', icon: 'ğŸ“±' },
  { name: 'ATM', icon: 'ğŸ§' },
  { name: 'è¶…å•†ä»˜æ¬¾', icon: 'ğŸª' },
]

export default function PaymentLogos({ data }: PaymentLogosProps) {
  const logos = data?.logos || DEFAULT_LOGOS

  return (
    <section style={{
      borderTop: '1px solid rgba(212,175,55,0.1)',
      background: 'rgba(0,0,0,0.3)',
    }}>
      <div className="max-w-7xl mx-auto px-5 py-6">
        <div className="flex flex-wrap items-center justify-center gap-6 md:gap-10">
          <span className="text-xs" style={{ color: 'rgba(255,255,255,0.3)' }}>ä»˜æ¬¾æ–¹å¼</span>
          {logos.map((logo) => (
            <div key={logo.name} className="flex items-center gap-1.5 px-3 py-1.5 rounded"
              style={{ border: '1px solid rgba(255,255,255,0.08)', background: 'rgba(255,255,255,0.03)' }}>
              <span className="text-sm">{logo.icon || 'ğŸ’³'}</span>
              <span className="text-xs" style={{ color: 'rgba(255,255,255,0.5)' }}>{logo.name}</span>
            </div>
          ))}
        </div>
      </div>
    </section>
  )
}


=== components/cms/TrustNumbers.tsx ===
interface TrustNumbersProps {
  data: {
    items: { number: string; label: string }[]
  } | null
}

// é è¨­æ•¸æ“š
const DEFAULT_ITEMS = [
  { number: '900+', label: 'å•†å“éŠ·å”®' },
  { number: '689è¬', label: 'ç¤¾ç¾¤è§¸åŠ' },
  { number: '19K+', label: 'æ»¿æ„å®¢æˆ¶' },
  { number: '95%', label: 'å¥½è©•ç‡' },
]

export default function TrustNumbers({ data }: TrustNumbersProps) {
  const items = data?.items || DEFAULT_ITEMS

  return (
    <section style={{
      borderTop: '1px solid rgba(212,175,55,0.15)',
      borderBottom: '1px solid rgba(212,175,55,0.15)',
      background: 'rgba(212,175,55,0.02)',
    }}>
      <div className="max-w-7xl mx-auto px-5 py-8 grid grid-cols-2 md:grid-cols-4 gap-5">
        {items.map((item) => (
          <div key={item.label} className="text-center">
            <div className="text-2xl md:text-3xl font-bold gold-text">{item.number}</div>
            <div className="text-xs mt-1" style={{ color: 'rgba(255,255,255,0.5)' }}>{item.label}</div>
          </div>
        ))}
      </div>
    </section>
  )
}


=== components/website/AnimatedSection.tsx ===
'use client';

import { useEffect, useRef, useState } from 'react';

interface AnimatedSectionProps {
  children: React.ReactNode;
  className?: string;
  delay?: number; // ms
}

export default function AnimatedSection({ children, className = '', delay = 0 }: AnimatedSectionProps) {
  const ref = useRef<HTMLDivElement>(null);
  const [hasHydrated, setHasHydrated] = useState(false);
  const [visible, setVisible] = useState(false);

  // ç¢ºä¿ SSR æ™‚å…§å®¹å¯è¦‹ï¼Œhydration å¾Œæ‰å•Ÿç”¨å‹•ç•«
  useEffect(() => {
    setHasHydrated(true);
  }, []);

  useEffect(() => {
    const el = ref.current;
    if (!el) return;

    const observer = new IntersectionObserver(
      ([entry]) => {
        if (entry.isIntersecting) {
          setTimeout(() => setVisible(true), delay);
          observer.unobserve(el);
        }
      },
      { threshold: 0.15 }
    );

    observer.observe(el);
    return () => observer.disconnect();
  }, [delay]);

  // SSR/æœª hydrate æ™‚é¡¯ç¤ºå…§å®¹ï¼Œhydrate å¾Œæ‰å•Ÿç”¨é€²å ´å‹•ç•«
  const showContent = !hasHydrated || visible;

  return (
    <div
      ref={ref}
      className={className}
      style={{
        opacity: showContent ? 1 : 0,
        transform: showContent ? 'translateY(0)' : 'translateY(30px)',
        transition: hasHydrated ? 'opacity 0.8s ease, transform 0.8s ease' : 'none',
      }}
    >
      {children}
    </div>
  );
}


=== components/website/CountUp.tsx ===
'use client';

import { useEffect, useRef, useState } from 'react';

interface CountUpProps {
  end: number;
  suffix?: string;
  duration?: number; // ms
}

export default function CountUp({ end, suffix = '', duration = 2000 }: CountUpProps) {
  const [count, setCount] = useState(0);
  const ref = useRef<HTMLSpanElement>(null);
  const started = useRef(false);

  useEffect(() => {
    const el = ref.current;
    if (!el) return;

    const observer = new IntersectionObserver(
      ([entry]) => {
        if (entry.isIntersecting && !started.current) {
          started.current = true;
          const startTime = Date.now();

          const tick = () => {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / duration, 1);
            // easeOutExpo
            const eased = progress === 1 ? 1 : 1 - Math.pow(2, -10 * progress);
            setCount(Math.floor(eased * end));

            if (progress < 1) requestAnimationFrame(tick);
          };

          requestAnimationFrame(tick);
          observer.unobserve(el);
        }
      },
      { threshold: 0.5 }
    );

    observer.observe(el);
    return () => observer.disconnect();
  }, [end, duration]);

  return (
    <span ref={ref}>
      {count.toLocaleString()}{suffix}
    </span>
  );
}


=== components/website/Footer.tsx ===
import { config } from '@/lib/config';

export default function WebsiteFooter() {
  return (
    <footer className="bg-black border-t border-gold/20 mt-16">
      <div className="container mx-auto px-4 py-12">
        <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
          {/* å“ç‰Œè³‡è¨Š */}
          <div>
            <h3 className="gold-text font-bold text-lg mb-4">{config.store.name}</h3>
            <p className="text-sm text-gray-400">{config.store.description}</p>
          </div>

          {/* è¯çµ¡æ–¹å¼ */}
          <div>
            <h3 className="text-gold font-bold text-lg mb-4">è¯çµ¡æˆ‘å€‘</h3>
            <ul className="space-y-2 text-sm">
              {config.contact.email && (
                <li>
                  <a
                    href={`mailto:${config.contact.email}`}
                    className="text-gray-400 hover:text-gold transition-colors"
                  >
                    {config.contact.email}
                  </a>
                </li>
              )}
              {config.contact.phone && (
                <li>
                  <a
                    href={`tel:${config.contact.phone}`}
                    className="text-gray-400 hover:text-gold transition-colors"
                  >
                    {config.contact.phone}
                  </a>
                </li>
              )}
              {config.contact.lineOA && (
                <li>
                  <a
                    href={config.contact.lineOA}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-gray-400 hover:text-line-green transition-colors"
                  >
                    LINE å®˜æ–¹å¸³è™Ÿ
                  </a>
                </li>
              )}
            </ul>
          </div>

          {/* ç¤¾ç¾¤é€£çµ */}
          <div>
            <h3 className="text-gold font-bold text-lg mb-4">è¿½è¹¤æˆ‘å€‘</h3>
            <div className="flex space-x-4">
              {config.contact.lineOA && (
                <a
                  href={config.contact.lineOA}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-gray-400 hover:text-line-green transition-colors"
                  aria-label="LINE"
                >
                  <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346 0 .627.285.627.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314" />
                  </svg>
                </a>
              )}
              {config.contact.facebook && (
                <a
                  href={config.contact.facebook}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-gray-400 hover:text-gold transition-colors"
                  aria-label="Facebook"
                >
                  <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z" />
                  </svg>
                </a>
              )}
              {config.contact.instagram && (
                <a
                  href={config.contact.instagram}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-gray-400 hover:text-gold transition-colors"
                  aria-label="Instagram"
                >
                  <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z" />
                  </svg>
                </a>
              )}
            </div>
          </div>
        </div>

        {/* ç‰ˆæ¬Š */}
        <div className="border-t border-gold/20 mt-8 pt-8 text-center text-sm text-gray-500">
          <p>&copy; 2026 MINJIE STUDIO. All rights reserved.</p>
        </div>
      </div>
    </footer>
  );
}


=== components/website/Header.tsx ===
'use client';

import Link from 'next/link';
import Image from 'next/image';
import { useState } from 'react';
import { config } from '@/lib/config';
import { useCart } from '@/components/CartProvider';
import CartDrawer from '@/components/CartDrawer';
import LineLoginButton from '@/components/LineLoginButton';

export default function WebsiteHeader() {
  const { itemCount } = useCart();
  const [isCartOpen, setIsCartOpen] = useState(false);

  return (
    <>
      <header className="sticky top-0 z-40 bg-black/80 backdrop-blur-md border-b border-gold/20">
        <div className="container mx-auto px-4">
          <div className="flex items-center justify-between h-16">
            {/* Logo */}
            <Link href="/" className="flex items-center space-x-2">
              {config.store.logo ? (
                <Image
                  src={config.store.logo}
                  alt={config.store.name}
                  width={120}
                  height={40}
                  className="h-8 w-auto"
                />
              ) : (
                <span className="text-xl font-bold gold-text">{config.store.name}</span>
              )}
            </Link>

            {/* å°èˆª */}
            <nav className="hidden md:flex items-center space-x-8">
              <Link
                href="/"
                className="text-gray-300 hover:text-gold transition-colors"
              >
                é¦–é 
              </Link>
              <Link
                href="/products"
                className="text-gray-300 hover:text-gold transition-colors"
              >
                å…¨éƒ¨å•†å“
              </Link>
              {config.contact.lineOA && (
                <a
                  href={config.contact.lineOA}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-gray-300 hover:text-line-green transition-colors"
                >
                  LINE å®¢æœ
                </a>
              )}
            </nav>

            {/* å³å´ï¼šLINE ç™»å…¥ + è³¼ç‰©è»Š */}
            <div className="flex items-center gap-4">
              {/* LINE ç™»å…¥ */}
              <LineLoginButton />

            {/* è³¼ç‰©è»ŠæŒ‰éˆ• */}
            {config.features.cart && (
              <button
                onClick={() => setIsCartOpen(true)}
                className="relative p-2 border border-gold/30 rounded-full hover:border-gold/60 hover:bg-gold/10 transition-all"
                aria-label="è³¼ç‰©è»Š"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  strokeWidth={1.5}
                  stroke="currentColor"
                  className="w-6 h-6 text-gold"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 00-16.536-1.84M7.5 14.25L5.106 5.272M6 20.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm12.75 0a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"
                  />
                </svg>
                {itemCount > 0 && (
                  <span className="absolute -top-1 -right-1 bg-gold text-black text-xs w-5 h-5 rounded-full flex items-center justify-center font-bold">
                    {itemCount > 99 ? '99+' : itemCount}
                  </span>
                )}
              </button>
            )}
            </div>
          </div>
        </div>
      </header>

      {/* è³¼ç‰©è»Šå´é‚Šæ¬„ */}
      <CartDrawer isOpen={isCartOpen} onClose={() => setIsCartOpen(false)} />
    </>
  );
}


=== components/website/ImageGallery.tsx ===
'use client';

import { useState } from 'react';
import Image from 'next/image';

interface ImageGalleryProps {
  images: Array<{ id: string; url: string }>;
  title: string;
}

export default function ImageGallery({ images, title }: ImageGalleryProps) {
  const [selectedIndex, setSelectedIndex] = useState(0);

  if (!images || images.length === 0) {
    return (
      <div className="aspect-square rounded-2xl flex items-center justify-center"
        style={{ background: '#111', border: '1px solid rgba(212,175,55,0.1)' }}>
        <div className="text-center" style={{ color: 'rgba(255,255,255,0.2)' }}>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
            strokeWidth={1} stroke="currentColor" className="w-16 h-16 mx-auto mb-2">
            <path strokeLinecap="round" strokeLinejoin="round"
              d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
          </svg>
          <span className="text-sm">ç„¡åœ–ç‰‡</span>
        </div>
      </div>
    );
  }

  return (
    <div>
      {/* ä¸»åœ– */}
      <div className="aspect-square relative rounded-2xl overflow-hidden mb-4"
        style={{ background: '#111', border: '1px solid rgba(212,175,55,0.1)' }}>
        <Image
          src={images[selectedIndex].url}
          alt={`${title} - ${selectedIndex + 1}`}
          fill
          sizes="(max-width: 768px) 100vw, 50vw"
          className="object-cover"
          priority={selectedIndex === 0}
        />
      </div>

      {/* ç¸®åœ–åˆ—è¡¨ */}
      {images.length > 1 && (
        <div className="flex gap-2 overflow-x-auto pb-2">
          {images.map((img, i) => (
            <button
              key={img.id}
              onClick={() => setSelectedIndex(i)}
              className="flex-shrink-0 w-16 h-16 md:w-20 md:h-20 rounded-lg overflow-hidden relative transition-all duration-200"
              style={{
                border: `2px solid ${i === selectedIndex ? 'rgba(212,175,55,0.6)' : 'rgba(212,175,55,0.15)'}`,
                opacity: i === selectedIndex ? 1 : 0.6,
              }}
            >
              <Image
                src={img.url}
                alt={`${title} ç¸®åœ– ${i + 1}`}
                fill
                sizes="80px"
                className="object-cover"
              />
            </button>
          ))}
        </div>
      )}
    </div>
  );
}


=== components/website/ProductFilter.tsx ===
'use client';

import { useRouter, useSearchParams } from 'next/navigation';

interface Collection {
  id: string;
  title: string;
  handle: string;
}

interface ProductFilterProps {
  collections: Collection[];
}

export default function ProductFilter({ collections }: ProductFilterProps) {
  const router = useRouter();
  const searchParams = useSearchParams();
  const currentCollection = searchParams.get('collection') || '';
  const currentSort = searchParams.get('sort') || '';

  const handleCollectionChange = (handle: string) => {
    const params = new URLSearchParams(searchParams.toString());
    if (handle) {
      params.set('collection', handle);
    } else {
      params.delete('collection');
    }
    router.push(`/products?${params.toString()}`);
  };

  const handleSortChange = (sort: string) => {
    const params = new URLSearchParams(searchParams.toString());
    if (sort) {
      params.set('sort', sort);
    } else {
      params.delete('sort');
    }
    router.push(`/products?${params.toString()}`);
  };

  // æ’é™¤ã€Œå…¨ç³»åˆ—å•†å“ã€
  const displayCollections = collections.filter(c => c.handle !== 'all-product');

  return (
    <div className="mb-10">
      {/* åˆ†é¡æ¨™ç±¤ */}
      <div className="flex flex-wrap gap-2 mb-6 justify-center">
        <button
          onClick={() => handleCollectionChange('')}
          className="px-5 py-2 rounded-full text-sm transition-all duration-300"
          style={{
            background: !currentCollection ? '#D4AF37' : 'transparent',
            color: !currentCollection ? '#000' : 'rgba(255,255,255,0.6)',
            border: `1px solid ${!currentCollection ? '#D4AF37' : 'rgba(212,175,55,0.2)'}`,
            fontWeight: !currentCollection ? 600 : 400,
          }}
        >
          å…¨éƒ¨å•†å“
        </button>
        {displayCollections.map((col) => (
          <button
            key={col.id}
            onClick={() => handleCollectionChange(col.handle)}
            className="px-5 py-2 rounded-full text-sm transition-all duration-300"
            style={{
              background: currentCollection === col.handle ? '#D4AF37' : 'transparent',
              color: currentCollection === col.handle ? '#000' : 'rgba(255,255,255,0.6)',
              border: `1px solid ${currentCollection === col.handle ? '#D4AF37' : 'rgba(212,175,55,0.2)'}`,
              fontWeight: currentCollection === col.handle ? 600 : 400,
            }}
          >
            {col.title}
          </button>
        ))}
      </div>

      {/* æ’åº */}
      <div className="flex justify-end">
        <select
          value={currentSort}
          onChange={(e) => handleSortChange(e.target.value)}
          className="text-sm px-4 py-2 rounded-lg appearance-none cursor-pointer"
          style={{
            background: '#111',
            color: 'rgba(255,255,255,0.7)',
            border: '1px solid rgba(212,175,55,0.2)',
            outline: 'none',
          }}
        >
          <option value="">é è¨­æ’åº</option>
          <option value="price_asc">åƒ¹æ ¼ï¼šä½ â†’ é«˜</option>
          <option value="price_desc">åƒ¹æ ¼ï¼šé«˜ â†’ ä½</option>
          <option value="newest">æœ€æ–°ä¸Šæ¶</option>
        </select>
      </div>
    </div>
  );
}


=== components/website/QuantitySelector.tsx ===
'use client';

interface QuantitySelectorProps {
  quantity: number;
  onChange: (qty: number) => void;
  min?: number;
  max?: number;
}

export default function QuantitySelector({ quantity, onChange, min = 1, max = 99 }: QuantitySelectorProps) {
  return (
    <div className="flex items-center gap-1">
      <button
        onClick={() => onChange(Math.max(min, quantity - 1))}
        disabled={quantity <= min}
        className="w-10 h-10 rounded-lg flex items-center justify-center text-lg transition-all duration-200"
        style={{
          border: '1px solid rgba(212,175,55,0.3)',
          color: quantity <= min ? 'rgba(255,255,255,0.2)' : 'rgba(255,255,255,0.8)',
          cursor: quantity <= min ? 'not-allowed' : 'pointer',
        }}
      >
        âˆ’
      </button>
      <span className="w-12 text-center text-base font-medium"
        style={{ color: 'rgba(255,255,255,0.9)' }}>
        {quantity}
      </span>
      <button
        onClick={() => onChange(Math.min(max, quantity + 1))}
        disabled={quantity >= max}
        className="w-10 h-10 rounded-lg flex items-center justify-center text-lg transition-all duration-200"
        style={{
          border: '1px solid rgba(212,175,55,0.3)',
          color: quantity >= max ? 'rgba(255,255,255,0.2)' : 'rgba(255,255,255,0.8)',
          cursor: quantity >= max ? 'not-allowed' : 'pointer',
        }}
      >
        +
      </button>
    </div>
  );
}


=== components/website/VariantSelector.tsx ===
'use client';

interface Option {
  id: string;
  title: string;
  values: Array<{ id: string; value: string }>;
}

interface VariantSelectorProps {
  options: Option[];
  selectedOptions: Record<string, string>;
  onSelect: (optionId: string, value: string) => void;
}

export default function VariantSelector({ options, selectedOptions, onSelect }: VariantSelectorProps) {
  if (!options || options.length === 0) return null;

  return (
    <div className="space-y-5">
      {options.map((option) => (
        <div key={option.id}>
          <label className="block text-sm mb-3" style={{ color: 'rgba(255,255,255,0.7)' }}>
            {option.title}
          </label>
          <div className="flex flex-wrap gap-2">
            {option.values.map((val) => {
              const isSelected = selectedOptions[option.id] === val.value;
              return (
                <button
                  key={val.id}
                  onClick={() => onSelect(option.id, val.value)}
                  className="px-5 py-2.5 rounded-lg text-sm transition-all duration-200"
                  style={{
                    background: isSelected ? '#D4AF37' : 'transparent',
                    color: isSelected ? '#000' : 'rgba(255,255,255,0.8)',
                    border: `1px solid ${isSelected ? '#D4AF37' : 'rgba(212,175,55,0.2)'}`,
                    fontWeight: isSelected ? 600 : 400,
                  }}
                >
                  {val.value}
                </button>
              );
            })}
          </div>
        </div>
      ))}
    </div>
  );
}


=== components/CartProvider.tsx ===
'use client';

import {
  createContext,
  useContext,
  useState,
  useEffect,
  useCallback,
  ReactNode,
} from 'react';
import {
  Cart,
  createCart,
  getCart,
  addToCart as addToCartApi,
  updateCartItem as updateCartItemApi,
  removeCartItem as removeCartItemApi,
} from '@/lib/medusa';

const CART_ID_KEY = 'medusa_cart_id';

interface CartContextType {
  cart: Cart | null;
  isLoading: boolean;
  error: string | null;
  itemCount: number;
  addItem: (variantId: string, quantity?: number) => Promise<void>;
  updateItem: (itemId: string, quantity: number) => Promise<void>;
  removeItem: (itemId: string) => Promise<void>;
  refreshCart: () => Promise<void>;
}

const CartContext = createContext<CartContextType | undefined>(undefined);

export function useCart() {
  const context = useContext(CartContext);
  if (!context) {
    throw new Error('useCart must be used within a CartProvider');
  }
  return context;
}

export default function CartProvider({ children }: { children: ReactNode }) {
  const [cart, setCart] = useState<Cart | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // è¨ˆç®—è³¼ç‰©è»Šå•†å“æ•¸é‡
  const itemCount = cart?.items?.reduce((sum, item) => sum + item.quantity, 0) || 0;

  // åˆå§‹åŒ–è³¼ç‰©è»Š
  const initCart = useCallback(async () => {
    try {
      setIsLoading(true);
      setError(null);

      // å˜—è©¦å¾ localStorage å–å¾— cart_id
      const savedCartId = localStorage.getItem(CART_ID_KEY);

      if (savedCartId) {
        try {
          const { cart: existingCart } = await getCart(savedCartId);
          setCart(existingCart);
          return;
        } catch {
          // Cart ä¸å­˜åœ¨æˆ–éæœŸï¼Œå»ºç«‹æ–°çš„
          localStorage.removeItem(CART_ID_KEY);
        }
      }

      // å»ºç«‹æ–°è³¼ç‰©è»Š
      const { cart: newCart } = await createCart();
      localStorage.setItem(CART_ID_KEY, newCart.id);
      setCart(newCart);
    } catch (err) {
      console.error('Failed to initialize cart:', err);
      setError('ç„¡æ³•è¼‰å…¥è³¼ç‰©è»Š');
    } finally {
      setIsLoading(false);
    }
  }, []);

  // åˆå§‹åŒ–
  useEffect(() => {
    initCart();
  }, [initCart]);

  // é‡æ–°è¼‰å…¥è³¼ç‰©è»Š
  const refreshCart = useCallback(async () => {
    if (!cart?.id) return;
    
    try {
      const { cart: updatedCart } = await getCart(cart.id);
      setCart(updatedCart);
    } catch (err) {
      console.error('Failed to refresh cart:', err);
    }
  }, [cart?.id]);

  // åŠ å…¥å•†å“
  const addItem = useCallback(
    async (variantId: string, quantity: number = 1) => {
      if (!cart?.id) {
        setError('è³¼ç‰©è»Šæœªåˆå§‹åŒ–');
        return;
      }

      try {
        setIsLoading(true);
        setError(null);
        const { cart: updatedCart } = await addToCartApi(cart.id, variantId, quantity);
        setCart(updatedCart);
      } catch (err) {
        console.error('Failed to add item:', err);
        setError('åŠ å…¥è³¼ç‰©è»Šå¤±æ•—');
        throw err;
      } finally {
        setIsLoading(false);
      }
    },
    [cart?.id]
  );

  // æ›´æ–°æ•¸é‡
  const updateItem = useCallback(
    async (itemId: string, quantity: number) => {
      if (!cart?.id) return;

      try {
        setIsLoading(true);
        setError(null);

        if (quantity <= 0) {
          // æ•¸é‡ç‚º 0 å‰‡ç§»é™¤
          const { cart: updatedCart } = await removeCartItemApi(cart.id, itemId);
          setCart(updatedCart);
        } else {
          const { cart: updatedCart } = await updateCartItemApi(cart.id, itemId, quantity);
          setCart(updatedCart);
        }
      } catch (err) {
        console.error('Failed to update item:', err);
        setError('æ›´æ–°å¤±æ•—');
        throw err;
      } finally {
        setIsLoading(false);
      }
    },
    [cart?.id]
  );

  // ç§»é™¤å•†å“
  const removeItem = useCallback(
    async (itemId: string) => {
      if (!cart?.id) return;

      try {
        setIsLoading(true);
        setError(null);
        const { cart: updatedCart } = await removeCartItemApi(cart.id, itemId);
        setCart(updatedCart);
      } catch (err) {
        console.error('Failed to remove item:', err);
        setError('ç§»é™¤å¤±æ•—');
        throw err;
      } finally {
        setIsLoading(false);
      }
    },
    [cart?.id]
  );

  return (
    <CartContext.Provider
      value={{
        cart,
        isLoading,
        error,
        itemCount,
        addItem,
        updateItem,
        removeItem,
        refreshCart,
      }}
    >
      {children}
    </CartContext.Provider>
  );
}


=== components/CartDrawer.tsx ===
'use client';

import { useCart } from './CartProvider';
import { formatPrice, config } from '@/lib/config';
import Image from 'next/image';
import Link from 'next/link';

interface CartDrawerProps {
  isOpen: boolean;
  onClose: () => void;
}

// æ»¿é¡æŠ˜æ‰£è¨­å®š
const AUTO_DISCOUNT_THRESHOLD = 2000;
const AUTO_DISCOUNT_AMOUNT = 200;

export default function CartDrawer({ isOpen, onClose }: CartDrawerProps) {
  const { cart, isLoading, updateItem, removeItem } = useCart();

  if (!isOpen) return null;

  const subtotal = cart?.subtotal || 0;
  const isFreeShipping = subtotal >= config.shipping.freeShippingThreshold;
  const amountToFreeShipping = config.shipping.freeShippingThreshold - subtotal;

  // æ»¿é¡æŠ˜æ‰£
  const hasAutoDiscount = subtotal >= AUTO_DISCOUNT_THRESHOLD;
  const amountToAutoDiscount = AUTO_DISCOUNT_THRESHOLD - subtotal;

  return (
    <>
      {/* Backdrop */}
      <div
        className="fixed inset-0 z-[60] animate-fade-in"
        style={{ background: 'rgba(0,0,0,0.7)' }}
        onClick={onClose}
      />

      {/* Drawer */}
      <div
        className="fixed right-0 top-0 h-full w-full max-w-md z-[60] shadow-xl animate-slide-in-right flex flex-col"
        style={{ background: '#0a0a0a' }}
      >
        {/* Header */}
        <div
          className="flex items-center justify-between p-4"
          style={{ borderBottom: '1px solid rgba(212,175,55,0.2)' }}
        >
          <h2 className="text-lg font-bold gold-text">è³¼ç‰©è»Š</h2>
          <button
            onClick={onClose}
            className="p-2 rounded-full transition-colors"
            style={{ color: 'rgba(255,255,255,0.6)' }}
            aria-label="é—œé–‰"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              strokeWidth={1.5}
              stroke="currentColor"
              className="w-6 h-6 hover:text-gold"
            >
              <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        {/* å…é‹æç¤º */}
        {!isFreeShipping && amountToFreeShipping > 0 && (
          <div
            className="px-4 py-3 text-sm"
            style={{ background: 'rgba(212,175,55,0.08)', borderBottom: '1px solid rgba(212,175,55,0.1)' }}
          >
            <p style={{ color: 'rgba(255,255,255,0.7)' }}>
              å†è²· <span className="font-bold text-gold">{formatPrice(amountToFreeShipping)}</span> å³å¯å…é‹ï¼
            </p>
            <div
              className="mt-2 h-2 rounded-full overflow-hidden"
              style={{ background: 'rgba(255,255,255,0.1)' }}
            >
              <div
                className="h-full transition-all duration-300"
                style={{
                  background: 'linear-gradient(90deg, #D4AF37, #FFD700)',
                  width: `${Math.min((subtotal / config.shipping.freeShippingThreshold) * 100, 100)}%`,
                }}
              />
            </div>
          </div>
        )}

        {isFreeShipping && (
          <div
            className="px-4 py-3 text-sm"
            style={{ background: 'rgba(212,175,55,0.15)', color: '#D4AF37' }}
          >
            ğŸ‰ å·²é”å…é‹é–€æª»ï¼
          </div>
        )}

        {/* Cart Items */}
        <div className="flex-grow overflow-y-auto p-4">
          {isLoading && !cart ? (
            <div className="flex items-center justify-center h-32">
              <div
                className="animate-spin rounded-full h-8 w-8 border-b-2"
                style={{ borderColor: '#D4AF37' }}
              />
            </div>
          ) : !cart?.items?.length ? (
            <div className="text-center py-12">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                strokeWidth={1.5}
                stroke="currentColor"
                className="w-16 h-16 mx-auto mb-4"
                style={{ color: 'rgba(255,255,255,0.2)' }}
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 00-16.536-1.84M7.5 14.25L5.106 5.272M6 20.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm12.75 0a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"
                />
              </svg>
              <p style={{ color: 'rgba(255,255,255,0.5)' }}>è³¼ç‰©è»Šæ˜¯ç©ºçš„</p>
              <button onClick={onClose} className="btn-gold mt-4 px-6 py-2">
                ç¹¼çºŒè³¼ç‰©
              </button>
            </div>
          ) : (
            <ul className="space-y-4">
              {cart.items.map((item) => (
                <li
                  key={item.id}
                  className="flex gap-4 pb-4"
                  style={{ borderBottom: '1px solid rgba(212,175,55,0.1)' }}
                >
                  {/* å•†å“åœ–ç‰‡ */}
                  <div
                    className="w-20 h-20 rounded overflow-hidden flex-shrink-0"
                    style={{ background: '#111', border: '1px solid rgba(212,175,55,0.2)' }}
                  >
                    {item.thumbnail ? (
                      <Image
                        src={item.thumbnail}
                        alt={item.title}
                        width={80}
                        height={80}
                        className="w-full h-full object-cover"
                      />
                    ) : (
                      <div
                        className="w-full h-full flex items-center justify-center"
                        style={{ color: 'rgba(255,255,255,0.2)' }}
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          fill="none"
                          viewBox="0 0 24 24"
                          strokeWidth={1.5}
                          stroke="currentColor"
                          className="w-8 h-8"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"
                          />
                        </svg>
                      </div>
                    )}
                  </div>

                  {/* å•†å“è³‡è¨Š */}
                  <div className="flex-grow min-w-0">
                    <h4
                      className="font-medium text-sm truncate"
                      style={{ color: 'rgba(255,255,255,0.9)' }}
                    >
                      {item.title}
                    </h4>
                    {item.variant?.title && item.variant.title !== item.title && (
                      <p className="text-xs" style={{ color: 'rgba(255,255,255,0.4)' }}>
                        {item.variant.title}
                      </p>
                    )}
                    <p className="text-sm font-bold mt-1 text-gold">
                      {formatPrice(item.unit_price)}
                    </p>

                    {/* æ•¸é‡æ§åˆ¶ */}
                    <div className="flex items-center gap-2 mt-2">
                      <button
                        onClick={() => updateItem(item.id, item.quantity - 1)}
                        className="w-7 h-7 flex items-center justify-center rounded transition-colors"
                        style={{
                          border: '1px solid rgba(212,175,55,0.3)',
                          color: 'rgba(255,255,255,0.8)',
                        }}
                        disabled={isLoading}
                      >
                        -
                      </button>
                      <span
                        className="w-8 text-center text-sm"
                        style={{ color: 'rgba(255,255,255,0.9)' }}
                      >
                        {item.quantity}
                      </span>
                      <button
                        onClick={() => updateItem(item.id, item.quantity + 1)}
                        className="w-7 h-7 flex items-center justify-center rounded transition-colors"
                        style={{
                          border: '1px solid rgba(212,175,55,0.3)',
                          color: 'rgba(255,255,255,0.8)',
                        }}
                        disabled={isLoading}
                      >
                        +
                      </button>
                      <button
                        onClick={() => removeItem(item.id)}
                        className="ml-auto hover:text-red-400 transition-colors"
                        style={{ color: 'rgba(255,255,255,0.4)' }}
                        aria-label="ç§»é™¤"
                        disabled={isLoading}
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          fill="none"
                          viewBox="0 0 24 24"
                          strokeWidth={1.5}
                          stroke="currentColor"
                          className="w-5 h-5"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"
                          />
                        </svg>
                      </button>
                    </div>
                  </div>
                </li>
              ))}
            </ul>
          )}
        </div>

        {/* Footer */}
        {cart?.items?.length ? (
          <div
            className="p-4 space-y-4"
            style={{ borderTop: '1px solid rgba(212,175,55,0.2)' }}
          >
            {/* å°è¨ˆ */}
            <div className="flex justify-between text-lg font-bold">
              <span style={{ color: 'rgba(255,255,255,0.7)' }}>å°è¨ˆ</span>
              <span className="gold-text">{formatPrice(subtotal)}</span>
            </div>

            {/* æ»¿é¡æŠ˜æ‰£æç¤º */}
            {hasAutoDiscount ? (
              <div
                className="text-sm py-2 px-3 rounded-lg"
                style={{ background: 'rgba(212,175,55,0.12)', color: '#D4AF37' }}
              >
                ğŸ‰ æ»¿é¡æŠ˜ -{formatPrice(AUTO_DISCOUNT_AMOUNT)}
              </div>
            ) : amountToAutoDiscount > 0 && (
              <div
                className="text-sm py-2 px-3 rounded-lg"
                style={{ background: 'rgba(255,255,255,0.05)', color: 'rgba(255,255,255,0.6)' }}
              >
                å†è²· <span className="font-bold" style={{ color: '#D4AF37' }}>{formatPrice(amountToAutoDiscount)}</span> äº«æ»¿é¡æŠ˜ {formatPrice(AUTO_DISCOUNT_AMOUNT)}
              </div>
            )}

            {/* çµå¸³æŒ‰éˆ• */}
            {config.features.checkout ? (
              <Link
                href="/checkout"
                onClick={onClose}
                className="btn-gold w-full text-center block py-3"
              >
                å‰å¾€çµå¸³
              </Link>
            ) : (
              <button
                disabled
                className="w-full py-3 rounded opacity-50 cursor-not-allowed"
                style={{ background: 'rgba(255,255,255,0.1)', color: 'rgba(255,255,255,0.5)' }}
              >
                çµå¸³åŠŸèƒ½é–‹ç™¼ä¸­
              </button>
            )}

            <button
              onClick={onClose}
              className="btn-gold-outline w-full py-3"
            >
              ç¹¼çºŒè³¼ç‰©
            </button>
          </div>
        ) : null}
      </div>
    </>
  );
}


=== app/(website)/products/page.tsx ===
import { Suspense } from 'react';
import { getProducts, getCollections } from '@/lib/medusa';
import SectionTitle from '@/components/ui/SectionTitle';
import ProductCard from '@/components/ProductCard';
import ProductFilter from '@/components/website/ProductFilter';
import AnimatedSection from '@/components/website/AnimatedSection';

export const revalidate = 3600;

export const metadata = {
  title: 'å…¨éƒ¨å•†å“',
  description: 'MINJIE STUDIO å…¨ç³»åˆ—å¥åº·é£Ÿå“ï¼Œç›Šç”ŸèŒã€è† åŸè›‹ç™½ã€é…µç´ ã€è‘‰é»ƒç´ ç­‰åš´é¸å•†å“ã€‚',
};

// æ ¹æ“šåƒ¹æ ¼å–å¾—æœ€ä½åƒ¹
function getLowestPrice(product: any): number {
  const prices = product.variants
    ?.map((v: any) => v.calculated_price?.calculated_amount)
    .filter((p: any) => p != null) || [];
  return prices.length > 0 ? Math.min(...prices) : 0;
}

// æ’åºå•†å“
function sortProducts(products: any[], sort: string) {
  switch (sort) {
    case 'price_asc':
      return [...products].sort((a, b) => getLowestPrice(a) - getLowestPrice(b));
    case 'price_desc':
      return [...products].sort((a, b) => getLowestPrice(b) - getLowestPrice(a));
    case 'newest':
      return [...products].sort((a, b) =>
        new Date(b.created_at).getTime() - new Date(a.created_at).getTime()
      );
    default:
      return products;
  }
}

export default async function ProductsPage({
  searchParams,
}: {
  searchParams: { collection?: string; sort?: string };
}) {
  const [{ products }, { collections }] = await Promise.all([
    getProducts({ limit: 100 }),
    getCollections(),
  ]);

  // ç¯©é¸ï¼šæ ¹æ“š collection handle ç¯©é¸
  let filtered = products;
  if (searchParams.collection) {
    const targetCollection = collections.find(
      (c: any) => c.handle === searchParams.collection
    );
    if (targetCollection) {
      filtered = products.filter(
        (p: any) => p.collection_id === targetCollection.id
      );
    }
  }

  // æ’åº
  const sorted = sortProducts(filtered, searchParams.sort || '');

  // ç›®å‰åˆ†é¡åç¨±
  const currentCollectionTitle = searchParams.collection
    ? collections.find((c: any) => c.handle === searchParams.collection)?.title
    : null;

  return (
    <section className="max-w-7xl mx-auto px-5 py-16">
      <AnimatedSection>
        <SectionTitle
          subtitle={currentCollectionTitle ? currentCollectionTitle.toUpperCase() : 'ALL PRODUCTS'}
          title={currentCollectionTitle || 'å…¨éƒ¨å•†å“'}
        />
      </AnimatedSection>

      <Suspense fallback={null}>
        <ProductFilter collections={collections} />
      </Suspense>

      {/* å•†å“æ•¸é‡ */}
      <div className="text-right mb-4">
        <span className="text-xs" style={{ color: 'rgba(255,255,255,0.35)' }}>
          å…± {sorted.length} å€‹å•†å“
        </span>
      </div>

      {sorted.length === 0 ? (
        <div className="text-center py-20">
          <div className="text-4xl mb-4 opacity-30">ğŸ”</div>
          <p style={{ color: 'rgba(255,255,255,0.5)' }}>
            æ­¤åˆ†é¡ç›®å‰æ²’æœ‰å•†å“
          </p>
        </div>
      ) : (
        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6">
          {sorted.map((product: any, i: number) => (
            <AnimatedSection key={product.id} delay={i * 60}>
              <ProductCard product={product} />
            </AnimatedSection>
          ))}
        </div>
      )}
    </section>
  );
}


=== app/(website)/products/[handle]/page.tsx ===
import { getProducts } from '@/lib/medusa';
import ProductDetailClient from './ProductDetailClient';
import type { Metadata } from 'next';

export const revalidate = 3600;

const baseUrl = 'https://shop.minjie0326.com';

// é ç”Ÿæˆæ‰€æœ‰å•†å“é 
export async function generateStaticParams() {
  const { products } = await getProducts({ limit: 100 });
  return products.map((p: any) => ({ handle: p.handle }));
}

// å‹•æ…‹ meta
export async function generateMetadata({
  params,
}: {
  params: { handle: string };
}): Promise<Metadata> {
  const { products } = await getProducts({ limit: 100 });
  const product = products.find((p: any) => p.handle === params.handle);

  if (!product) {
    return { title: 'å•†å“ä¸å­˜åœ¨' };
  }

  const description = product.subtitle || product.description?.replace(/<[^>]*>/g, '').slice(0, 160) || '';

  return {
    title: product.title,
    description,
    openGraph: {
      title: `${product.title} | MINJIE STUDIO`,
      description,
      url: `${baseUrl}/products/${product.handle}`,
      images: product.thumbnail ? [{
        url: product.thumbnail,
        width: 800,
        height: 800,
        alt: product.title,
      }] : [],
      type: 'website',
    },
    twitter: {
      card: 'summary_large_image',
      title: product.title,
      description,
      images: product.thumbnail ? [product.thumbnail] : [],
    },
  };
}

// JSON-LD çµæ§‹åŒ–è³‡æ–™
function generateProductJsonLd(product: any) {
  const price = product.variants?.[0]?.calculated_price?.calculated_amount;
  const inStock = product.variants?.some((v: any) =>
    v.inventory_quantity === undefined || v.inventory_quantity > 0
  );

  return {
    '@context': 'https://schema.org',
    '@type': 'Product',
    name: product.title,
    description: product.description?.replace(/<[^>]*>/g, '') || product.subtitle || '',
    image: product.thumbnail || product.images?.[0]?.url,
    url: `${baseUrl}/products/${product.handle}`,
    brand: {
      '@type': 'Brand',
      name: 'MINJIE STUDIO',
    },
    offers: {
      '@type': 'Offer',
      price: price ? price / 100 : 0,
      priceCurrency: 'TWD',
      availability: inStock
        ? 'https://schema.org/InStock'
        : 'https://schema.org/OutOfStock',
      url: `${baseUrl}/products/${product.handle}`,
      seller: {
        '@type': 'Organization',
        name: 'MINJIE STUDIO',
      },
    },
  };
}

export default async function ProductPage({
  params,
}: {
  params: { handle: string };
}) {
  const { products } = await getProducts({ limit: 100 });
  const product = products.find((p: any) => p.handle === params.handle);

  if (!product) {
    return (
      <div className="min-h-[60vh] flex items-center justify-center">
        <div className="text-center">
          <div className="text-5xl mb-4 opacity-30">ğŸ˜•</div>
          <h1 className="text-xl mb-2" style={{ color: 'rgba(255,255,255,0.7)' }}>
            æ‰¾ä¸åˆ°æ­¤å•†å“
          </h1>
          <a href="/products" className="btn-gold-outline text-sm mt-4 inline-block">
            â† å›å•†å“åˆ—è¡¨
          </a>
        </div>
      </div>
    );
  }

  const jsonLd = generateProductJsonLd(product);

  return (
    <>
      <script
        type="application/ld+json"
        dangerouslySetInnerHTML={{ __html: JSON.stringify(jsonLd) }}
      />
      <ProductDetailClient product={product} />
    </>
  );
}


=== app/(website)/products/[handle]/ProductDetailClient.tsx ===
'use client';

import { useState, useMemo } from 'react';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import ImageGallery from '@/components/website/ImageGallery';
import VariantSelector from '@/components/website/VariantSelector';
import QuantitySelector from '@/components/website/QuantitySelector';
import { useCart } from '@/components/CartProvider';
import { formatPrice, config } from '@/lib/config';

interface ProductDetailClientProps {
  product: any;
}

// è™•ç†æè¿°æ–‡å­—ï¼šæ›è¡Œ + é—œéµå­—é«˜äº®
function formatDescription(text: string): string {
  if (!text) return '';

  // é—œéµå­—åˆ—è¡¨ï¼ˆæœƒåŠ ç²— + é‡‘è‰²ï¼‰
  const keywords = [
    'ä¸»è¦æˆåˆ†', 'æˆåˆ†', 'æ²–æ³¡æ–¹å¼', 'ä½¿ç”¨æ–¹å¼', 'é£Ÿç”¨æ–¹å¼',
    'è¦æ ¼', 'å®¹é‡', 'ä¿å­˜æ–¹å¼', 'æ³¨æ„äº‹é …', 'é©ç”¨å°è±¡',
    'ç”¢åœ°', 'æœ‰æ•ˆæœŸé™', 'å»ºè­°', 'ç‰¹è‰²', 'åŠŸæ•ˆ'
  ];

  // å°‡ \n è½‰æ›ç‚º <br/>ï¼Œä¸¦è™•ç†é—œéµå­—
  let formatted = text
    .split('\n')
    .map(line => {
      // æª¢æŸ¥æ˜¯å¦æœ‰é—œéµå­—é–‹é ­
      for (const keyword of keywords) {
        if (line.includes(keyword + 'ï¼š') || line.includes(keyword + ':')) {
          // å°‡é—œéµå­—åŒ…åœ¨ span ä¸­
          return line.replace(
            new RegExp(`(${keyword}[ï¼š:])`, 'g'),
            '<span class="keyword-highlight">$1</span>'
          );
        }
      }
      return line;
    })
    .join('<br/>');

  return formatted;
}

export default function ProductDetailClient({ product }: ProductDetailClientProps) {
  const router = useRouter();
  const { addItem } = useCart();
  const [quantity, setQuantity] = useState(1);
  const [selectedOptions, setSelectedOptions] = useState<Record<string, string>>({});
  const [addedFeedback, setAddedFeedback] = useState(false);
  const [isAdding, setIsAdding] = useState(false);
  const [showToast, setShowToast] = useState(false);
  const [descriptionExpanded, setDescriptionExpanded] = useState(false);

  // æ•´ç†åœ–ç‰‡
  const images = useMemo(() => {
    const imgs: Array<{ id: string; url: string }> = [];
    if (product.thumbnail) {
      imgs.push({ id: 'thumb', url: product.thumbnail });
    }
    if (product.images) {
      product.images.forEach((img: any) => {
        if (img.url && img.url !== product.thumbnail) {
          imgs.push({ id: img.id, url: img.url });
        }
      });
    }
    return imgs;
  }, [product]);

  // æ•´ç†é¸é …
  const options = useMemo(() => {
    return product.options?.map((opt: any) => ({
      id: opt.id,
      title: opt.title,
      values: opt.values || [],
    })) || [];
  }, [product]);

  // æ ¹æ“šé¸æ“‡æ‰¾åˆ°å°æ‡‰ variant
  const selectedVariant = useMemo(() => {
    if (!product.variants || product.variants.length === 0) return null;
    if (product.variants.length === 1) return product.variants[0];

    // å¤šè®Šé«”ï¼šæ ¹æ“šé¸é …åŒ¹é…
    return product.variants.find((v: any) => {
      if (!v.options) return false;
      return v.options.every((opt: any) =>
        selectedOptions[opt.option_id] === opt.value
      );
    }) || null;
  }, [product.variants, selectedOptions]);

  // åƒ¹æ ¼
  const price = selectedVariant?.calculated_price?.calculated_amount;
  const originalPrice = selectedVariant?.calculated_price?.original_amount;
  const hasDiscount = originalPrice && originalPrice > price;

  // æ˜¯å¦å¯åŠ å…¥è³¼ç‰©è»Š
  const canAdd = product.variants?.length === 1 || selectedVariant !== null;

  // è™•ç†é¸é …è®Šæ›´
  const handleOptionSelect = (optionId: string, value: string) => {
    setSelectedOptions(prev => ({ ...prev, [optionId]: value }));
  };

  // åŠ å…¥è³¼ç‰©è»Š
  const handleAddToCart = async () => {
    if (!canAdd || isAdding) return;

    const variant = selectedVariant || product.variants?.[0];
    if (!variant) return;

    try {
      setIsAdding(true);
      await addItem(variant.id, quantity);

      // å›é¥‹å‹•ç•«
      setAddedFeedback(true);
      setShowToast(true);

      setTimeout(() => setAddedFeedback(false), 2000);
      setTimeout(() => setShowToast(false), 3000);
    } catch (error) {
      console.error('åŠ å…¥è³¼ç‰©è»Šå¤±æ•—:', error);
    } finally {
      setIsAdding(false);
    }
  };

  // ç«‹å³è³¼è²·
  const handleBuyNow = async () => {
    if (!canAdd || isAdding) return;

    const variant = selectedVariant || product.variants?.[0];
    if (!variant) return;

    try {
      setIsAdding(true);
      await addItem(variant.id, quantity);
      router.push('/checkout');
    } catch (error) {
      console.error('åŠ å…¥è³¼ç‰©è»Šå¤±æ•—:', error);
      setIsAdding(false);
    }
  };

  // è™•ç†æè¿°
  const formattedDescription = useMemo(() => {
    return formatDescription(product.description || '');
  }, [product.description]);

  // åˆ¤æ–·æè¿°æ˜¯å¦éé•·ï¼ˆè¶…é 150 å­—ï¼‰
  const descriptionIsLong = (product.description?.length || 0) > 150;

  return (
    <div className="max-w-7xl mx-auto px-5 py-8 pb-32 md:pb-8">
      {/* Toast æç¤º */}
      {showToast && (
        <div
          className="fixed top-20 left-1/2 -translate-x-1/2 z-50 px-5 py-3 rounded-xl flex items-center gap-4 animate-fade-in"
          style={{
            background: 'rgba(0,0,0,0.95)',
            border: '1px solid rgba(212,175,55,0.3)',
            boxShadow: '0 4px 20px rgba(0,0,0,0.5)',
          }}
        >
          <span style={{ color: '#06C755' }}>âœ“ å·²åŠ å…¥è³¼ç‰©è»Š</span>
          <Link
            href="/checkout"
            className="font-medium transition-colors"
            style={{ color: '#D4AF37' }}
          >
            å‰å¾€çµå¸³ â†’
          </Link>
        </div>
      )}

      {/* éºµåŒ…å±‘ */}
      <nav className="mb-8 text-sm" style={{ color: 'rgba(255,255,255,0.35)' }}>
        <Link href="/" className="hover:text-white transition-colors">é¦–é </Link>
        <span className="mx-2">/</span>
        <Link href="/products" className="hover:text-white transition-colors">å•†å“</Link>
        <span className="mx-2">/</span>
        <span style={{ color: 'rgba(255,255,255,0.6)' }}>{product.title}</span>
      </nav>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12">
        {/* å·¦ï¼šåœ–ç‰‡ */}
        <ImageGallery images={images} title={product.title} />

        {/* å³ï¼šå•†å“è³‡è¨Š */}
        <div>
          {/* æ¨™é¡Œ */}
          <h1 className="text-2xl md:text-3xl font-light tracking-wide mb-4"
            style={{ color: 'rgba(255,255,255,0.95)' }}>
            {product.title}
          </h1>

          {/* å‰¯æ¨™ */}
          {product.subtitle && (
            <p className="text-sm mb-5" style={{ color: 'rgba(255,255,255,0.45)' }}>
              {product.subtitle}
            </p>
          )}

          {/* åƒ¹æ ¼ */}
          <div className="flex items-center gap-3 mb-8">
            {hasDiscount && (
              <span className="text-lg line-through" style={{ color: 'rgba(255,255,255,0.3)' }}>
                {formatPrice(originalPrice)}
              </span>
            )}
            <span className="text-2xl md:text-3xl font-bold gold-text">
              {price ? formatPrice(price) : 'è«‹é¸æ“‡è¦æ ¼'}
            </span>
            {hasDiscount && (
              <span className="text-xs px-2 py-1 rounded-full font-medium"
                style={{ background: 'rgba(212,175,55,0.15)', color: '#D4AF37' }}>
                å„ªæƒ åƒ¹
              </span>
            )}
          </div>

          {/* åˆ†éš”ç·š */}
          <div className="mb-6" style={{ borderTop: '1px solid rgba(212,175,55,0.1)' }} />

          {/* è®Šé«”é¸æ“‡å™¨ */}
          {options.length > 0 && (
            <div className="mb-6">
              <VariantSelector
                options={options}
                selectedOptions={selectedOptions}
                onSelect={handleOptionSelect}
              />
            </div>
          )}

          {/* æ•¸é‡ */}
          <div className="mb-8">
            <label className="block text-sm mb-3" style={{ color: 'rgba(255,255,255,0.7)' }}>
              æ•¸é‡
            </label>
            <QuantitySelector quantity={quantity} onChange={setQuantity} />
          </div>

          {/* æ¡Œé¢ç‰ˆæŒ‰éˆ•å€ - æ‰‹æ©Ÿç‰ˆéš±è— */}
          <div className="hidden md:block space-y-3">
            {/* åŠ å…¥è³¼ç‰©è»Š */}
            <button
              onClick={handleAddToCart}
              disabled={!canAdd || isAdding}
              className="w-full py-4 rounded-full text-base font-semibold tracking-wider transition-all duration-300"
              style={{
                background: !canAdd
                  ? 'rgba(255,255,255,0.1)'
                  : addedFeedback
                    ? '#06C755'
                    : 'linear-gradient(135deg, #D4AF37, #B8962E)',
                color: !canAdd ? 'rgba(255,255,255,0.3)' : addedFeedback ? '#fff' : '#000',
                cursor: canAdd && !isAdding ? 'pointer' : 'not-allowed',
                boxShadow: canAdd && !addedFeedback ? '0 4px 20px rgba(212,175,55,0.3)' : 'none',
              }}
            >
              {isAdding ? 'åŠ å…¥ä¸­...' : addedFeedback ? 'âœ“ å·²åŠ å…¥è³¼ç‰©è»Š' : !canAdd ? 'è«‹é¸æ“‡è¦æ ¼' : 'åŠ å…¥è³¼ç‰©è»Š'}
            </button>

            {/* ç«‹å³è³¼è²· */}
            <button
              onClick={handleBuyNow}
              disabled={!canAdd || isAdding}
              className="w-full py-4 rounded-full text-base font-semibold tracking-wider transition-all duration-300"
              style={{
                background: 'transparent',
                border: '1px solid rgba(212,175,55,0.5)',
                color: !canAdd ? 'rgba(255,255,255,0.3)' : '#D4AF37',
                cursor: canAdd && !isAdding ? 'pointer' : 'not-allowed',
              }}
            >
              {isAdding ? 'è™•ç†ä¸­...' : 'ç«‹å³è³¼è²·'}
            </button>
          </div>

          {/* å…é‹æç¤º */}
          <p className="text-center text-xs mt-4 hidden md:block" style={{ color: 'rgba(255,255,255,0.4)' }}>
            ğŸš› æ»¿ {formatPrice(config.shipping.freeShippingThreshold)} å…é‹è²»
          </p>

          {/* åˆ†éš”ç·š */}
          <div className="my-8" style={{ borderTop: '1px solid rgba(212,175,55,0.1)' }} />

          {/* å•†å“èªªæ˜ - å¯æŠ˜ç–Š */}
          {product.description && (
            <div>
              <h3 className="text-sm font-medium tracking-wider mb-4"
                style={{ color: 'rgba(212,175,55,0.7)' }}>
                å•†å“èªªæ˜
              </h3>
              <div className="relative">
                <div
                  className={`text-sm leading-loose overflow-hidden transition-all duration-300 ${
                    !descriptionExpanded && descriptionIsLong ? 'max-h-36' : 'max-h-[2000px]'
                  }`}
                  style={{ color: 'rgba(255,255,255,0.55)' }}
                >
                  <div
                    dangerouslySetInnerHTML={{ __html: formattedDescription }}
                    className="description-content"
                  />
                </div>

                {/* æ¼¸å±¤é®ç½© + æŸ¥çœ‹æ›´å¤šæŒ‰éˆ• */}
                {descriptionIsLong && !descriptionExpanded && (
                  <div
                    className="absolute bottom-0 left-0 right-0 h-20 flex items-end justify-center pb-2"
                    style={{
                      background: 'linear-gradient(to bottom, transparent, rgba(10,10,10,0.9) 50%, rgba(10,10,10,1))',
                    }}
                  >
                    <button
                      onClick={() => setDescriptionExpanded(true)}
                      className="text-sm font-medium px-4 py-1.5 rounded-full transition-colors"
                      style={{
                        color: '#D4AF37',
                        background: 'rgba(212,175,55,0.1)',
                        border: '1px solid rgba(212,175,55,0.2)',
                      }}
                    >
                      æŸ¥çœ‹æ›´å¤š â†“
                    </button>
                  </div>
                )}

                {/* æ”¶èµ·æŒ‰éˆ• */}
                {descriptionIsLong && descriptionExpanded && (
                  <div className="flex justify-center mt-4">
                    <button
                      onClick={() => setDescriptionExpanded(false)}
                      className="text-sm font-medium px-4 py-1.5 rounded-full transition-colors"
                      style={{
                        color: '#D4AF37',
                        background: 'rgba(212,175,55,0.1)',
                        border: '1px solid rgba(212,175,55,0.2)',
                      }}
                    >
                      æ”¶èµ· â†‘
                    </button>
                  </div>
                )}
              </div>
            </div>
          )}
        </div>
      </div>

      {/* æ‰‹æ©Ÿç‰ˆåº•éƒ¨ sticky è³¼ç‰©æ¬„ */}
      <div
        className="fixed bottom-0 left-0 right-0 z-50 md:hidden"
        style={{
          background: 'rgba(0,0,0,0.95)',
          backdropFilter: 'blur(10px)',
          borderTop: '1px solid rgba(212,175,55,0.2)',
        }}
      >
        <div className="px-4 py-3">
          {/* åƒ¹æ ¼ + å…é‹æç¤º */}
          <div className="flex items-center justify-between mb-3">
            <div className="flex items-center gap-2">
              <span className="text-xl font-bold gold-text">
                {price ? formatPrice(price) : 'è«‹é¸æ“‡è¦æ ¼'}
              </span>
              {hasDiscount && (
                <span className="text-sm line-through" style={{ color: 'rgba(255,255,255,0.3)' }}>
                  {formatPrice(originalPrice)}
                </span>
              )}
            </div>
            <span className="text-xs" style={{ color: 'rgba(255,255,255,0.4)' }}>
              ğŸš› æ»¿ {formatPrice(config.shipping.freeShippingThreshold)} å…é‹
            </span>
          </div>

          {/* æŒ‰éˆ•çµ„ */}
          <div className="flex gap-3">
            <button
              onClick={handleAddToCart}
              disabled={!canAdd || isAdding}
              className="flex-1 py-3 rounded-full text-sm font-semibold transition-all"
              style={{
                background: !canAdd
                  ? 'rgba(255,255,255,0.1)'
                  : addedFeedback
                    ? '#06C755'
                    : 'linear-gradient(135deg, #D4AF37, #B8962E)',
                color: !canAdd ? 'rgba(255,255,255,0.3)' : addedFeedback ? '#fff' : '#000',
              }}
            >
              {isAdding ? '...' : addedFeedback ? 'âœ“ å·²åŠ å…¥' : !canAdd ? 'è«‹é¸è¦æ ¼' : 'åŠ å…¥è³¼ç‰©è»Š'}
            </button>

            <button
              onClick={handleBuyNow}
              disabled={!canAdd || isAdding}
              className="flex-1 py-3 rounded-full text-sm font-semibold transition-all"
              style={{
                background: 'transparent',
                border: '1px solid rgba(212,175,55,0.5)',
                color: !canAdd ? 'rgba(255,255,255,0.3)' : '#D4AF37',
              }}
            >
              ç«‹å³è³¼è²·
            </button>
          </div>
        </div>
      </div>

      {/* æè¿°é—œéµå­—é«˜äº®æ¨£å¼ */}
      <style jsx global>{`
        .description-content .keyword-highlight {
          color: #D4AF37;
          font-weight: 500;
        }

        @keyframes fade-in {
          from { opacity: 0; transform: translate(-50%, -10px); }
          to { opacity: 1; transform: translate(-50%, 0); }
        }

        .animate-fade-in {
          animation: fade-in 0.3s ease-out;
        }
      `}</style>
    </div>
  );
}


=== app/checkout/page.tsx ===
'use client';

import { useState, useEffect, useRef, useCallback } from 'react';
import { useRouter } from 'next/navigation';
import Image from 'next/image';
import Link from 'next/link';
import { useCart } from '@/components/CartProvider';
import { formatPrice, config, shipping } from '@/lib/config';
import { createCheckout, getCvsMap, getCvsSelection, CVS_NAMES, CvsSelection } from '@/lib/gateway';
import { initPaymentForCart } from '@/lib/medusa';
import CreditsSelector from '@/components/checkout/CreditsSelector';

type ShippingMethod = 'cvs' | 'home';
type CvsType = 'UNIMARTC2C' | 'FAMIC2C' | 'HILIFEC2C';

interface FormData {
  name: string;
  phone: string;
  email: string;
  // å®…é…
  address: string;
  city: string;
  zipCode: string;
  // è¶…å–
  cvsType: CvsType;
}

// SessionStorage keys
const STORAGE_KEYS = {
  TEMP_TRADE_NO: 'cvs_temp_trade_no',
  FORM_DATA: 'checkout_form_data',
  SHIPPING_METHOD: 'checkout_shipping_method',
};

// Shipping options å’Œå…é‹é–€æª»è¨­å®š
const SHIPPING_CONFIG = {
  home: {
    paid: 'so_01KGYTF42QQBBP9PNBPBZAZF73',     // å®…é… $100
    free: 'so_01KGZ4K103XXQC45EX2HTHXKHW',     // å®…é…å…é‹ $0
    fee: 100,
    freeThreshold: 3000,
  },
  cvs: {
    paid: 'so_01KGT10N7MH9ACTVKJE5G223G8',     // è¶…å•† $60
    free: 'so_01KGZ4K364F7BAYAR7Q53XAB10',     // è¶…å•†å…é‹ $0
    fee: 60,
    freeThreshold: 1000,
  },
};

// æ»¿é¡è‡ªå‹•æŠ˜æ‰£è¨­å®šï¼ˆFULL2000ï¼šæ»¿ $2000 æŠ˜ $200ï¼‰
const AUTO_DISCOUNT_CONFIG = {
  code: 'FULL2000',
  threshold: 2000,
  amount: 200,
};

// å¾ cart.items çš„ adjustments è¨ˆç®—æ¯å€‹ promotion çš„å¯¦éš›æŠ˜æ‰£é‡‘é¡
function calculateDiscountsByCode(cart: any): Record<string, number> {
  const discounts: Record<string, number> = {};

  if (!cart?.items) return discounts;

  cart.items.forEach((item: any) => {
    if (!item.adjustments) return;

    item.adjustments.forEach((adj: any) => {
      if (adj.code) {
        discounts[adj.code] = (discounts[adj.code] || 0) + (adj.amount || 0);
      }
    });
  });

  return discounts;
}

// æ ¹æ“šé…é€æ–¹å¼å’Œå•†å“å°è¨ˆï¼Œå–å¾—é‹è²»å’Œ shipping option ID
function getShippingInfo(method: ShippingMethod, subtotal: number) {
  const config = SHIPPING_CONFIG[method];
  const isFree = subtotal >= config.freeThreshold;
  return {
    fee: isFree ? 0 : config.fee,
    optionId: isFree ? config.free : config.paid,
    isFree,
    threshold: config.freeThreshold,
    remaining: Math.max(0, config.freeThreshold - subtotal),
  };
}

// åµæ¸¬æ˜¯å¦ç‚ºæ‰‹æ©Ÿè£ç½®
const isMobileDevice = (): boolean => {
  if (typeof window === 'undefined') return false;

  // æª¢æŸ¥è¢å¹•å¯¬åº¦
  if (window.innerWidth < 768) return true;

  // æª¢æŸ¥ userAgent
  const userAgent = navigator.userAgent.toLowerCase();
  const mobileKeywords = ['android', 'iphone', 'ipad', 'ipod', 'mobile', 'webos', 'blackberry', 'opera mini', 'iemobile'];
  return mobileKeywords.some(keyword => userAgent.includes(keyword));
};

export default function CheckoutPage() {
  const router = useRouter();
  const { cart, isLoading: cartLoading, refreshCart } = useCart();

  const [shippingMethod, setShippingMethod] = useState<ShippingMethod>('cvs');
  const [formData, setFormData] = useState<FormData>({
    name: '',
    phone: '',
    email: '',
    address: '',
    city: '',
    zipCode: '',
    cvsType: 'UNIMARTC2C',
  });
  const [cvsSelection, setCvsSelection] = useState<CvsSelection | null>(null);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isSelectingStore, setIsSelectingStore] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [creditsToUse, setCreditsToUse] = useState(0);
  const [isLineLoggedIn, setIsLineLoggedIn] = useState(false);
  const [lineCustomerId, setLineCustomerId] = useState<string | null>(null);
  const [paymentMethod, setPaymentMethod] = useState<'credit_card' | 'cod'>('credit_card');

  // æŠ˜æ‰£ç¢¼
  const [promoCode, setPromoCode] = useState('');
  const [promoLoading, setPromoLoading] = useState(false);
  const [promoError, setPromoError] = useState('');
  const [promoApplied, setPromoApplied] = useState<{ code: string; discount: number } | null>(null);

  // æ»¿é¡è‡ªå‹•æŠ˜æ‰£ï¼ˆFULL2000ï¼‰
  const [autoDiscount, setAutoDiscount] = useState<{ code: string; discount: number } | null>(null);

  // ç”¨æ–¼æ¸…ç† interval
  const pollingRef = useRef<NodeJS.Timeout | null>(null);

  // è¨ˆç®—é‡‘é¡
  const subtotal = cart?.subtotal || 0;
  const shippingInfo = getShippingInfo(shippingMethod, subtotal);
  const shippingFee = shippingInfo.fee;

  // å¾ cart.items adjustments è¨ˆç®—å„ promotion çš„å¯¦éš›æŠ˜æ‰£
  const discountsByCode = calculateDiscountsByCode(cart);
  const autoDiscountAmount = discountsByCode[AUTO_DISCOUNT_CONFIG.code] || 0;
  const promoDiscountAmount = promoApplied ? (discountsByCode[promoApplied.code] || 0) : 0;
  const totalDiscount = autoDiscountAmount + promoDiscountAmount;
  const total = subtotal - totalDiscount - creditsToUse + shippingFee;

  // Polling å–å¾—é–€å¸‚é¸æ“‡çµæœ
  const pollCvsSelection = useCallback(async (tempTradeNo: string, maxAttempts = 30) => {
    let attempts = 0;

    const poll = async () => {
      if (attempts >= maxAttempts) {
        setIsSelectingStore(false);
        sessionStorage.removeItem(STORAGE_KEYS.TEMP_TRADE_NO);
        return;
      }

      attempts++;

      try {
        const selection = await getCvsSelection(tempTradeNo);
        console.log('Polling result:', selection);

        if (selection.success && selection.selection?.store_id) {
          // é¸å®Œäº†ï¼
          setCvsSelection(selection.selection);
          setIsSelectingStore(false);
          sessionStorage.removeItem(STORAGE_KEYS.TEMP_TRADE_NO);

          if (pollingRef.current) {
            clearInterval(pollingRef.current);
            pollingRef.current = null;
          }
          return;
        }
      } catch (e) {
        // é‚„æ²’é¸å®Œï¼Œç¹¼çºŒç­‰
      }
    };

    // ç«‹å³åŸ·è¡Œä¸€æ¬¡
    await poll();

    // å¦‚æœé‚„æ²’é¸å®Œï¼Œè¨­å®š interval
    if (!cvsSelection) {
      pollingRef.current = setInterval(poll, 2000);
    }
  }, [cvsSelection]);

  // é é¢è¼‰å…¥æ™‚ï¼šæª¢æŸ¥æ˜¯å¦å¾æ‰‹æ©Ÿç‰ˆåœ°åœ–é¸æ“‡è¿”å›
  useEffect(() => {
    // é‚„åŸè¡¨å–®è³‡æ–™
    const savedFormData = sessionStorage.getItem(STORAGE_KEYS.FORM_DATA);
    const savedShippingMethod = sessionStorage.getItem(STORAGE_KEYS.SHIPPING_METHOD);

    if (savedFormData) {
      try {
        setFormData(JSON.parse(savedFormData));
      } catch (e) {
        console.error('Failed to parse saved form data');
      }
    }

    if (savedShippingMethod) {
      setShippingMethod(savedShippingMethod as ShippingMethod);
    }

    // æª¢æŸ¥æ˜¯å¦æœ‰å¾…è™•ç†çš„é–€å¸‚é¸æ“‡
    const tempTradeNo = sessionStorage.getItem(STORAGE_KEYS.TEMP_TRADE_NO);
    if (tempTradeNo) {
      setIsSelectingStore(true);
      pollCvsSelection(tempTradeNo);
    }

    // æ¸…ç†è¡¨å–®æš«å­˜ï¼ˆä½†ä¿ç•™ tempTradeNo ç›´åˆ°é¸å®Œï¼‰
    sessionStorage.removeItem(STORAGE_KEYS.FORM_DATA);
    sessionStorage.removeItem(STORAGE_KEYS.SHIPPING_METHOD);
  }, [pollCvsSelection]);

  // æ¸…ç† polling
  useEffect(() => {
    return () => {
      if (pollingRef.current) {
        clearInterval(pollingRef.current);
      }
    };
  }, []);

  // æª¢æŸ¥ LINE ç™»å…¥ç‹€æ…‹
  useEffect(() => {
    fetch('/api/auth/line/session')
      .then(res => res.json())
      .then(data => {
        if (data.logged_in) {
          setIsLineLoggedIn(true);
          if (data.customer_id) setLineCustomerId(data.customer_id);
        }
      })
      .catch(() => {});
  }, []);

  // ç®¡ç† FULL2000 æ»¿é¡è‡ªå‹•æŠ˜æ‰£
  const lastSubtotalRef = useRef<number | null>(null);

  useEffect(() => {
    if (!cart?.id || cartLoading) return;

    const subtotal = cart.subtotal || 0;
    const hasFull2000 = cart.promotions?.some(p => p.code === AUTO_DISCOUNT_CONFIG.code);

    // å¾ adjustments è¨ˆç®— FULL2000 çš„å¯¦éš›æŠ˜æ‰£é‡‘é¡
    const currentDiscounts = calculateDiscountsByCode(cart);
    const full2000Discount = currentDiscounts[AUTO_DISCOUNT_CONFIG.code] || 0;

    // é¿å…é‡è¤‡è™•ç†ç›¸åŒçš„ subtotal
    if (lastSubtotalRef.current === subtotal) {
      // subtotal æ²’è®Šï¼Œåªæ›´æ–° UI ç‹€æ…‹
      if (subtotal >= AUTO_DISCOUNT_CONFIG.threshold && hasFull2000 && full2000Discount > 0) {
        setAutoDiscount({
          code: AUTO_DISCOUNT_CONFIG.code,
          discount: full2000Discount,
        });
      } else {
        setAutoDiscount(null);
      }
      return;
    }

    lastSubtotalRef.current = subtotal;

    const manageFull2000 = async () => {
      if (subtotal >= AUTO_DISCOUNT_CONFIG.threshold) {
        // é”é–€æª»ï¼šä¿ç•™æŠ˜æ‰£ä¸¦æ›´æ–° UI
        if (hasFull2000 && full2000Discount > 0) {
          setAutoDiscount({
            code: AUTO_DISCOUNT_CONFIG.code,
            discount: full2000Discount,
          });
        } else {
          // Medusa è‡ªå‹•æŠ˜æ‰£æ‡‰è©²æœƒè‡ªå‹•å¥—ç”¨ï¼Œåªéœ€åˆ·æ–° cart
          await refreshCart();
        }
      } else {
        // æœªé”é–€æª»ï¼šå¦‚æœæœ‰ FULL2000 å°±ç§»é™¤
        if (hasFull2000) {
          try {
            console.log('[Checkout] Removing FULL2000 - subtotal below threshold:', subtotal);
            await fetch(
              `${config.medusa.backendUrl}/store/carts/${cart.id}/promotions`,
              {
                method: 'DELETE',
                headers: {
                  'Content-Type': 'application/json',
                  'x-publishable-api-key': config.medusa.publishableKey,
                },
                body: JSON.stringify({ promo_codes: [AUTO_DISCOUNT_CONFIG.code] }),
              }
            );
            await refreshCart();
          } catch (err) {
            console.error('[Checkout] Failed to remove FULL2000:', err);
          }
        }
        setAutoDiscount(null);
      }
    };

    manageFull2000();
  }, [cart?.id, cart?.subtotal, cart?.items, cart?.promotions, cartLoading, refreshCart]);

  // æ›´æ–°è¡¨å–®
  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
    const { name, value } = e.target;
    setFormData((prev) => ({ ...prev, [name]: value }));
  };

  // å¥—ç”¨æŠ˜æ‰£ç¢¼
  const applyPromoCode = async () => {
    if (!promoCode.trim() || !cart?.id) return;
    setPromoLoading(true);
    setPromoError('');

    const codeToApply = promoCode.trim().toUpperCase();
    console.log('[Checkout] Applying promo code:', codeToApply);

    try {
      const res = await fetch(
        `${config.medusa.backendUrl}/store/carts/${cart.id}/promotions`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-publishable-api-key': config.medusa.publishableKey,
          },
          body: JSON.stringify({ promo_codes: [codeToApply] }),
        }
      );

      const data = await res.json();
      console.log('[Checkout] Promo API response:', { status: res.status, data });

      if (!res.ok) {
        const errorMsg = data.message || data.error || 'æŠ˜æ‰£ç¢¼ç„¡æ•ˆæˆ–å·²éæœŸ';
        console.error('[Checkout] Promo code error:', errorMsg);
        setPromoError(errorMsg);
        return;
      }

      if (data.type === 'not_found' || data.type === 'invalid_data') {
        setPromoError('æŠ˜æ‰£ç¢¼ç„¡æ•ˆæˆ–å·²éæœŸ');
        return;
      }

      // å¾å›å‚³çš„ cart.items.adjustments è¨ˆç®—é€™å€‹ promo code çš„å¯¦éš›æŠ˜æ‰£
      const returnedDiscounts = calculateDiscountsByCode(data.cart);
      const promoCodeDiscount = returnedDiscounts[codeToApply] || 0;
      console.log('[Checkout] Promo applied, code discount:', codeToApply, promoCodeDiscount);

      if (promoCodeDiscount === 0) {
        setPromoError('æŠ˜æ‰£ç¢¼ä¸é©ç”¨æ–¼ç›®å‰çš„è³¼ç‰©è»Š');
        return;
      }

      setPromoApplied({
        code: codeToApply,
        discount: promoCodeDiscount,
      });
      setPromoCode('');

      // åˆ·æ–° cart ä»¥ç¢ºä¿ UI åŒæ­¥
      await refreshCart();
    } catch (err) {
      setPromoError('å¥—ç”¨å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    } finally {
      setPromoLoading(false);
    }
  };

  // ç§»é™¤æŠ˜æ‰£ç¢¼
  const removePromoCode = async () => {
    if (!promoApplied || !cart?.id) return;

    try {
      await fetch(
        `${config.medusa.backendUrl}/store/carts/${cart.id}/promotions`,
        {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'x-publishable-api-key': config.medusa.publishableKey,
          },
          body: JSON.stringify({ promo_codes: [promoApplied.code] }),
        }
      );

      setPromoApplied(null);
      setPromoCode('');
    } catch (err) {
      console.error('ç§»é™¤æŠ˜æ‰£ç¢¼å¤±æ•—', err);
    }
  };

  // é–‹å•Ÿè¶…å•†åœ°åœ–ï¼ˆæ ¹æ“šè£ç½®é¡å‹é¸æ“‡æ–¹å¼ï¼‰
  const handleOpenCvsMap = async () => {
    try {
      setError(null);
      setIsSelectingStore(true);

      const isMobile = isMobileDevice();
      let mapWindow: Window | null = null;

      // ===== æ¡Œé¢ç‰ˆï¼šå…ˆé–‹ç©ºç™½è¦–çª—ï¼ˆé¿å…è¢« popup blocker æ””æˆªï¼‰=====
      if (!isMobile) {
        mapWindow = window.open('about:blank', 'cvsMap', 'width=900,height=700,scrollbars=yes,resizable=yes');

        // é¡¯ç¤ºè¼‰å…¥æç¤º
        if (mapWindow) {
          mapWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head><title>è¶…å•†åœ°åœ–</title></head>
            <body style="display:flex;align-items:center;justify-content:center;height:100vh;margin:0;font-family:system-ui,sans-serif;background:#f5f5f5;">
              <div style="text-align:center;">
                <div style="font-size:48px;margin-bottom:16px;">ğŸ—ºï¸</div>
                <div style="font-size:18px;color:#333;">æ­£åœ¨é–‹å•Ÿåœ°åœ–...</div>
                <div style="font-size:14px;color:#666;margin-top:8px;">è«‹ç¨å€™</div>
              </div>
            </body>
            </html>
          `);
        }
      }

      // å‘¼å« API å–å¾—åœ°åœ– URL
      const res = await getCvsMap({
        cvs_type: formData.cvsType,
        return_url: `${window.location.origin}/checkout`,
      });

      if (res.success && res.map_url) {
        const tempTradeNo = res.temp_trade_no;

        // ===== æ‰‹æ©Ÿç‰ˆ æˆ– æ¡Œé¢ç‰ˆè¢«æ””æˆªï¼šç›´æ¥è·³è½‰ =====
        if (isMobile || !mapWindow) {
          // å„²å­˜è¡¨å–®è³‡æ–™å’Œ tempTradeNo
          sessionStorage.setItem(STORAGE_KEYS.TEMP_TRADE_NO, tempTradeNo);
          sessionStorage.setItem(STORAGE_KEYS.FORM_DATA, JSON.stringify(formData));
          sessionStorage.setItem(STORAGE_KEYS.SHIPPING_METHOD, shippingMethod);

          // ç›´æ¥è·³è½‰åˆ°ç¶ ç•Œåœ°åœ–
          window.location.href = res.map_url;
          return;
        }

        // ===== æ¡Œé¢ç‰ˆï¼šå°å‘åœ°åœ– URL =====
        mapWindow.location.href = res.map_url;

        // æ¸…é™¤ä¹‹å‰çš„ polling
        if (pollingRef.current) {
          clearInterval(pollingRef.current);
        }

        // æ¯ 2 ç§’æª¢æŸ¥æ˜¯å¦é¸å®Œé–€å¸‚
        pollingRef.current = setInterval(async () => {
          try {
            // æª¢æŸ¥è¦–çª—æ˜¯å¦è¢«é—œé–‰
            if (mapWindow?.closed) {
              clearInterval(pollingRef.current!);
              pollingRef.current = null;
              setIsSelectingStore(false);
              return;
            }

            const selection = await getCvsSelection(tempTradeNo);
            console.log('Polling result:', selection);

            if (selection.success && selection.selection?.store_id) {
              // é¸å®Œäº†ï¼
              clearInterval(pollingRef.current!);
              pollingRef.current = null;
              mapWindow?.close();

              setCvsSelection(selection.selection);
              setIsSelectingStore(false);
            }
          } catch (e) {
            // é‚„æ²’é¸å®Œï¼Œç¹¼çºŒç­‰
          }
        }, 2000);

        // 60 ç§’å¾Œåœæ­¢æª¢æŸ¥ï¼ˆtimeoutï¼‰
        setTimeout(() => {
          if (pollingRef.current) {
            clearInterval(pollingRef.current);
            pollingRef.current = null;
            setIsSelectingStore(false);
          }
        }, 60000);

      } else {
        // API å¤±æ•—ï¼Œé—œé–‰ç©ºç™½è¦–çª—
        mapWindow?.close();
        setError('é–‹å•Ÿè¶…å•†åœ°åœ–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        setIsSelectingStore(false);
      }
    } catch (err) {
      setError('é–‹å•Ÿè¶…å•†åœ°åœ–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      setIsSelectingStore(false);
      console.error(err);
    }
  };

  // é©—è­‰è¡¨å–®
  const validateForm = (): boolean => {
    if (!formData.name.trim()) {
      setError('è«‹è¼¸å…¥æ”¶ä»¶äººå§“å');
      return false;
    }
    if (!formData.phone.trim() || !/^09\d{8}$/.test(formData.phone)) {
      setError('è«‹è¼¸å…¥æ­£ç¢ºçš„æ‰‹æ©Ÿè™Ÿç¢¼ï¼ˆ09é–‹é ­ï¼Œ10ç¢¼ï¼‰');
      return false;
    }
    if (formData.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) {
      setError('è«‹è¼¸å…¥æ­£ç¢ºçš„ Email æ ¼å¼');
      return false;
    }

    if (shippingMethod === 'cvs') {
      if (!cvsSelection) {
        setError('è«‹é¸æ“‡å–è²¨é–€å¸‚');
        return false;
      }
    } else {
      if (!formData.address.trim()) {
        setError('è«‹è¼¸å…¥æ”¶ä»¶åœ°å€');
        return false;
      }
    }

    return true;
  };

  // æäº¤çµå¸³
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!cart?.items?.length) {
      setError('è³¼ç‰©è»Šæ˜¯ç©ºçš„');
      return;
    }

    if (!validateForm()) return;

    try {
      setIsSubmitting(true);
      setError(null);

      // 1. åˆå§‹åŒ– Medusa Payment Collectionï¼ˆè®“ cart å¯ä»¥è¢« completeï¼‰
      // åŒæ™‚æ›´æ–° cart çš„é¡§å®¢è³‡æ–™
      console.log('[Checkout] Initializing payment for cart:', cart.id);
      const customerInfo = {
        firstName: formData.name,
        lastName: ' ',  // å°ç£ä¸åˆ† first/last nameï¼Œç”¨ç©ºæ ¼é¿å…é¡¯ç¤º "."
        email: formData.email || undefined,
        phone: formData.phone,
        address: shippingMethod === 'cvs'
          ? (cvsSelection?.address || 'è¶…å•†å–è²¨')
          : (formData.address || ''),
        city: shippingMethod === 'cvs' ? 'Taiwan' : (formData.city || 'Taiwan'),
        postalCode: shippingMethod === 'home' ? formData.zipCode : '000',
      };
      const paymentResult = await initPaymentForCart(
        cart.id,
        customerInfo,
        { ...(creditsToUse > 0 && { credits_used: creditsToUse }), payment_method: paymentMethod },
        shippingMethod,
        shippingInfo.optionId
      );
      console.log('[Checkout] Payment initialized:', paymentResult);

      if (!paymentResult.success) {
        throw new Error(paymentResult.error || 'Payment initialization failed');
      }

      // è²¨åˆ°ä»˜æ¬¾ï¼šä¸èµ° ECPayï¼Œç›´æ¥ complete cart
      if (paymentMethod === 'cod') {
        try {
          const completeRes = await fetch(
            `${config.medusa.backendUrl}/store/carts/${cart.id}/complete`,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-publishable-api-key': config.medusa.publishableKey,
              },
            }
          );
          if (completeRes.ok) {
            localStorage.removeItem('medusa_cart_id');
            window.location.href = `/checkout/complete?cart_id=${cart.id}&payment_method=cod`;
            return;
          } else {
            const errData = await completeRes.json().catch(() => ({}));
            throw new Error(errData.message || 'è¨‚å–®å»ºç«‹å¤±æ•—');
          }
        } catch (err: any) {
          setError(err.message || 'è¨‚å–®å»ºç«‹å¤±æ•—');
          setIsSubmitting(false);
          return;
        }
      }

      // 2. çµ„åˆå•†å“åç¨±
      const itemName = cart.items
        .map((item) => `${item.title} x${item.quantity}`)
        .join(', ')
        .slice(0, 200); // ECPay é™åˆ¶ 200 å­—å…ƒ

      // 3. å»ºç«‹ ECPay ä»˜æ¬¾
      const res = await createCheckout({
        amount: total,
        item_name: itemName,
        order_id: cart.id, // Medusa v2 cart.id å·²ç¶“æ˜¯ cart_xxx æ ¼å¼
        customer_name: formData.name,
        customer_phone: formData.phone,
        customer_email: formData.email || undefined,
        return_url: `${window.location.origin}/checkout/complete`,
        metadata: {
          cart_id: cart.id,
          shipping_method: shippingMethod,
          shipping_fee: shippingFee,
          credits_used: creditsToUse,
          // æŠ˜æ‰£ç¢¼
          ...(promoApplied && {
            promo_code: promoApplied.code,
            promo_discount: promoApplied.discount,
          }),
          // è¶…å–è³‡è¨Š
          ...(shippingMethod === 'cvs' && cvsSelection && {
            cvs_type: formData.cvsType,
            cvs_store_id: cvsSelection.store_id,
            cvs_store_name: cvsSelection.store_name,
            cvs_address: cvsSelection.address,
          }),
          // å®…é…è³‡è¨Š
          ...(shippingMethod === 'home' && {
            address: formData.address,
            city: formData.city,
            zip_code: formData.zipCode,
          }),
        },
      });

      if (res.success && res.checkout_url) {
        // è·³è½‰åˆ°ç¶ ç•Œä»˜æ¬¾
        window.location.href = res.checkout_url;
      } else {
        setError('å»ºç«‹è¨‚å–®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    } catch (err: any) {
      setError(err.message || 'çµå¸³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      console.error(err);
    } finally {
      setIsSubmitting(false);
    }
  };

  // è³¼ç‰©è»Šç‚ºç©º
  if (!cartLoading && (!cart?.items?.length)) {
    return (
      <div className="container mx-auto px-4 py-16 text-center">
        <h1 className="text-2xl font-bold mb-4">è³¼ç‰©è»Šæ˜¯ç©ºçš„</h1>
        <p className="text-gray-500 mb-8">å…ˆå»é€›é€›å§ï¼</p>
        <Link href="/" className="btn-primary">
          è¿”å›å•†åº—
        </Link>
      </div>
    );
  }

  return (
    <div className="checkout-page container mx-auto px-4 py-8">
      <h1 className="text-2xl font-bold mb-8">çµå¸³</h1>

      <div className="grid lg:grid-cols-3 gap-8">
        {/* å·¦å´ï¼šè¡¨å–® */}
        <div className="lg:col-span-2">
          <form onSubmit={handleSubmit} className="space-y-8">
            {/* æ”¶ä»¶äººè³‡è¨Š */}
            <section className="card p-6">
              <h2 className="text-lg font-bold mb-4">æ”¶ä»¶äººè³‡è¨Š</h2>
              <div className="grid gap-4">
                <div>
                  <label className="block text-sm font-medium mb-1">
                    å§“å <span className="text-red-500">*</span>
                  </label>
                  <input
                    type="text"
                    name="name"
                    value={formData.name}
                    onChange={handleChange}
                    className="input"
                    placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å"
                    required
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">
                    æ‰‹æ©Ÿ <span className="text-red-500">*</span>
                  </label>
                  <input
                    type="tel"
                    name="phone"
                    value={formData.phone}
                    onChange={handleChange}
                    className="input"
                    placeholder="0912345678"
                    pattern="09\d{8}"
                    required
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Email</label>
                  <input
                    type="email"
                    name="email"
                    value={formData.email}
                    onChange={handleChange}
                    className="input"
                    placeholder="é¸å¡«ï¼Œç”¨æ–¼å¯„é€è¨‚å–®é€šçŸ¥"
                  />
                </div>
              </div>
            </section>

            {/* ç‰©æµæ–¹å¼ */}
            <section className="card p-6">
              <h2 className="text-lg font-bold mb-4">ç‰©æµæ–¹å¼</h2>

              {/* ç‰©æµé¸é … */}
              <div className="flex gap-4 mb-6">
                {config.features.cvsLogistics && (
                  <button
                    type="button"
                    onClick={() => setShippingMethod('cvs')}
                    className={`flex-1 p-4 border-2 rounded-lg text-center transition-colors ${
                      shippingMethod === 'cvs'
                        ? 'border-white bg-white/10'
                        : 'border-gray-600 hover:border-gray-500'
                    }`}
                  >
                    <span className="block text-2xl mb-1">ğŸª</span>
                    <span className="font-medium">è¶…å•†å–è²¨</span>
                    <span className="block text-sm text-gray-500 mt-1">
                      {subtotal >= SHIPPING_CONFIG.cvs.freeThreshold ? 'å…é‹' : formatPrice(SHIPPING_CONFIG.cvs.fee)}
                    </span>
                  </button>
                )}
                {config.features.homeDelivery && (
                  <button
                    type="button"
                    onClick={() => { setShippingMethod('home'); setPaymentMethod('credit_card'); }}
                    className={`flex-1 p-4 border-2 rounded-lg text-center transition-colors ${
                      shippingMethod === 'home'
                        ? 'border-white bg-white/10'
                        : 'border-gray-600 hover:border-gray-500'
                    }`}
                  >
                    <span className="block text-2xl mb-1">ğŸšš</span>
                    <span className="font-medium">å®…é…åˆ°åºœ</span>
                    <span className="block text-sm text-gray-500 mt-1">
                      {subtotal >= SHIPPING_CONFIG.home.freeThreshold ? 'å…é‹' : formatPrice(SHIPPING_CONFIG.home.fee)}
                    </span>
                  </button>
                )}
              </div>

              {/* ä»˜æ¬¾æ–¹å¼ */}
              <div className="mt-6">
                <label className="block text-sm font-medium mb-3">ä»˜æ¬¾æ–¹å¼</label>
                <div className="grid grid-cols-2 gap-3">
                  <label className={`p-3 rounded-lg border-2 cursor-pointer text-center transition-colors ${paymentMethod === 'credit_card' ? 'border-[#D4AF37] bg-[rgba(212,175,55,0.1)]' : 'border-gray-600'}`}>
                    <input
                      type="radio"
                      name="paymentMethod"
                      value="credit_card"
                      checked={paymentMethod === 'credit_card'}
                      onChange={() => setPaymentMethod('credit_card')}
                      className="sr-only"
                    />
                    <span className="block text-sm font-medium">ğŸ’³ ä¿¡ç”¨å¡</span>
                    <span className="block text-xs text-gray-500 mt-1">ç·šä¸Šåˆ·å¡ä»˜æ¬¾</span>
                  </label>
                  {shippingMethod === 'cvs' && (
                    <label className={`p-3 rounded-lg border-2 cursor-pointer text-center transition-colors ${paymentMethod === 'cod' ? 'border-[#D4AF37] bg-[rgba(212,175,55,0.1)]' : 'border-gray-600'}`}>
                      <input
                        type="radio"
                        name="paymentMethod"
                        value="cod"
                        checked={paymentMethod === 'cod'}
                        onChange={() => setPaymentMethod('cod')}
                        className="sr-only"
                      />
                      <span className="block text-sm font-medium">ğŸª å–è²¨ä»˜æ¬¾</span>
                      <span className="block text-xs text-gray-500 mt-1">è¶…å•†å–è²¨æ™‚ä»˜æ¬¾</span>
                    </label>
                  )}
                </div>
              </div>

              {/* è¶…å•†å–è²¨ */}
              {shippingMethod === 'cvs' && (
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">é¸æ“‡è¶…å•†</label>
                    <div className="flex gap-2">
                      {shipping.cvsOptions.map((cvs) => (
                        <button
                          key={cvs}
                          type="button"
                          onClick={() => {
                            setFormData((prev) => ({ ...prev, cvsType: cvs as CvsType }));
                            setCvsSelection(null); // æ¸…é™¤ä¹‹å‰çš„é¸æ“‡
                          }}
                          className={`px-4 py-2 border rounded-lg transition-colors ${
                            formData.cvsType === cvs
                              ? 'border-primary bg-primary text-white'
                              : 'border-gray-200 hover:border-gray-300'
                          }`}
                        >
                          {CVS_NAMES[cvs]}
                        </button>
                      ))}
                    </div>
                  </div>

                  {/* é¸æ“‡é–€å¸‚æŒ‰éˆ• */}
                  <div>
                    {cvsSelection ? (
                      <div className="p-4 bg-green-50 border border-green-200 rounded-lg">
                        <div className="flex items-start justify-between">
                          <div>
                            <p className="font-medium text-green-800">
                              âœ… {cvsSelection.store_name}
                            </p>
                            <p className="text-sm text-green-600 mt-1">
                              {cvsSelection.address}
                            </p>
                          </div>
                          <button
                            type="button"
                            onClick={handleOpenCvsMap}
                            disabled={isSelectingStore}
                            className="text-sm text-green-700 underline disabled:opacity-50"
                          >
                            é‡æ–°é¸æ“‡
                          </button>
                        </div>
                      </div>
                    ) : (
                      <button
                        type="button"
                        onClick={handleOpenCvsMap}
                        disabled={isSelectingStore}
                        className="btn-outline w-full disabled:opacity-50"
                      >
                        {isSelectingStore ? (
                          <>
                            <span className="inline-block animate-spin mr-2">â³</span>
                            æ­£åœ¨å–å¾—é–€å¸‚è³‡è¨Š...
                          </>
                        ) : (
                          'ğŸ—ºï¸ é¸æ“‡å–è²¨é–€å¸‚'
                        )}
                      </button>
                    )}
                  </div>
                </div>
              )}

              {/* å®…é… */}
              {shippingMethod === 'home' && (
                <div className="grid gap-4">
                  <div className="grid grid-cols-3 gap-4">
                    <div>
                      <label className="block text-sm font-medium mb-1">éƒµéå€è™Ÿ</label>
                      <input
                        type="text"
                        name="zipCode"
                        value={formData.zipCode}
                        onChange={handleChange}
                        className="input"
                        placeholder="100"
                      />
                    </div>
                    <div className="col-span-2">
                      <label className="block text-sm font-medium mb-1">ç¸£å¸‚</label>
                      <input
                        type="text"
                        name="city"
                        value={formData.city}
                        onChange={handleChange}
                        className="input"
                        placeholder="å°åŒ—å¸‚"
                      />
                    </div>
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">
                      åœ°å€ <span className="text-red-500">*</span>
                    </label>
                    <input
                      type="text"
                      name="address"
                      value={formData.address}
                      onChange={handleChange}
                      className="input"
                      placeholder="è«‹è¼¸å…¥å®Œæ•´åœ°å€"
                      required={shippingMethod === 'home'}
                    />
                  </div>
                </div>
              )}
            </section>

            {/* éŒ¯èª¤è¨Šæ¯ */}
            {error && (
              <div className="error-box p-4">
                {error}
              </div>
            )}

            </form>
        </div>

        {/* å³å´ï¼šè¨‚å–®æ‘˜è¦ */}
        <div className="lg:col-span-1">
          <div className="card order-summary p-6 sticky top-24">
            <h2 className="text-lg font-bold mb-4">è¨‚å–®æ‘˜è¦</h2>

            {/* å•†å“åˆ—è¡¨ */}
            <ul className="divide-y mb-4">
              {cart?.items?.map((item) => (
                <li key={item.id} className="py-3 flex gap-3">
                  <div className="product-thumb w-16 h-16 rounded overflow-hidden flex-shrink-0">
                    {item.thumbnail && (
                      <Image
                        src={item.thumbnail}
                        alt={item.title}
                        width={64}
                        height={64}
                        className="w-full h-full object-cover"
                      />
                    )}
                  </div>
                  <div className="flex-grow min-w-0">
                    <p className="text-sm font-medium truncate">{item.title}</p>
                    <p className="text-xs text-gray-500">x{item.quantity}</p>
                    <p className="text-sm font-bold">{formatPrice(item.unit_price * item.quantity)}</p>
                  </div>
                </li>
              ))}
            </ul>

            {/* é‡‘é¡æ˜ç´° */}
            <div className="space-y-2 text-sm border-t pt-4">
              <div className="flex justify-between">
                <span>å•†å“å°è¨ˆ</span>
                <span>{formatPrice(subtotal)}</span>
              </div>
              <div className="flex justify-between">
                <span>é‹è²»</span>
                <span>
                  {shippingFee === 0 ? (
                    <span className="text-green-600">å…é‹</span>
                  ) : (
                    formatPrice(shippingFee)
                  )}
                </span>
              </div>

              {/* æŠ˜æ‰£ç¢¼è¼¸å…¥ */}
              <div className="my-4 pt-2 border-t border-gray-700">
                <label className="block text-sm text-gray-400 mb-2">æŠ˜æ‰£ç¢¼</label>
                {promoApplied ? (
                  <div
                    className="flex items-center justify-between p-3 rounded-lg"
                    style={{
                      background: 'rgba(212, 175, 55, 0.1)',
                      border: '1px solid rgba(212, 175, 55, 0.3)',
                    }}
                  >
                    <div>
                      <span style={{ color: '#D4AF37', fontWeight: 600 }}>âœ“ {promoApplied.code}</span>
                      <span className="text-gray-400 text-sm ml-2">
                        å·²æŠ˜æŠµ {formatPrice(promoDiscountAmount)}
                      </span>
                    </div>
                    <button
                      type="button"
                      onClick={removePromoCode}
                      className="text-red-400 text-sm hover:text-red-300"
                    >
                      ç§»é™¤
                    </button>
                  </div>
                ) : (
                  <div className="flex gap-2">
                    <input
                      type="text"
                      value={promoCode}
                      onChange={(e) => setPromoCode(e.target.value.toUpperCase())}
                      placeholder="è¼¸å…¥æŠ˜æ‰£ç¢¼"
                      className="flex-1 px-3 py-2 rounded-lg text-sm"
                      style={{
                        background: 'rgba(255, 255, 255, 0.05)',
                        border: '1px solid rgba(255, 255, 255, 0.2)',
                        color: '#fff',
                      }}
                      onKeyDown={(e) => e.key === 'Enter' && (e.preventDefault(), applyPromoCode())}
                    />
                    <button
                      type="button"
                      onClick={applyPromoCode}
                      disabled={promoLoading || !promoCode.trim()}
                      className="px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                      style={{
                        background: promoCode.trim() ? '#D4AF37' : '#333',
                        color: promoCode.trim() ? '#000' : '#666',
                      }}
                    >
                      {promoLoading ? '...' : 'å¥—ç”¨'}
                    </button>
                  </div>
                )}
                {promoError && <p className="text-red-400 text-xs mt-2">{promoError}</p>}
              </div>

              {/* æ»¿é¡è‡ªå‹•æŠ˜æ‰£é¡¯ç¤º */}
              {autoDiscountAmount > 0 && (
                <div className="flex justify-between text-sm">
                  <span style={{ color: '#D4AF37' }}>ğŸ‰ æ»¿é¡æŠ˜æ‰£</span>
                  <span style={{ color: '#D4AF37' }}>-{formatPrice(autoDiscountAmount)}</span>
                </div>
              )}

              {/* æŠ˜æ‰£ç¢¼é‡‘é¡é¡¯ç¤º */}
              {promoApplied && promoDiscountAmount > 0 && (
                <div className="flex justify-between text-sm">
                  <span style={{ color: '#D4AF37' }}>ğŸ·ï¸ æŠ˜æ‰£ç¢¼ {promoApplied.code}</span>
                  <span style={{ color: '#D4AF37' }}>-{formatPrice(promoDiscountAmount)}</span>
                </div>
              )}

              {/* ç™»å…¥æé†’ */}
              {!isLineLoggedIn && (
                <div className="my-3 p-3 rounded-lg" style={{ background: 'rgba(212, 175, 55, 0.08)', border: '1px solid rgba(212, 175, 55, 0.2)' }}>
                  <p className="text-sm" style={{ color: '#D4AF37' }}>
                    ğŸ’¡ <a href="/api/auth/line" className="underline font-medium">ç™»å…¥ LINE å¸³è™Ÿ</a> å³å¯ä½¿ç”¨è³¼ç‰©é‡‘æŠ˜æŠµï¼Œä¸¦è‡ªå‹•ç´¯ç©æ¶ˆè²»ç´€éŒ„
                  </p>
                </div>
              )}
              <CreditsSelector
                customerId={lineCustomerId}
                subtotal={subtotal}
                onCreditsChange={setCreditsToUse}
              />
              {creditsToUse > 0 && (
                <div className="flex justify-between text-sm">
                  <span style={{ color: '#D4AF37' }}>ğŸ’° è³¼ç‰©é‡‘æŠ˜æŠµ</span>
                  <span style={{ color: '#D4AF37' }}>-{formatPrice(creditsToUse)}</span>
                </div>
              )}
              <div className="flex justify-between text-lg font-bold border-t pt-2">
                <span>ç¸½è¨ˆ</span>
                <span className="text-accent">{formatPrice(total)}</span>
              </div>
            </div>

            {/* å…é‹æç¤º */}
            {shippingInfo.remaining > 0 && (
              <p className="text-xs text-gray-500 mt-4">
                å†è²· {formatPrice(shippingInfo.remaining)} å³å¯{shippingMethod === 'cvs' ? 'è¶…å•†' : 'å®…é…'}å…é‹
              </p>
            )}

            {/* æ»¿é¡æŠ˜æ‰£æç¤º */}
            {!autoDiscount && subtotal < AUTO_DISCOUNT_CONFIG.threshold && (
              <p className="text-xs text-gray-500 mt-2">
                å†è²· {formatPrice(AUTO_DISCOUNT_CONFIG.threshold - subtotal)} å³å¯äº«æ»¿é¡æŠ˜ {formatPrice(AUTO_DISCOUNT_CONFIG.amount)}
              </p>
            )}

            {/* æäº¤æŒ‰éˆ•ï¼ˆæ¡Œé¢ç‰ˆï¼‰ */}
            <button
              type="submit"
              form="checkout-form"
              onClick={handleSubmit}
              disabled={isSubmitting || cartLoading}
              className="btn-primary w-full py-3 mt-6 hidden lg:block disabled:opacity-50"
            >
              {isSubmitting ? 'è™•ç†ä¸­...' : paymentMethod === 'cod' ? 'ç¢ºèªä¸‹å–®' : 'å‰å¾€ä»˜æ¬¾'}
            </button>

            {/* è¿”å›è³¼ç‰© */}
            <Link
              href="/"
              className="continue-shopping block text-center text-sm text-gray-500 mt-4 hover:text-primary"
            >
              â† ç¹¼çºŒè³¼ç‰©
            </Link>
            <div className="h-20 lg:hidden"></div>
          </div>
        </div>
      </div>

      {/* æ‰‹æ©Ÿç‰ˆ fixed åº•éƒ¨æŒ‰éˆ• */}
      <div className="fixed bottom-0 left-0 right-0 z-50 p-4 lg:hidden" style={{ background: 'linear-gradient(180deg, transparent, #0a0a0a 30%)' }}>
        <button
          type="submit"
          form="checkout-form"
          onClick={handleSubmit}
          disabled={isSubmitting || cartLoading}
          className="btn-primary w-full py-4 text-lg disabled:opacity-50"
        >
          {isSubmitting ? 'è™•ç†ä¸­...' : paymentMethod === 'cod' ? `ç¢ºèªä¸‹å–® ${formatPrice(total)}` : `å‰å¾€ä»˜æ¬¾ ${formatPrice(total)}`}
        </button>
      </div>
    </div>
  );
}


=== app/checkout/complete/page.tsx ===
'use client';

import { useEffect, useState, useRef, Suspense } from 'react';
import Link from 'next/link';
import { useSearchParams } from 'next/navigation';

// === å·¥å…·å‡½æ•¸ ===

function formatPrice(amount: number): string {
  if (!amount || isNaN(amount)) return 'NT$ 0';
  return `NT$ ${Math.round(amount).toLocaleString()}`;
}

interface Order {
  id: string;
  display_id: number;
  status: string;
  created_at: string;
  items: any[];
  total: number;
  subtotal: number;
  discount_total: number;
  discount_subtotal: number;
  item_total: number;
  item_subtotal: number;
  shipping_total: number;
  shipping_address?: {
    first_name?: string;
    last_name?: string;
    phone?: string;
    address_1?: string;
    city?: string;
    postal_code?: string;
  };
  shipping_methods?: Array<{
    name?: string;
    amount?: number;
    shipping_option_id?: string;
  }>;
  summary?: {
    current_order_total?: number;
    paid_total?: number;
  };
  metadata?: {
    cvs_store_name?: string;
    cvs_address?: string;
    shipping_method?: string;
    credits_used?: number;
  };
}

function CheckoutCompleteContent() {
  const searchParams = useSearchParams();
  const [status, setStatus] = useState<'loading' | 'success' | 'failed'>('loading');
  const [order, setOrder] = useState<Order | null>(null);
  const [orderError, setOrderError] = useState<string | null>(null);
  const [retryCount, setRetryCount] = useState(0);
  const pollingRef = useRef<NodeJS.Timeout | null>(null);
  const hasCompletedRef = useRef(false);

  const cartId = searchParams.get('cart_id');
  const tradeNo = searchParams.get('MerchantTradeNo') || searchParams.get('trade_no');
  const rtnCode = searchParams.get('RtnCode');
  const rtnMsg = searchParams.get('RtnMsg');
  const tradeAmt = searchParams.get('TradeAmt');
  const paymentType = searchParams.get('PaymentType');
  const paymentMethodParam = searchParams.get('payment_method');

  useEffect(() => {
    if (rtnCode === '1') {
      setStatus('success');
      localStorage.removeItem('medusa_cart_id');
      if (cartId) startOrderFlow(cartId);
    } else if (rtnCode) {
      setStatus('failed');
    } else {
      // COD æˆ–å…¶ä»–ç„¡ rtnCode çš„æƒ…æ³
      setStatus('success');
      if (cartId) startOrderFlow(cartId);
    }

    return () => {
      if (pollingRef.current) clearTimeout(pollingRef.current);
    };
  }, [rtnCode, cartId]);

  /**
   * ä¸»æµç¨‹ï¼šå…ˆå˜—è©¦å‚™ç”¨ complete cartï¼Œå†æŸ¥ orderï¼ŒæŸ¥ä¸åˆ°å°± polling
   */
  async function startOrderFlow(cartId: string) {
    // æ­¥é©Ÿ 1ï¼šå‚™ç”¨ complete cartï¼ˆå†ªç­‰ï¼Œå·² complete ä¸æœƒé‡è¤‡ï¼‰
    if (!hasCompletedRef.current) {
      hasCompletedRef.current = true;
      try {
        await fetch('/api/cart/complete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cart_id: cartId }),
        });
      } catch (err) {
        // ä¸é˜»å¡ï¼ŒGateway webhook å¯èƒ½å·²ç¶“è™•ç†äº†
        console.log('[Complete] Backup complete attempt done');
      }
    }

    // æ­¥é©Ÿ 2ï¼šæŸ¥ order
    await fetchOrderWithRetry(cartId, 0);
  }

  /**
   * æŸ¥ orderï¼Œæ‰¾ä¸åˆ°å°±æ¯ 2 ç§’é‡è©¦ï¼Œæœ€å¤š 5 æ¬¡
   */
  async function fetchOrderWithRetry(cartId: string, attempt: number) {
    const MAX_RETRIES = 5;
    const RETRY_DELAY = 2000;

    try {
      const res = await fetch(`/api/order/${encodeURIComponent(cartId)}`);

      if (res.ok) {
        const data = await res.json();
        if (data.order) {
          console.log('[Order] Loaded on attempt', attempt + 1, ':', data.matched_by);
          setOrder(data.order);
          setRetryCount(0);
          return;
        }
      }

      // 404 æˆ–ç„¡ order â€” å¯èƒ½ Gateway webhook é‚„æ²’è™•ç†å®Œ
      if (attempt < MAX_RETRIES) {
        console.log(`[Order] Not found, retry ${attempt + 1}/${MAX_RETRIES} in ${RETRY_DELAY}ms...`);
        setRetryCount(attempt + 1);
        pollingRef.current = setTimeout(() => {
          fetchOrderWithRetry(cartId, attempt + 1);
        }, RETRY_DELAY);
      } else {
        console.warn('[Order] Max retries reached');
        setOrderError('è¨‚å–®è³‡æ–™è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œé‡æ–°æ•´ç†é é¢');
      }
    } catch (err) {
      console.error('[Order] Fetch error:', err);
      if (attempt < MAX_RETRIES) {
        pollingRef.current = setTimeout(() => {
          fetchOrderWithRetry(cartId, attempt + 1);
        }, RETRY_DELAY);
      } else {
        setOrderError('ç„¡æ³•è¼‰å…¥è¨‚å–®è©³æƒ…');
      }
    }
  }

  // === é¡¯ç¤ºè¼”åŠ©å‡½æ•¸ ===

  function formatPaymentType(type: string | null): string {
    if (paymentMethodParam === 'cod') return 'è²¨åˆ°ä»˜æ¬¾';
    if (!type) return 'ç·šä¸Šä»˜æ¬¾';
    const types: Record<string, string> = {
      'Credit_CreditCard': 'ä¿¡ç”¨å¡',
      'ATM_BOT': 'ATM è½‰å¸³',
      'ATM_CHINATRUST': 'ATM è½‰å¸³',
      'CVS_CVS': 'è¶…å•†ä»£ç¢¼',
      'BARCODE_BARCODE': 'è¶…å•†æ¢ç¢¼',
    };
    return types[type] || type;
  }

  function formatShippingMethod(order: Order): string {
    const name = order.shipping_methods?.[0]?.name || '';
    if (name.includes('å®…') || name.includes('home') || name.includes('Home')) return 'å®…é…åˆ°åºœ';
    if (name.includes('è¶…') || name.includes('CVS') || name.includes('cvs')) return 'è¶…å•†å–è²¨';

    const optionId = order.shipping_methods?.[0]?.shipping_option_id;
    if (optionId === 'so_01KGYTF42QQBBP9PNBPBZAZF73') return 'å®…é…åˆ°åºœ';
    if (optionId === 'so_01KGT10N7MH9ACTVKJE5G223G8') return 'è¶…å•†å–è²¨';

    const method = order.metadata?.shipping_method;
    if (method === 'home') return 'å®…é…åˆ°åºœ';
    if (method === 'cvs') return 'è¶…å•†å–è²¨';

    return 'æ¨™æº–é…é€';
  }

  // === æ¸²æŸ“ ===

  if (status === 'loading') {
    return (
      <div className="min-h-screen bg-white flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-400 mx-auto"></div>
          <p className="mt-4 text-gray-500">è™•ç†ä¸­...</p>
        </div>
      </div>
    );
  }

  if (status === 'failed') {
    return (
      <div className="min-h-screen bg-white py-16">
        <div className="container mx-auto px-4 text-center max-w-lg">
          <div className="w-20 h-20 mx-auto mb-6 rounded-full bg-red-100 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-10 h-10 text-red-500">
              <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </div>
          <h1 className="text-2xl font-bold text-gray-900 mb-4">ä»˜æ¬¾æœªæˆåŠŸ</h1>
          <p className="text-gray-600 mb-2">
            {rtnMsg || 'ä»˜æ¬¾éç¨‹ä¸­ç™¼ç”Ÿå•é¡Œï¼Œè«‹é‡æ–°å˜—è©¦'}
          </p>
          {tradeNo && (
            <p className="text-sm text-gray-500 mb-8">äº¤æ˜“ç·¨è™Ÿï¼š{tradeNo}</p>
          )}
          <div className="flex flex-col sm:flex-row gap-4 justify-center">
            <Link href="/checkout" className="inline-block px-6 py-3 bg-gray-900 text-white rounded-lg font-medium hover:bg-gray-800">
              é‡æ–°çµå¸³
            </Link>
            <Link href="/" className="inline-block px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50">
              è¿”å›é¦–é 
            </Link>
          </div>
        </div>
      </div>
    );
  }

  // === Success é é¢ ===
  // ä½¿ç”¨ order é ‚å±¤çš„æ­£ç¢ºé‡‘é¡æ¬„ä½ï¼ˆä¾†è‡ªå–®ç­† endpointï¼‰
  const subtotal = order?.item_subtotal ?? order?.subtotal ?? 0;
  const discountTotal = order?.discount_total ?? 0;
  const shippingFee = order?.shipping_total ?? 0;
  const creditsUsed = order?.metadata?.credits_used ?? 0;
  const total = order?.total ?? (tradeAmt ? parseInt(tradeAmt) : 0);
  const paidAmount = total - creditsUsed;

  return (
    <div className="min-h-screen bg-white py-8">
      <div className="container mx-auto px-4 max-w-2xl">
        {/* Success Header */}
        <div className="text-center mb-8">
          <div className="w-20 h-20 mx-auto mb-6 rounded-full flex items-center justify-center" style={{ backgroundColor: '#D1FAE5' }}>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2.5} stroke="#059669" className="w-10 h-10">
              <path strokeLinecap="round" strokeLinejoin="round" d="M4.5 12.75l6 6 9-13.5" />
            </svg>
          </div>
          <h1 className="text-2xl font-bold text-gray-900 mb-2">æ„Ÿè¬æ‚¨çš„è¨‚è³¼ï¼</h1>
          <p className="text-gray-600">æˆ‘å€‘å·²æ”¶åˆ°æ‚¨çš„è¨‚å–®ï¼Œå°‡ç›¡å¿«ç‚ºæ‚¨è™•ç†</p>
        </div>

        {/* Order Number */}
        <div className="rounded-lg p-6 mb-6 text-center" style={{ backgroundColor: '#F9FAFB', border: '1px solid #E5E7EB' }}>
          <p className="text-sm text-gray-500 mb-1">è¨‚å–®ç·¨è™Ÿ</p>
          {order ? (
            <p className="text-3xl font-bold" style={{ color: '#D4AF37' }}>#{order.display_id}</p>
          ) : tradeNo ? (
            <p className="text-lg font-mono font-bold text-gray-900">{tradeNo}</p>
          ) : (
            <p className="text-gray-400">è¼‰å…¥ä¸­...</p>
          )}
        </div>

        {/* Order Details */}
        {order && (
          <>
            {/* Items - ç›´æ¥ä½¿ç”¨ Medusa å›å‚³çš„ quantity å’Œ total */}
            <div className="rounded-lg p-6 mb-6" style={{ backgroundColor: '#F9FAFB', border: '1px solid #E5E7EB' }}>
              <h2 className="font-bold text-gray-900 mb-4">å•†å“æ˜ç´°</h2>
              <ul className="divide-y divide-gray-200">
                {order.items?.map((item: any, idx: number) => (
                  <li key={item.id || idx} className="py-3 flex justify-between items-center">
                    <div className="flex items-center gap-3 flex-1 min-w-0">
                      <span className="text-gray-700 truncate">{item.title || item.product_title || 'å•†å“'}</span>
                      <span className="text-sm text-gray-500 flex-shrink-0">x{item.quantity ?? 1}</span>
                    </div>
                    <span className="font-medium text-gray-900 flex-shrink-0 ml-4">
                      {formatPrice(item.subtotal ?? item.unit_price ?? 0)}
                    </span>
                  </li>
                ))}
              </ul>

              {/* Totals */}
              <div className="border-t border-gray-200 mt-4 pt-4 space-y-2">
                <div className="flex justify-between text-sm">
                  <span className="text-gray-500">å°è¨ˆ</span>
                  <span className="text-gray-900">{formatPrice(subtotal)}</span>
                </div>
                {discountTotal > 0 && (
                  <div className="flex justify-between text-sm">
                    <span style={{ color: '#DC2626' }}>æŠ˜æ‰£</span>
                    <span style={{ color: '#DC2626' }}>-{formatPrice(discountTotal)}</span>
                  </div>
                )}
                <div className="flex justify-between text-sm">
                  <span className="text-gray-500">é‹è²»</span>
                  <span className="text-gray-900">{shippingFee === 0 ? 'å…é‹' : formatPrice(shippingFee)}</span>
                </div>
                {creditsUsed > 0 && (
                  <div className="flex justify-between text-sm">
                    <span style={{ color: '#D4AF37' }}>è³¼ç‰©é‡‘æŠ˜æŠµ</span>
                    <span style={{ color: '#D4AF37' }}>-{formatPrice(creditsUsed)}</span>
                  </div>
                )}
                <div className="flex justify-between font-bold text-lg pt-2 border-t border-gray-200">
                  <span className="text-gray-900">åˆè¨ˆ</span>
                  <span style={{ color: '#D4AF37' }}>{formatPrice(paidAmount)}</span>
                </div>
              </div>
            </div>

            {/* Shipping Info */}
            <div className="rounded-lg p-6 mb-6" style={{ backgroundColor: '#F9FAFB', border: '1px solid #E5E7EB' }}>
              <h2 className="font-bold text-gray-900 mb-4">é…é€è³‡è¨Š</h2>
              <div className="space-y-2 text-sm">
                <div className="flex justify-between">
                  <span className="text-gray-500">é…é€æ–¹å¼</span>
                  <span className="text-gray-900">{formatShippingMethod(order)}</span>
                </div>
                {order.metadata?.cvs_store_name && (
                  <>
                    <div className="flex justify-between">
                      <span className="text-gray-500">å–è²¨é–€å¸‚</span>
                      <span className="text-gray-900">{order.metadata.cvs_store_name}</span>
                    </div>
                    {order.metadata.cvs_address && (
                      <div className="flex justify-between">
                        <span className="text-gray-500">é–€å¸‚åœ°å€</span>
                        <span className="text-gray-900 text-right max-w-[200px]">{order.metadata.cvs_address}</span>
                      </div>
                    )}
                  </>
                )}
                {order.shipping_address && !order.metadata?.cvs_store_name && (
                  <div className="flex justify-between">
                    <span className="text-gray-500">é…é€åœ°å€</span>
                    <span className="text-gray-900 text-right max-w-[200px]">
                      {order.shipping_address.postal_code} {order.shipping_address.city} {order.shipping_address.address_1}
                    </span>
                  </div>
                )}
                <div className="flex justify-between">
                  <span className="text-gray-500">æ”¶ä»¶äºº</span>
                  <span className="text-gray-900">
                    {order.shipping_address?.last_name?.trim()}{order.shipping_address?.first_name}
                  </span>
                </div>
                {order.shipping_address?.phone && (
                  <div className="flex justify-between">
                    <span className="text-gray-500">è¯çµ¡é›»è©±</span>
                    <span className="text-gray-900">{order.shipping_address.phone}</span>
                  </div>
                )}
              </div>
            </div>

            {/* Payment Info */}
            <div className="rounded-lg p-6 mb-6" style={{ backgroundColor: '#F9FAFB', border: '1px solid #E5E7EB' }}>
              <h2 className="font-bold text-gray-900 mb-4">ä»˜æ¬¾è³‡è¨Š</h2>
              <div className="space-y-2 text-sm">
                <div className="flex justify-between">
                  <span className="text-gray-500">ä»˜æ¬¾æ–¹å¼</span>
                  <span className="text-gray-900">{formatPaymentType(paymentType)}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-500">ä»˜æ¬¾é‡‘é¡</span>
                  <span className="font-bold" style={{ color: '#DC2626' }}>
                    {formatPrice(paidAmount)}
                  </span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-500">ä»˜æ¬¾ç‹€æ…‹</span>
                  {paymentMethodParam === 'cod' ? (
                    <span className="font-medium" style={{ color: '#D97706' }}>å¾…ä»˜æ¬¾ - è²¨åˆ°ä»˜æ¬¾</span>
                  ) : (
                    <span className="font-medium" style={{ color: '#059669' }}>å·²ä»˜æ¬¾</span>
                  )}
                </div>
              </div>
            </div>

            {/* Next Steps */}
            <div className="rounded-lg p-4 mb-6" style={{ backgroundColor: '#FFFBEB', border: '1px solid #FDE68A' }}>
              <h3 className="font-bold text-amber-800 mb-2">æ¥ä¸‹ä¾†...</h3>
              <ul className="text-sm text-amber-700 space-y-1">
                <li>1. æˆ‘å€‘å°‡æ–¼ 1-2 å€‹å·¥ä½œå¤©å…§ç‚ºæ‚¨å‡ºè²¨</li>
                <li>2. å‡ºè²¨å¾Œå°‡é€é LINE é€šçŸ¥æ‚¨å‡ºè²¨è³‡è¨Š</li>
                <li>3. {formatShippingMethod(order).includes('è¶…å•†') ? 'è¶…å•†å–è²¨ç´„ 2-3 å€‹å·¥ä½œå¤©' : 'å®…é…ç´„ 1-2 å¤©é€é”'}</li>
              </ul>
            </div>
          </>
        )}

        {/* Loading order with retry indicator */}
        {!order && !orderError && cartId && (
          <div className="rounded-lg p-6 mb-6 text-center" style={{ backgroundColor: '#F9FAFB', border: '1px solid #E5E7EB' }}>
            <div className="animate-pulse">
              <div className="h-4 bg-gray-200 rounded w-3/4 mx-auto mb-2"></div>
              <div className="h-4 bg-gray-200 rounded w-1/2 mx-auto"></div>
            </div>
            <p className="text-sm text-gray-500 mt-2">
              {retryCount > 0 ? `æ­£åœ¨è¼‰å…¥è¨‚å–®è©³æƒ…ï¼ˆç¬¬ ${retryCount} æ¬¡å˜—è©¦ï¼‰...` : 'æ­£åœ¨è¼‰å…¥è¨‚å–®è©³æƒ…...'}
            </p>
          </div>
        )}

        {/* Error state */}
        {orderError && (
          <div className="rounded-lg p-6 mb-6 text-center" style={{ backgroundColor: '#FEF2F2', border: '1px solid #FECACA' }}>
            <p className="text-sm text-red-600 mb-2">{orderError}</p>
            <button
              onClick={() => {
                setOrderError(null);
                if (cartId) fetchOrderWithRetry(cartId, 0);
              }}
              className="text-sm text-red-700 underline hover:no-underline"
            >
              é‡æ–°è¼‰å…¥
            </button>
          </div>
        )}

        {/* Fallback for old redirects without cart_id */}
        {!order && !cartId && (
          <div className="rounded-lg p-6 mb-6" style={{ backgroundColor: '#FFFBEB', border: '1px solid #FDE68A' }}>
            <h3 className="font-bold text-amber-800 mb-3">æ¥ä¸‹ä¾†æ‚¨å°‡æœƒæ”¶åˆ°é€šçŸ¥</h3>
            <ul className="text-sm text-amber-700 space-y-2">
              <li className="flex items-start gap-2">
                <span>1.</span>
                <span>æˆ‘å€‘å°‡æ–¼ 1-2 å€‹å·¥ä½œå¤©å…§ç‚ºæ‚¨å‡ºè²¨</span>
              </li>
              <li className="flex items-start gap-2">
                <span>2.</span>
                <span>å‡ºè²¨å¾Œå°‡é€éç°¡è¨Š/Email é€šçŸ¥</span>
              </li>
              <li className="flex items-start gap-2">
                <span>3.</span>
                <span>è¶…å•†å–è²¨ç´„ 2-3 å€‹å·¥ä½œå¤©ï¼Œå®…é…ç´„ 1-2 å¤©</span>
              </li>
            </ul>
          </div>
        )}

        {/* Actions */}
        <div className="flex flex-col sm:flex-row gap-4 justify-center">
          <Link
            href="/products"
            className="inline-block text-center py-3 px-8 rounded-lg font-medium text-white"
            style={{ backgroundColor: '#D4AF37' }}
          >
            ç¹¼çºŒè³¼ç‰©
          </Link>
          <Link
            href="https://lin.ee/Ro3Fd4p"
            target="_blank"
            className="inline-block text-center py-3 px-8 rounded-lg font-medium text-white"
            style={{ backgroundColor: '#06C755' }}
          >
            åŠ  LINE è¿½è¹¤è¨‚å–®
          </Link>
        </div>
      </div>
    </div>
  );
}

function LoadingFallback() {
  return (
    <div className="min-h-screen bg-white flex items-center justify-center">
      <div className="text-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-300 mx-auto"></div>
        <p className="mt-4 text-gray-500">è¼‰å…¥ä¸­...</p>
      </div>
    </div>
  );
}

export default function CheckoutCompletePage() {
  return (
    <Suspense fallback={<LoadingFallback />}>
      <CheckoutCompleteContent />
    </Suspense>
  );
}


=== tailwind.config.js ===
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    './app/**/*.{js,ts,jsx,tsx,mdx}',
    './components/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
    extend: {
      colors: {
        // å¯é€é CSS è®Šæ•¸è¦†å¯«
        primary: 'var(--color-primary, #000000)',
        secondary: 'var(--color-secondary, #f5f5f5)',
        accent: 'var(--color-accent, #dc2626)',
        // é»‘é‡‘ä¸»é¡Œè‰²ç³»
        gold: {
          DEFAULT: '#D4AF37',
          light: '#FFD700',
          dark: '#B8962E',
        },
        'line-green': '#06C755',
      },
      fontFamily: {
        sans: ['var(--font-family)', 'system-ui', '-apple-system', 'sans-serif'],
      },
      borderRadius: {
        DEFAULT: 'var(--border-radius, 0.5rem)',
      },
    },
  },
  plugins: [],
};
