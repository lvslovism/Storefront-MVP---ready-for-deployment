This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.claude/settings.local.json
.gitignore
app/checkout/complete/page.tsx
app/checkout/page.tsx
app/layout.tsx
app/page.tsx
app/products/[handle]/page.tsx
CLAUDE.md
components/CartDrawer.tsx
components/CartProvider.tsx
components/Footer.tsx
components/Header.tsx
components/ProductCard.tsx
components/ProductDetail.tsx
config/store.json
lib/config.ts
lib/gateway.ts
lib/medusa.ts
next.config.js
nul
package.json
postcss.config.js
README.md
styles/globals.css
tailwind.config.js
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".claude/settings.local.json">
{
  "permissions": {
    "allow": [
      "Bash(npx repomix:*)"
    ]
  }
}
</file>

<file path="CLAUDE.md">
# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commands

```bash
npm run dev      # Start development server (localhost:3000)
npm run build    # Production build
npm run start    # Start production server
npm run lint     # Run ESLint
```

No test framework is configured.

## Architecture

This is a **headless e-commerce storefront** built with Next.js 14 (App Router) that connects to:
- **Medusa v2.x** - Product catalog and cart management
- **ECPay Gateway** - Payment processing and logistics (Taiwan-focused)

### Key Directories

- `app/` - Next.js pages using App Router
- `components/` - React components (CartProvider manages global cart state via Context API)
- `lib/` - API clients and utilities
  - `medusa.ts` - Medusa API client (products, cart operations)
  - `gateway.ts` - ECPay payment/logistics client
  - `config.ts` - Configuration loader with typed `StoreConfig` interface
- `config/store.json` - **Single configuration file** for all store settings

### Page Rendering Strategy

- Homepage (`app/page.tsx`): Server-side with ISR (1-hour revalidation)
- Product pages (`app/products/[handle]/`): Static generation via `generateStaticParams()`
- Checkout (`app/checkout/`): Client-side only (`'use client'`)

### State Management

Cart state uses React Context (`CartProvider.tsx`) with localStorage persistence (`medusa_cart_id` key). The cart auto-initializes on app load.

### Styling

Tailwind CSS with CSS variables for theming. Theme colors are injected at runtime in the root layout from `config/store.json`. Custom component classes (`.btn`, `.input`, `.card`, etc.) are defined in `styles/globals.css`.

## Configuration

All customization happens in `config/store.json`:
- Store info (name, domain, logo)
- Theme colors (primary, secondary, accent)
- Medusa connection (backendUrl, publishableKey, regionId, salesChannelId)
- ECPay gateway credentials
- Feature flags (cart, checkout, cvsLogistics, homeDelivery)
- Shipping config (free threshold, CVS/home delivery fees)

Store assets (logo, favicon) go in `public/tenant/`.

## Taiwan-Specific Features

- CVS logistics integration (7-ELEVEN, FamilyMart, Hi-Life)
- CVS store picker uses popup window with polling for selection
- Currency: TWD with `Intl.NumberFormat` formatting
- Primary language: Traditional Chinese (zh-TW)
</file>

<file path="nul">

</file>

<file path=".gitignore">
# Dependencies
node_modules/
.pnp
.pnp.js

# Build
.next/
out/
build/
dist/

# Testing
coverage/

# Misc
.DS_Store
*.pem

# Debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# Local env files
.env
.env.local
.env.development.local
.env.test.local
.env.production.local

# Vercel
.vercel

# TypeScript
*.tsbuildinfo
next-env.d.ts

# IDE
.idea/
.vscode/
*.swp
*.swo
</file>

<file path="app/checkout/complete/page.tsx">
'use client';

import { useEffect, useState, Suspense } from 'react';
import Link from 'next/link';
import { useSearchParams } from 'next/navigation';
import { config } from '@/lib/config';

function CheckoutCompleteContent() {
  const searchParams = useSearchParams();
  const [status, setStatus] = useState<'loading' | 'success' | 'failed'>('loading');
  
  // å¾ URL å–å¾—åƒæ•¸
  const tradeNo = searchParams.get('MerchantTradeNo') || searchParams.get('trade_no');
  const rtnCode = searchParams.get('RtnCode');
  const rtnMsg = searchParams.get('RtnMsg');

  useEffect(() => {
    // åˆ¤æ–·ä»˜æ¬¾çµæœ
    if (rtnCode === '1') {
      setStatus('success');
      // æ¸…é™¤è³¼ç‰©è»Š localStorage
      localStorage.removeItem('medusa_cart_id');
    } else if (rtnCode) {
      setStatus('failed');
    } else {
      // æ²’æœ‰å›å‚³åƒæ•¸ï¼Œå¯èƒ½æ˜¯ç›´æ¥è¨ªå•
      setStatus('success');
    }
  }, [rtnCode]);

  if (status === 'loading') {
    return (
      <div className="container mx-auto px-4 py-16 text-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto"></div>
        <p className="mt-4 text-gray-500">è™•ç†ä¸­...</p>
      </div>
    );
  }

  if (status === 'failed') {
    return (
      <div className="container mx-auto px-4 py-16 text-center max-w-lg">
        <div className="w-20 h-20 mx-auto mb-6 rounded-full bg-red-100 flex items-center justify-center">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            strokeWidth={2}
            stroke="currentColor"
            className="w-10 h-10 text-red-500"
          >
            <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </div>
        <h1 className="text-2xl font-bold mb-4">ä»˜æ¬¾å¤±æ•—</h1>
        <p className="text-gray-600 mb-2">
          {rtnMsg || 'ä»˜æ¬¾éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦'}
        </p>
        {tradeNo && (
          <p className="text-sm text-gray-500 mb-8">
            è¨‚å–®ç·¨è™Ÿï¼š{tradeNo}
          </p>
        )}
        <div className="flex flex-col sm:flex-row gap-4 justify-center">
          <Link href="/checkout" className="btn-primary">
            é‡æ–°çµå¸³
          </Link>
          <Link href="/" className="btn-outline">
            è¿”å›å•†åº—
          </Link>
        </div>
      </div>
    );
  }

  // ä»˜æ¬¾æˆåŠŸ
  return (
    <div className="container mx-auto px-4 py-16 text-center max-w-lg">
      <div className="w-20 h-20 mx-auto mb-6 rounded-full bg-green-100 flex items-center justify-center">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          strokeWidth={2}
          stroke="currentColor"
          className="w-10 h-10 text-green-500"
        >
          <path strokeLinecap="round" strokeLinejoin="round" d="M4.5 12.75l6 6 9-13.5" />
        </svg>
      </div>
      
      <h1 className="text-2xl font-bold mb-4">æ„Ÿè¬æ‚¨çš„è¨‚è³¼ï¼</h1>
      <p className="text-gray-600 mb-2">
        è¨‚å–®å·²æˆåŠŸå»ºç«‹ï¼Œæˆ‘å€‘æœƒç›¡å¿«ç‚ºæ‚¨è™•ç†ã€‚
      </p>
      
      {tradeNo && (
        <div className="bg-gray-50 rounded-lg p-4 my-6">
          <p className="text-sm text-gray-500">è¨‚å–®ç·¨è™Ÿ</p>
          <p className="text-lg font-mono font-bold">{tradeNo}</p>
        </div>
      )}

      <div className="space-y-3 text-left bg-gray-50 rounded-lg p-4 my-6">
        <h3 className="font-bold">æ¥ä¸‹ä¾†æœƒç™¼ç”Ÿä»€éº¼ï¼Ÿ</h3>
        <ul className="text-sm text-gray-600 space-y-2">
          <li className="flex items-start gap-2">
            <span>1ï¸âƒ£</span>
            <span>æˆ‘å€‘æœƒåœ¨ 1-2 å€‹å·¥ä½œå¤©å…§è™•ç†æ‚¨çš„è¨‚å–®</span>
          </li>
          <li className="flex items-start gap-2">
            <span>2ï¸âƒ£</span>
            <span>å‡ºè²¨å¾Œæœƒé€éç°¡è¨Š/Email é€šçŸ¥æ‚¨</span>
          </li>
          <li className="flex items-start gap-2">
            <span>3ï¸âƒ£</span>
            <span>è¶…å•†å–è²¨é è¨ˆ 2-3 å¤©åˆ°è²¨ï¼Œå®…é…é è¨ˆ 1-2 å¤©</span>
          </li>
        </ul>
      </div>

      <div className="flex flex-col sm:flex-row gap-4 justify-center">
        <Link href="/" className="btn-primary">
          ç¹¼çºŒè³¼ç‰©
        </Link>
      </div>
    </div>
  );
}

// Loading fallback
function LoadingFallback() {
  return (
    <div className="container mx-auto px-4 py-16 text-center">
      <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-300 mx-auto"></div>
      <p className="mt-4 text-gray-500">è¼‰å…¥ä¸­...</p>
    </div>
  );
}

// ä¸»å…ƒä»¶åŒ… Suspense
export default function CheckoutCompletePage() {
  return (
    <Suspense fallback={<LoadingFallback />}>
      <CheckoutCompleteContent />
    </Suspense>
  );
}
</file>

<file path="app/checkout/page.tsx">
'use client';

import { useState, useEffect, useRef } from 'react';
import { useRouter } from 'next/navigation';
import Image from 'next/image';
import Link from 'next/link';
import { useCart } from '@/components/CartProvider';
import { formatPrice, config, shipping, isFreeShipping, getShippingFee } from '@/lib/config';
import { createCheckout, getCvsMap, getCvsSelection, CVS_NAMES, CvsSelection } from '@/lib/gateway';

type ShippingMethod = 'cvs' | 'home';
type CvsType = 'UNIMARTC2C' | 'FAMIC2C' | 'HILIFEC2C';

interface FormData {
  name: string;
  phone: string;
  email: string;
  // å®…é…
  address: string;
  city: string;
  zipCode: string;
  // è¶…å–
  cvsType: CvsType;
}

export default function CheckoutPage() {
  const router = useRouter();
  const { cart, isLoading: cartLoading } = useCart();

  const [shippingMethod, setShippingMethod] = useState<ShippingMethod>('cvs');
  const [formData, setFormData] = useState<FormData>({
    name: '',
    phone: '',
    email: '',
    address: '',
    city: '',
    zipCode: '',
    cvsType: 'UNIMARTC2C',
  });
  const [cvsSelection, setCvsSelection] = useState<CvsSelection | null>(null);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isSelectingStore, setIsSelectingStore] = useState(false);
  const [error, setError] = useState<string | null>(null);
  
  // ç”¨æ–¼æ¸…ç† interval
  const pollingRef = useRef<NodeJS.Timeout | null>(null);

  // è¨ˆç®—é‡‘é¡
  const subtotal = cart?.subtotal || 0;
  const shippingFee = getShippingFee(shippingMethod, subtotal);
  const total = subtotal + shippingFee;

  // æ¸…ç† polling
  useEffect(() => {
    return () => {
      if (pollingRef.current) {
        clearInterval(pollingRef.current);
      }
    };
  }, []);

  // æ›´æ–°è¡¨å–®
  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
    const { name, value } = e.target;
    setFormData((prev) => ({ ...prev, [name]: value }));
  };

  // é–‹å•Ÿè¶…å•†åœ°åœ–ï¼ˆPopup æ–¹å¼ï¼‰
  const handleOpenCvsMap = async () => {
    try {
      setError(null);
      setIsSelectingStore(true);
      
      const res = await getCvsMap({
        cvs_type: formData.cvsType,
      });
      
      if (res.success && res.map_url) {
        const tempTradeNo = res.temp_trade_no;
        
        // ç”¨ popup é–‹å•Ÿåœ°åœ–ï¼ˆä¸é›¢é–‹çµå¸³é é¢ï¼‰
        const mapWindow = window.open(
          res.map_url, 
          'cvsMap', 
          'width=900,height=700,scrollbars=yes,resizable=yes'
        );
        
        // æ¸…é™¤ä¹‹å‰çš„ polling
        if (pollingRef.current) {
          clearInterval(pollingRef.current);
        }
        
        // æ¯ 2 ç§’æª¢æŸ¥æ˜¯å¦é¸å®Œé–€å¸‚
        pollingRef.current = setInterval(async () => {
          try {
            // æª¢æŸ¥è¦–çª—æ˜¯å¦è¢«é—œé–‰
            if (mapWindow?.closed) {
              clearInterval(pollingRef.current!);
              pollingRef.current = null;
              setIsSelectingStore(false);
              return;
            }
            
            const selection = await getCvsSelection(tempTradeNo);
console.log('Polling result:', selection);  // åŠ é€™è¡Œ
if (selection.success && selection.selection?.store_id) {
              // é¸å®Œäº†ï¼
              clearInterval(pollingRef.current!);
              pollingRef.current = null;
              mapWindow?.close();
              
              setCvsSelection(selection.selection);
              setIsSelectingStore(false);
            }
          } catch (e) {
            // é‚„æ²’é¸å®Œï¼Œç¹¼çºŒç­‰
          }
        }, 2000);
        
        // 60 ç§’å¾Œåœæ­¢æª¢æŸ¥ï¼ˆtimeoutï¼‰
        setTimeout(() => {
          if (pollingRef.current) {
            clearInterval(pollingRef.current);
            pollingRef.current = null;
            setIsSelectingStore(false);
          }
        }, 60000);
        
      } else {
        setError('é–‹å•Ÿè¶…å•†åœ°åœ–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        setIsSelectingStore(false);
      }
    } catch (err) {
      setError('é–‹å•Ÿè¶…å•†åœ°åœ–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      setIsSelectingStore(false);
      console.error(err);
    }
  };

  // é©—è­‰è¡¨å–®
  const validateForm = (): boolean => {
    if (!formData.name.trim()) {
      setError('è«‹è¼¸å…¥æ”¶ä»¶äººå§“å');
      return false;
    }
    if (!formData.phone.trim() || !/^09\d{8}$/.test(formData.phone)) {
      setError('è«‹è¼¸å…¥æ­£ç¢ºçš„æ‰‹æ©Ÿè™Ÿç¢¼ï¼ˆ09é–‹é ­ï¼Œ10ç¢¼ï¼‰');
      return false;
    }
    if (formData.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) {
      setError('è«‹è¼¸å…¥æ­£ç¢ºçš„ Email æ ¼å¼');
      return false;
    }
    
    if (shippingMethod === 'cvs') {
      if (!cvsSelection) {
        setError('è«‹é¸æ“‡å–è²¨é–€å¸‚');
        return false;
      }
    } else {
      if (!formData.address.trim()) {
        setError('è«‹è¼¸å…¥æ”¶ä»¶åœ°å€');
        return false;
      }
    }
    
    return true;
  };

  // æäº¤çµå¸³
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!cart?.items?.length) {
      setError('è³¼ç‰©è»Šæ˜¯ç©ºçš„');
      return;
    }

    if (!validateForm()) return;

    try {
      setIsSubmitting(true);
      setError(null);

      // çµ„åˆå•†å“åç¨±
      const itemName = cart.items
        .map((item) => `${item.title} x${item.quantity}`)
        .join(', ')
        .slice(0, 200); // ECPay é™åˆ¶ 200 å­—å…ƒ

      // å»ºç«‹ä»˜æ¬¾
      const res = await createCheckout({
        amount: total,
        item_name: itemName,
        order_id: `cart_${cart.id}`,
        customer_name: formData.name,
        customer_phone: formData.phone,
        customer_email: formData.email || undefined,
        return_url: `${window.location.origin}/checkout/complete`,
        metadata: {
          cart_id: cart.id,
          shipping_method: shippingMethod,
          shipping_fee: shippingFee,
          // è¶…å–è³‡è¨Š
          ...(shippingMethod === 'cvs' && cvsSelection && {
  cvs_type: formData.cvsType,
  cvs_store_id: cvsSelection.store_id,
  cvs_store_name: cvsSelection.store_name,
  cvs_address: cvsSelection.address,
}),
          // å®…é…è³‡è¨Š
          ...(shippingMethod === 'home' && {
            address: formData.address,
            city: formData.city,
            zip_code: formData.zipCode,
          }),
        },
      });

      if (res.success && res.checkout_url) {
        // è·³è½‰åˆ°ç¶ ç•Œä»˜æ¬¾
        window.location.href = res.checkout_url;
      } else {
        setError('å»ºç«‹è¨‚å–®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    } catch (err: any) {
      setError(err.message || 'çµå¸³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      console.error(err);
    } finally {
      setIsSubmitting(false);
    }
  };

  // è³¼ç‰©è»Šç‚ºç©º
  if (!cartLoading && (!cart?.items?.length)) {
    return (
      <div className="container mx-auto px-4 py-16 text-center">
        <h1 className="text-2xl font-bold mb-4">è³¼ç‰©è»Šæ˜¯ç©ºçš„</h1>
        <p className="text-gray-500 mb-8">å…ˆå»é€›é€›å§ï¼</p>
        <Link href="/" className="btn-primary">
          è¿”å›å•†åº—
        </Link>
      </div>
    );
  }

  return (
    <div className="container mx-auto px-4 py-8">
      <h1 className="text-2xl font-bold mb-8">çµå¸³</h1>

      <div className="grid lg:grid-cols-3 gap-8">
        {/* å·¦å´ï¼šè¡¨å–® */}
        <div className="lg:col-span-2">
          <form onSubmit={handleSubmit} className="space-y-8">
            {/* æ”¶ä»¶äººè³‡è¨Š */}
            <section className="card p-6">
              <h2 className="text-lg font-bold mb-4">æ”¶ä»¶äººè³‡è¨Š</h2>
              <div className="grid gap-4">
                <div>
                  <label className="block text-sm font-medium mb-1">
                    å§“å <span className="text-red-500">*</span>
                  </label>
                  <input
                    type="text"
                    name="name"
                    value={formData.name}
                    onChange={handleChange}
                    className="input"
                    placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å"
                    required
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">
                    æ‰‹æ©Ÿ <span className="text-red-500">*</span>
                  </label>
                  <input
                    type="tel"
                    name="phone"
                    value={formData.phone}
                    onChange={handleChange}
                    className="input"
                    placeholder="0912345678"
                    pattern="09\d{8}"
                    required
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Email</label>
                  <input
                    type="email"
                    name="email"
                    value={formData.email}
                    onChange={handleChange}
                    className="input"
                    placeholder="é¸å¡«ï¼Œç”¨æ–¼å¯„é€è¨‚å–®é€šçŸ¥"
                  />
                </div>
              </div>
            </section>

            {/* ç‰©æµæ–¹å¼ */}
            <section className="card p-6">
              <h2 className="text-lg font-bold mb-4">ç‰©æµæ–¹å¼</h2>
              
              {/* ç‰©æµé¸é … */}
              <div className="flex gap-4 mb-6">
                {config.features.cvsLogistics && (
                  <button
                    type="button"
                    onClick={() => setShippingMethod('cvs')}
                    className={`flex-1 p-4 border rounded-lg text-center transition-colors ${
                      shippingMethod === 'cvs'
                        ? 'border-primary bg-primary/5'
                        : 'border-gray-200 hover:border-gray-300'
                    }`}
                  >
                    <span className="block text-2xl mb-1">ğŸª</span>
                    <span className="font-medium">è¶…å•†å–è²¨</span>
                    <span className="block text-sm text-gray-500 mt-1">
                      {isFreeShipping(subtotal) ? 'å…é‹' : `${formatPrice(shipping.cvsFee)}`}
                    </span>
                  </button>
                )}
                {config.features.homeDelivery && (
                  <button
                    type="button"
                    onClick={() => setShippingMethod('home')}
                    className={`flex-1 p-4 border rounded-lg text-center transition-colors ${
                      shippingMethod === 'home'
                        ? 'border-primary bg-primary/5'
                        : 'border-gray-200 hover:border-gray-300'
                    }`}
                  >
                    <span className="block text-2xl mb-1">ğŸšš</span>
                    <span className="font-medium">å®…é…åˆ°åºœ</span>
                    <span className="block text-sm text-gray-500 mt-1">
                      {isFreeShipping(subtotal) ? 'å…é‹' : `${formatPrice(shipping.homeDeliveryFee)}`}
                    </span>
                  </button>
                )}
              </div>

              {/* è¶…å•†å–è²¨ */}
              {shippingMethod === 'cvs' && (
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">é¸æ“‡è¶…å•†</label>
                    <div className="flex gap-2">
                      {shipping.cvsOptions.map((cvs) => (
                        <button
                          key={cvs}
                          type="button"
                          onClick={() => {
                            setFormData((prev) => ({ ...prev, cvsType: cvs as CvsType }));
                            setCvsSelection(null); // æ¸…é™¤ä¹‹å‰çš„é¸æ“‡
                          }}
                          className={`px-4 py-2 border rounded-lg transition-colors ${
                            formData.cvsType === cvs
                              ? 'border-primary bg-primary text-white'
                              : 'border-gray-200 hover:border-gray-300'
                          }`}
                        >
                          {CVS_NAMES[cvs]}
                        </button>
                      ))}
                    </div>
                  </div>

                  {/* é¸æ“‡é–€å¸‚æŒ‰éˆ• */}
                  <div>
                    {cvsSelection ? (
                      <div className="p-4 bg-green-50 border border-green-200 rounded-lg">
                        <div className="flex items-start justify-between">
                          <div>
                            <p className="font-medium text-green-800">
  âœ… {cvsSelection.store_name}
</p>
<p className="text-sm text-green-600 mt-1">
  {cvsSelection.address}
</p>
                          </div>
                          <button
                            type="button"
                            onClick={handleOpenCvsMap}
                            disabled={isSelectingStore}
                            className="text-sm text-green-700 underline disabled:opacity-50"
                          >
                            é‡æ–°é¸æ“‡
                          </button>
                        </div>
                      </div>
                    ) : (
                      <button
                        type="button"
                        onClick={handleOpenCvsMap}
                        disabled={isSelectingStore}
                        className="btn-outline w-full disabled:opacity-50"
                      >
                        {isSelectingStore ? (
                          <>
                            <span className="inline-block animate-spin mr-2">â³</span>
                            é¸æ“‡é–€å¸‚ä¸­...ï¼ˆè«‹åœ¨å½ˆå‡ºè¦–çª—å®Œæˆé¸æ“‡ï¼‰
                          </>
                        ) : (
                          'ğŸ—ºï¸ é¸æ“‡å–è²¨é–€å¸‚'
                        )}
                      </button>
                    )}
                  </div>
                </div>
              )}

              {/* å®…é… */}
              {shippingMethod === 'home' && (
                <div className="grid gap-4">
                  <div className="grid grid-cols-3 gap-4">
                    <div>
                      <label className="block text-sm font-medium mb-1">éƒµéå€è™Ÿ</label>
                      <input
                        type="text"
                        name="zipCode"
                        value={formData.zipCode}
                        onChange={handleChange}
                        className="input"
                        placeholder="100"
                      />
                    </div>
                    <div className="col-span-2">
                      <label className="block text-sm font-medium mb-1">ç¸£å¸‚</label>
                      <input
                        type="text"
                        name="city"
                        value={formData.city}
                        onChange={handleChange}
                        className="input"
                        placeholder="å°åŒ—å¸‚"
                      />
                    </div>
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">
                      åœ°å€ <span className="text-red-500">*</span>
                    </label>
                    <input
                      type="text"
                      name="address"
                      value={formData.address}
                      onChange={handleChange}
                      className="input"
                      placeholder="è«‹è¼¸å…¥å®Œæ•´åœ°å€"
                      required={shippingMethod === 'home'}
                    />
                  </div>
                </div>
              )}
            </section>

            {/* éŒ¯èª¤è¨Šæ¯ */}
            {error && (
              <div className="p-4 bg-red-50 border border-red-200 rounded-lg text-red-700">
                {error}
              </div>
            )}

            {/* æäº¤æŒ‰éˆ•ï¼ˆæ‰‹æ©Ÿç‰ˆï¼‰ */}
            <div className="lg:hidden">
              <button
                type="submit"
                disabled={isSubmitting || cartLoading}
                className="btn-primary w-full py-4 text-lg disabled:opacity-50"
              >
                {isSubmitting ? 'è™•ç†ä¸­...' : `å‰å¾€ä»˜æ¬¾ ${formatPrice(total)}`}
              </button>
            </div>
          </form>
        </div>

        {/* å³å´ï¼šè¨‚å–®æ‘˜è¦ */}
        <div className="lg:col-span-1">
          <div className="card p-6 sticky top-24">
            <h2 className="text-lg font-bold mb-4">è¨‚å–®æ‘˜è¦</h2>

            {/* å•†å“åˆ—è¡¨ */}
            <ul className="divide-y mb-4">
              {cart?.items?.map((item) => (
                <li key={item.id} className="py-3 flex gap-3">
                  <div className="w-16 h-16 bg-gray-100 rounded overflow-hidden flex-shrink-0">
                    {item.thumbnail && (
                      <Image
                        src={item.thumbnail}
                        alt={item.title}
                        width={64}
                        height={64}
                        className="w-full h-full object-cover"
                      />
                    )}
                  </div>
                  <div className="flex-grow min-w-0">
                    <p className="text-sm font-medium truncate">{item.title}</p>
                    <p className="text-xs text-gray-500">x{item.quantity}</p>
                    <p className="text-sm font-bold">{formatPrice(item.subtotal)}</p>
                  </div>
                </li>
              ))}
            </ul>

            {/* é‡‘é¡æ˜ç´° */}
            <div className="space-y-2 text-sm border-t pt-4">
              <div className="flex justify-between">
                <span>å•†å“å°è¨ˆ</span>
                <span>{formatPrice(subtotal)}</span>
              </div>
              <div className="flex justify-between">
                <span>é‹è²»</span>
                <span>
                  {shippingFee === 0 ? (
                    <span className="text-green-600">å…é‹</span>
                  ) : (
                    formatPrice(shippingFee)
                  )}
                </span>
              </div>
              <div className="flex justify-between text-lg font-bold border-t pt-2">
                <span>ç¸½è¨ˆ</span>
                <span className="text-accent">{formatPrice(total)}</span>
              </div>
            </div>

            {/* å…é‹æç¤º */}
            {!isFreeShipping(subtotal) && (
              <p className="text-xs text-gray-500 mt-4">
                å†è²· {formatPrice(shipping.freeShippingThreshold - subtotal)} å³å¯å…é‹
              </p>
            )}

            {/* æäº¤æŒ‰éˆ•ï¼ˆæ¡Œé¢ç‰ˆï¼‰ */}
            <button
              type="submit"
              form="checkout-form"
              onClick={handleSubmit}
              disabled={isSubmitting || cartLoading}
              className="btn-primary w-full py-3 mt-6 hidden lg:block disabled:opacity-50"
            >
              {isSubmitting ? 'è™•ç†ä¸­...' : 'å‰å¾€ä»˜æ¬¾'}
            </button>

            {/* è¿”å›è³¼ç‰© */}
            <Link
              href="/"
              className="block text-center text-sm text-gray-500 mt-4 hover:text-primary"
            >
              â† ç¹¼çºŒè³¼ç‰©
            </Link>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/layout.tsx">
import type { Metadata } from 'next';
import { config } from '@/lib/config';
import Header from '@/components/Header';
import Footer from '@/components/Footer';
import CartProvider from '@/components/CartProvider';
import '@/styles/globals.css';

export const metadata: Metadata = {
  title: config.seo.title,
  description: config.seo.description,
  openGraph: {
    title: config.seo.title,
    description: config.seo.description,
    images: [config.seo.ogImage],
  },
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="zh-TW">
      <head>
        {/* å‹•æ…‹æ³¨å…¥ä¸»é¡Œ CSS è®Šæ•¸ */}
        <style
          dangerouslySetInnerHTML={{
            __html: `
              :root {
                --color-primary: ${config.theme.primaryColor};
                --color-secondary: ${config.theme.secondaryColor};
                --color-accent: ${config.theme.accentColor};
                --font-family: ${config.theme.fontFamily};
                --border-radius: ${config.theme.borderRadius};
              }
            `,
          }}
        />
        <link rel="icon" href={config.store.favicon} />
      </head>
      <body className="min-h-screen flex flex-col">
        <CartProvider>
          <Header />
          <main className="flex-grow">{children}</main>
          <Footer />
        </CartProvider>
      </body>
    </html>
  );
}
</file>

<file path="app/page.tsx">
import { getProducts } from '@/lib/medusa';
import { config } from '@/lib/config';
import ProductCard from '@/components/ProductCard';

export const revalidate = 3600; // ISR: 1 å°æ™‚é‡æ–°é©—è­‰

export default async function HomePage() {
  const { products } = await getProducts({ limit: 50 });

  return (
    <div className="container mx-auto px-4 py-8">
      {/* Hero Section */}
      <section className="text-center mb-12">
        <h1 className="text-3xl md:text-4xl font-bold mb-4">
          {config.store.name}
        </h1>
        <p className="text-gray-600 max-w-2xl mx-auto">
          {config.store.description}
        </p>
      </section>

      {/* å…é‹æç¤º */}
      {config.shipping.freeShippingThreshold > 0 && (
        <div className="bg-secondary text-center py-3 mb-8 rounded">
          <p className="text-sm">
            ğŸšš æ»¿ <span className="font-bold">NT${config.shipping.freeShippingThreshold}</span> å…é‹è²»
          </p>
        </div>
      )}

      {/* å•†å“åˆ—è¡¨ */}
      <section>
        <h2 className="text-2xl font-bold mb-6">å…¨éƒ¨å•†å“</h2>
        
        {products.length === 0 ? (
          <p className="text-gray-500 text-center py-12">ç›®å‰æ²’æœ‰å•†å“</p>
        ) : (
          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6">
            {products.map((product) => (
              <ProductCard key={product.id} product={product} />
            ))}
          </div>
        )}
      </section>
    </div>
  );
}
</file>

<file path="app/products/[handle]/page.tsx">
import { Metadata } from 'next';
import { notFound } from 'next/navigation';
import { getProducts, getProductByHandle } from '@/lib/medusa';
import { config } from '@/lib/config';
import ProductDetail from '@/components/ProductDetail';

export const revalidate = 3600;

interface Props {
  params: { handle: string };
}

// ç”¢ç”Ÿéœæ…‹è·¯å¾‘
export async function generateStaticParams() {
  const { products } = await getProducts({ limit: 100 });
  return products.map((product) => ({
    handle: product.handle,
  }));
}

// å‹•æ…‹ metadata
export async function generateMetadata({ params }: Props): Promise<Metadata> {
  const product = await getProductByHandle(params.handle);
  
  if (!product) {
    return {
      title: 'å•†å“ä¸å­˜åœ¨',
    };
  }

  return {
    title: `${product.title} | ${config.store.name}`,
    description: product.description || config.seo.description,
    openGraph: {
      title: product.title,
      description: product.description || config.seo.description,
      images: product.thumbnail ? [product.thumbnail] : undefined,
    },
  };
}

export default async function ProductPage({ params }: Props) {
  const product = await getProductByHandle(params.handle);

  if (!product) {
    notFound();
  }

  return <ProductDetail product={product} />;
}
</file>

<file path="components/CartDrawer.tsx">
'use client';

import { useCart } from './CartProvider';
import { formatPrice, config } from '@/lib/config';
import Image from 'next/image';
import Link from 'next/link';

interface CartDrawerProps {
  isOpen: boolean;
  onClose: () => void;
}

export default function CartDrawer({ isOpen, onClose }: CartDrawerProps) {
  const { cart, isLoading, updateItem, removeItem } = useCart();

  if (!isOpen) return null;

  const subtotal = cart?.subtotal || 0;
  const isFreeShipping = subtotal >= config.shipping.freeShippingThreshold;
  const amountToFreeShipping = config.shipping.freeShippingThreshold - subtotal;

  return (
    <>
      {/* Backdrop */}
      <div
        className="fixed inset-0 bg-black/50 z-50 animate-fade-in"
        onClick={onClose}
      />

      {/* Drawer */}
      <div className="fixed right-0 top-0 h-full w-full max-w-md bg-white z-50 shadow-xl animate-slide-in-right flex flex-col">
        {/* Header */}
        <div className="flex items-center justify-between p-4 border-b">
          <h2 className="text-lg font-bold">è³¼ç‰©è»Š</h2>
          <button
            onClick={onClose}
            className="p-2 hover:bg-gray-100 rounded-full"
            aria-label="é—œé–‰"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              strokeWidth={1.5}
              stroke="currentColor"
              className="w-6 h-6"
            >
              <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        {/* å…é‹æç¤º */}
        {!isFreeShipping && amountToFreeShipping > 0 && (
          <div className="bg-secondary px-4 py-3 text-sm">
            <p>
              å†è²· <span className="font-bold text-accent">{formatPrice(amountToFreeShipping)}</span> å³å¯å…é‹ï¼
            </p>
            <div className="mt-2 h-2 bg-gray-200 rounded-full overflow-hidden">
              <div
                className="h-full bg-accent transition-all duration-300"
                style={{
                  width: `${Math.min((subtotal / config.shipping.freeShippingThreshold) * 100, 100)}%`,
                }}
              />
            </div>
          </div>
        )}

        {isFreeShipping && (
          <div className="bg-green-50 px-4 py-3 text-sm text-green-700">
            ğŸ‰ å·²é”å…é‹é–€æª»ï¼
          </div>
        )}

        {/* Cart Items */}
        <div className="flex-grow overflow-y-auto p-4">
          {isLoading && !cart ? (
            <div className="flex items-center justify-center h-32">
              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary" />
            </div>
          ) : !cart?.items?.length ? (
            <div className="text-center py-12">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                strokeWidth={1.5}
                stroke="currentColor"
                className="w-16 h-16 mx-auto text-gray-300 mb-4"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 00-16.536-1.84M7.5 14.25L5.106 5.272M6 20.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm12.75 0a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"
                />
              </svg>
              <p className="text-gray-500">è³¼ç‰©è»Šæ˜¯ç©ºçš„</p>
              <button onClick={onClose} className="btn-primary mt-4">
                ç¹¼çºŒè³¼ç‰©
              </button>
            </div>
          ) : (
            <ul className="space-y-4">
              {cart.items.map((item) => (
                <li key={item.id} className="flex gap-4">
                  {/* å•†å“åœ–ç‰‡ */}
                  <div className="w-20 h-20 bg-gray-100 rounded overflow-hidden flex-shrink-0">
                    {item.thumbnail ? (
                      <Image
                        src={item.thumbnail}
                        alt={item.title}
                        width={80}
                        height={80}
                        className="w-full h-full object-cover"
                      />
                    ) : (
                      <div className="w-full h-full flex items-center justify-center text-gray-400">
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          fill="none"
                          viewBox="0 0 24 24"
                          strokeWidth={1.5}
                          stroke="currentColor"
                          className="w-8 h-8"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"
                          />
                        </svg>
                      </div>
                    )}
                  </div>

                  {/* å•†å“è³‡è¨Š */}
                  <div className="flex-grow min-w-0">
                    <h4 className="font-medium text-sm truncate">{item.title}</h4>
                    {item.variant?.title && item.variant.title !== item.title && (
                      <p className="text-xs text-gray-500">{item.variant.title}</p>
                    )}
                    <p className="text-sm font-bold mt-1">
                      {formatPrice(item.unit_price)}
                    </p>

                    {/* æ•¸é‡æ§åˆ¶ */}
                    <div className="flex items-center gap-2 mt-2">
                      <button
                        onClick={() => updateItem(item.id, item.quantity - 1)}
                        className="w-7 h-7 flex items-center justify-center border rounded hover:bg-gray-100"
                        disabled={isLoading}
                      >
                        -
                      </button>
                      <span className="w-8 text-center text-sm">{item.quantity}</span>
                      <button
                        onClick={() => updateItem(item.id, item.quantity + 1)}
                        className="w-7 h-7 flex items-center justify-center border rounded hover:bg-gray-100"
                        disabled={isLoading}
                      >
                        +
                      </button>
                      <button
                        onClick={() => removeItem(item.id)}
                        className="ml-auto text-gray-400 hover:text-red-500"
                        aria-label="ç§»é™¤"
                        disabled={isLoading}
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          fill="none"
                          viewBox="0 0 24 24"
                          strokeWidth={1.5}
                          stroke="currentColor"
                          className="w-5 h-5"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"
                          />
                        </svg>
                      </button>
                    </div>
                  </div>
                </li>
              ))}
            </ul>
          )}
        </div>

        {/* Footer */}
        {cart?.items?.length ? (
          <div className="border-t p-4 space-y-4">
            {/* å°è¨ˆ */}
            <div className="flex justify-between text-lg font-bold">
              <span>å°è¨ˆ</span>
              <span>{formatPrice(subtotal)}</span>
            </div>

            {/* çµå¸³æŒ‰éˆ• */}
            {config.features.checkout ? (
              <Link
                href="/checkout"
                onClick={onClose}
                className="btn-primary w-full text-center"
              >
                å‰å¾€çµå¸³
              </Link>
            ) : (
              <button disabled className="btn-secondary w-full opacity-50 cursor-not-allowed">
                çµå¸³åŠŸèƒ½é–‹ç™¼ä¸­
              </button>
            )}

            <button
              onClick={onClose}
              className="btn-secondary w-full"
            >
              ç¹¼çºŒè³¼ç‰©
            </button>
          </div>
        ) : null}
      </div>
    </>
  );
}
</file>

<file path="components/CartProvider.tsx">
'use client';

import {
  createContext,
  useContext,
  useState,
  useEffect,
  useCallback,
  ReactNode,
} from 'react';
import {
  Cart,
  createCart,
  getCart,
  addToCart as addToCartApi,
  updateCartItem as updateCartItemApi,
  removeCartItem as removeCartItemApi,
} from '@/lib/medusa';

const CART_ID_KEY = 'medusa_cart_id';

interface CartContextType {
  cart: Cart | null;
  isLoading: boolean;
  error: string | null;
  itemCount: number;
  addItem: (variantId: string, quantity?: number) => Promise<void>;
  updateItem: (itemId: string, quantity: number) => Promise<void>;
  removeItem: (itemId: string) => Promise<void>;
  refreshCart: () => Promise<void>;
}

const CartContext = createContext<CartContextType | undefined>(undefined);

export function useCart() {
  const context = useContext(CartContext);
  if (!context) {
    throw new Error('useCart must be used within a CartProvider');
  }
  return context;
}

export default function CartProvider({ children }: { children: ReactNode }) {
  const [cart, setCart] = useState<Cart | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // è¨ˆç®—è³¼ç‰©è»Šå•†å“æ•¸é‡
  const itemCount = cart?.items?.reduce((sum, item) => sum + item.quantity, 0) || 0;

  // åˆå§‹åŒ–è³¼ç‰©è»Š
  const initCart = useCallback(async () => {
    try {
      setIsLoading(true);
      setError(null);

      // å˜—è©¦å¾ localStorage å–å¾— cart_id
      const savedCartId = localStorage.getItem(CART_ID_KEY);

      if (savedCartId) {
        try {
          const { cart: existingCart } = await getCart(savedCartId);
          setCart(existingCart);
          return;
        } catch {
          // Cart ä¸å­˜åœ¨æˆ–éæœŸï¼Œå»ºç«‹æ–°çš„
          localStorage.removeItem(CART_ID_KEY);
        }
      }

      // å»ºç«‹æ–°è³¼ç‰©è»Š
      const { cart: newCart } = await createCart();
      localStorage.setItem(CART_ID_KEY, newCart.id);
      setCart(newCart);
    } catch (err) {
      console.error('Failed to initialize cart:', err);
      setError('ç„¡æ³•è¼‰å…¥è³¼ç‰©è»Š');
    } finally {
      setIsLoading(false);
    }
  }, []);

  // åˆå§‹åŒ–
  useEffect(() => {
    initCart();
  }, [initCart]);

  // é‡æ–°è¼‰å…¥è³¼ç‰©è»Š
  const refreshCart = useCallback(async () => {
    if (!cart?.id) return;
    
    try {
      const { cart: updatedCart } = await getCart(cart.id);
      setCart(updatedCart);
    } catch (err) {
      console.error('Failed to refresh cart:', err);
    }
  }, [cart?.id]);

  // åŠ å…¥å•†å“
  const addItem = useCallback(
    async (variantId: string, quantity: number = 1) => {
      if (!cart?.id) {
        setError('è³¼ç‰©è»Šæœªåˆå§‹åŒ–');
        return;
      }

      try {
        setIsLoading(true);
        setError(null);
        const { cart: updatedCart } = await addToCartApi(cart.id, variantId, quantity);
        setCart(updatedCart);
      } catch (err) {
        console.error('Failed to add item:', err);
        setError('åŠ å…¥è³¼ç‰©è»Šå¤±æ•—');
        throw err;
      } finally {
        setIsLoading(false);
      }
    },
    [cart?.id]
  );

  // æ›´æ–°æ•¸é‡
  const updateItem = useCallback(
    async (itemId: string, quantity: number) => {
      if (!cart?.id) return;

      try {
        setIsLoading(true);
        setError(null);

        if (quantity <= 0) {
          // æ•¸é‡ç‚º 0 å‰‡ç§»é™¤
          const { cart: updatedCart } = await removeCartItemApi(cart.id, itemId);
          setCart(updatedCart);
        } else {
          const { cart: updatedCart } = await updateCartItemApi(cart.id, itemId, quantity);
          setCart(updatedCart);
        }
      } catch (err) {
        console.error('Failed to update item:', err);
        setError('æ›´æ–°å¤±æ•—');
        throw err;
      } finally {
        setIsLoading(false);
      }
    },
    [cart?.id]
  );

  // ç§»é™¤å•†å“
  const removeItem = useCallback(
    async (itemId: string) => {
      if (!cart?.id) return;

      try {
        setIsLoading(true);
        setError(null);
        const { cart: updatedCart } = await removeCartItemApi(cart.id, itemId);
        setCart(updatedCart);
      } catch (err) {
        console.error('Failed to remove item:', err);
        setError('ç§»é™¤å¤±æ•—');
        throw err;
      } finally {
        setIsLoading(false);
      }
    },
    [cart?.id]
  );

  return (
    <CartContext.Provider
      value={{
        cart,
        isLoading,
        error,
        itemCount,
        addItem,
        updateItem,
        removeItem,
        refreshCart,
      }}
    >
      {children}
    </CartContext.Provider>
  );
}
</file>

<file path="components/Footer.tsx">
import { config } from '@/lib/config';

export default function Footer() {
  const currentYear = new Date().getFullYear();

  return (
    <footer className="bg-gray-900 text-gray-300 mt-12">
      <div className="container mx-auto px-4 py-8">
        <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
          {/* å“ç‰Œè³‡è¨Š */}
          <div>
            <h3 className="text-white font-bold text-lg mb-4">{config.store.name}</h3>
            <p className="text-sm text-gray-400">{config.store.description}</p>
          </div>

          {/* è¯çµ¡æ–¹å¼ */}
          <div>
            <h3 className="text-white font-bold text-lg mb-4">è¯çµ¡æˆ‘å€‘</h3>
            <ul className="space-y-2 text-sm">
              {config.contact.email && (
                <li>
                  <a href={`mailto:${config.contact.email}`} className="hover:text-white">
                    ğŸ“§ {config.contact.email}
                  </a>
                </li>
              )}
              {config.contact.phone && (
                <li>
                  <a href={`tel:${config.contact.phone}`} className="hover:text-white">
                    ğŸ“ {config.contact.phone}
                  </a>
                </li>
              )}
              {config.contact.lineOA && (
                <li>
                  <a
                    href={config.contact.lineOA}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="hover:text-white"
                  >
                    ğŸ’¬ LINE å®˜æ–¹å¸³è™Ÿ
                  </a>
                </li>
              )}
            </ul>
          </div>

          {/* ç¤¾ç¾¤é€£çµ */}
          <div>
            <h3 className="text-white font-bold text-lg mb-4">è¿½è¹¤æˆ‘å€‘</h3>
            <div className="flex space-x-4">
              {config.contact.facebook && (
                <a
                  href={config.contact.facebook}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="hover:text-white"
                  aria-label="Facebook"
                >
                  <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z" />
                  </svg>
                </a>
              )}
              {config.contact.instagram && (
                <a
                  href={config.contact.instagram}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="hover:text-white"
                  aria-label="Instagram"
                >
                  <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z" />
                  </svg>
                </a>
              )}
            </div>
          </div>
        </div>

        {/* ç‰ˆæ¬Š */}
        <div className="border-t border-gray-800 mt-8 pt-8 text-center text-sm text-gray-500">
          <p>Â© {currentYear} {config.store.name}. All rights reserved.</p>
        </div>
      </div>
    </footer>
  );
}
</file>

<file path="components/Header.tsx">
'use client';

import Link from 'next/link';
import Image from 'next/image';
import { config } from '@/lib/config';
import { useCart } from './CartProvider';
import CartDrawer from './CartDrawer';
import { useState } from 'react';

export default function Header() {
  const { itemCount } = useCart();
  const [isCartOpen, setIsCartOpen] = useState(false);

  return (
    <>
      <header className="sticky top-0 z-40 bg-white border-b border-gray-200">
        <div className="container mx-auto px-4">
          <div className="flex items-center justify-between h-16">
            {/* Logo */}
            <Link href="/" className="flex items-center space-x-2">
              {config.store.logo ? (
                <Image
                  src={config.store.logo}
                  alt={config.store.name}
                  width={120}
                  height={40}
                  className="h-8 w-auto"
                />
              ) : (
                <span className="text-xl font-bold">{config.store.name}</span>
              )}
            </Link>

            {/* å°èˆª */}
            <nav className="hidden md:flex items-center space-x-6">
              <Link href="/" className="text-gray-600 hover:text-primary transition-colors">
                å…¨éƒ¨å•†å“
              </Link>
              {config.contact.lineOA && (
                <a
                  href={config.contact.lineOA}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-gray-600 hover:text-primary transition-colors"
                >
                  LINE å®¢æœ
                </a>
              )}
            </nav>

            {/* è³¼ç‰©è»ŠæŒ‰éˆ• */}
            {config.features.cart && (
              <button
                onClick={() => setIsCartOpen(true)}
                className="relative p-2 hover:bg-gray-100 rounded-full transition-colors"
                aria-label="è³¼ç‰©è»Š"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  strokeWidth={1.5}
                  stroke="currentColor"
                  className="w-6 h-6"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 00-16.536-1.84M7.5 14.25L5.106 5.272M6 20.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm12.75 0a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"
                  />
                </svg>
                {itemCount > 0 && (
                  <span className="absolute -top-1 -right-1 bg-accent text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">
                    {itemCount > 99 ? '99+' : itemCount}
                  </span>
                )}
              </button>
            )}
          </div>
        </div>
      </header>

      {/* è³¼ç‰©è»Šå´é‚Šæ¬„ */}
      <CartDrawer isOpen={isCartOpen} onClose={() => setIsCartOpen(false)} />
    </>
  );
}
</file>

<file path="components/ProductCard.tsx">
import Link from 'next/link';
import Image from 'next/image';
import { Product, getProductLowestPrice, hasDiscount } from '@/lib/medusa';
import { formatPrice } from '@/lib/config';

interface ProductCardProps {
  product: Product;
}

export default function ProductCard({ product }: ProductCardProps) {
  const lowestPrice = getProductLowestPrice(product);
  const firstVariant = product.variants?.[0];
  const showDiscount = firstVariant && hasDiscount(firstVariant);
  const originalPrice = firstVariant?.calculated_price?.original_amount;

  return (
    <Link href={`/products/${product.handle}`} className="group">
      <div className="card overflow-hidden">
        {/* å•†å“åœ–ç‰‡ */}
        <div className="aspect-square relative bg-gray-100 overflow-hidden">
          {product.thumbnail ? (
            <Image
              src={product.thumbnail}
              alt={product.title}
              fill
              sizes="(max-width: 768px) 50vw, 25vw"
              className="object-cover group-hover:scale-105 transition-transform duration-300"
            />
          ) : (
            <div className="w-full h-full flex items-center justify-center text-gray-400">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                strokeWidth={1.5}
                stroke="currentColor"
                className="w-12 h-12"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"
                />
              </svg>
            </div>
          )}
          
          {/* æŠ˜æ‰£æ¨™ç±¤ */}
          {showDiscount && (
            <div className="absolute top-2 left-2 bg-accent text-white text-xs px-2 py-1 rounded">
              ç‰¹åƒ¹
            </div>
          )}
        </div>

        {/* å•†å“è³‡è¨Š */}
        <div className="p-4">
          <h3 className="font-medium text-gray-900 truncate group-hover:text-primary transition-colors">
            {product.title}
          </h3>
          
          <div className="mt-2 flex items-center gap-2">
            {showDiscount && originalPrice && (
              <span className="price-original">
                {formatPrice(originalPrice)}
              </span>
            )}
            <span className={showDiscount ? 'price-sale' : 'price'}>
              {formatPrice(lowestPrice)}
            </span>
          </div>
          
          {/* å¤šè®Šé«”æç¤º */}
          {product.variants?.length > 1 && (
            <p className="text-xs text-gray-500 mt-1">
              {product.variants.length} ç¨®è¦æ ¼
            </p>
          )}
        </div>
      </div>
    </Link>
  );
}
</file>

<file path="components/ProductDetail.tsx">
'use client';

import { useState, useMemo } from 'react';
import Image from 'next/image';
import { Product, getVariantPrice, hasDiscount } from '@/lib/medusa';
import { formatPrice, config } from '@/lib/config';
import { useCart } from './CartProvider';

interface ProductDetailProps {
  product: Product;
}

export default function ProductDetail({ product }: ProductDetailProps) {
  const { addItem, isLoading } = useCart();
  const [selectedOptions, setSelectedOptions] = useState<Record<string, string>>({});
  const [quantity, setQuantity] = useState(1);
  const [activeImageIndex, setActiveImageIndex] = useState(0);
  const [isAdding, setIsAdding] = useState(false);
  const [message, setMessage] = useState<{ type: 'success' | 'error'; text: string } | null>(null);

  // æ‰¾åˆ°ç¬¦åˆé¸æ“‡çš„ variant
  const selectedVariant = useMemo(() => {
    if (!product.variants?.length) return null;
    
    // å¦‚æœåªæœ‰ä¸€å€‹ variantï¼Œç›´æ¥è¿”å›
    if (product.variants.length === 1) {
      return product.variants[0];
    }

    // æ ¹æ“šé¸æ“‡çš„ options æ‰¾åˆ°å°æ‡‰çš„ variant
    return product.variants.find((variant) => {
      return variant.options?.every((option) => {
        return selectedOptions[option.option_id] === option.value;
      });
    });
  }, [product.variants, selectedOptions]);

  // è¨ˆç®—åƒ¹æ ¼
  const price = selectedVariant ? getVariantPrice(selectedVariant) : getVariantPrice(product.variants[0]);
  const showDiscount = selectedVariant && hasDiscount(selectedVariant);
  const originalPrice = selectedVariant?.calculated_price?.original_amount;

  // åœ–ç‰‡åˆ—è¡¨
  const images = product.images?.length ? product.images : product.thumbnail ? [{ id: 'thumb', url: product.thumbnail }] : [];

  // è™•ç†é¸é …è®Šæ›´
  const handleOptionChange = (optionId: string, value: string) => {
    setSelectedOptions((prev) => ({
      ...prev,
      [optionId]: value,
    }));
  };

  // æª¢æŸ¥æ˜¯å¦å¯ä»¥åŠ å…¥è³¼ç‰©è»Š
  const canAddToCart = useMemo(() => {
    if (!product.options?.length) return true; // ç„¡é¸é …
    if (product.variants?.length === 1) return true; // åªæœ‰ä¸€å€‹è®Šé«”
    return !!selectedVariant; // æœ‰é¸æ“‡è®Šé«”
  }, [product.options, product.variants, selectedVariant]);

  // åŠ å…¥è³¼ç‰©è»Š
  const handleAddToCart = async () => {
    if (!canAddToCart || !selectedVariant) {
      setMessage({ type: 'error', text: 'è«‹é¸æ“‡å•†å“è¦æ ¼' });
      return;
    }

    try {
      setIsAdding(true);
      setMessage(null);
      await addItem(selectedVariant.id, quantity);
      setMessage({ type: 'success', text: 'å·²åŠ å…¥è³¼ç‰©è»Šï¼' });
      
      // 3 ç§’å¾Œæ¸…é™¤è¨Šæ¯
      setTimeout(() => setMessage(null), 3000);
    } catch (error) {
      setMessage({ type: 'error', text: 'åŠ å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦' });
    } finally {
      setIsAdding(false);
    }
  };

  return (
    <div className="container mx-auto px-4 py-8">
      <div className="grid md:grid-cols-2 gap-8 lg:gap-12">
        {/* åœ–ç‰‡å€ */}
        <div className="space-y-4">
          {/* ä¸»åœ– */}
          <div className="aspect-square relative bg-gray-100 rounded-lg overflow-hidden">
            {images[activeImageIndex] ? (
              <Image
                src={images[activeImageIndex].url}
                alt={product.title}
                fill
                sizes="(max-width: 768px) 100vw, 50vw"
                className="object-cover"
                priority
              />
            ) : (
              <div className="w-full h-full flex items-center justify-center text-gray-400">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  strokeWidth={1.5}
                  stroke="currentColor"
                  className="w-20 h-20"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"
                  />
                </svg>
              </div>
            )}
          </div>

          {/* ç¸®åœ– */}
          {images.length > 1 && (
            <div className="flex gap-2 overflow-x-auto pb-2">
              {images.map((image, index) => (
                <button
                  key={image.id}
                  onClick={() => setActiveImageIndex(index)}
                  className={`flex-shrink-0 w-16 h-16 rounded-lg overflow-hidden border-2 transition-colors ${
                    index === activeImageIndex ? 'border-primary' : 'border-transparent'
                  }`}
                >
                  <Image
                    src={image.url}
                    alt={`${product.title} ${index + 1}`}
                    width={64}
                    height={64}
                    className="w-full h-full object-cover"
                  />
                </button>
              ))}
            </div>
          )}
        </div>

        {/* å•†å“è³‡è¨Šå€ */}
        <div className="space-y-6">
          {/* æ¨™é¡Œ */}
          <div>
            <h1 className="text-2xl md:text-3xl font-bold">{product.title}</h1>
            {selectedVariant?.sku && (
              <p className="text-sm text-gray-500 mt-1">SKU: {selectedVariant.sku}</p>
            )}
          </div>

          {/* åƒ¹æ ¼ */}
          <div className="flex items-center gap-3">
            {showDiscount && originalPrice && (
              <span className="text-xl text-gray-400 line-through">
                {formatPrice(originalPrice)}
              </span>
            )}
            <span className={`text-2xl font-bold ${showDiscount ? 'text-accent' : ''}`}>
              {formatPrice(price)}
            </span>
            {showDiscount && (
              <span className="bg-accent text-white text-sm px-2 py-1 rounded">
                ç‰¹åƒ¹
              </span>
            )}
          </div>

          {/* é¸é … */}
          {product.options?.map((option) => (
            <div key={option.id}>
              <label className="block font-medium mb-2">{option.title}</label>
              <div className="flex flex-wrap gap-2">
                {option.values.map((value) => (
                  <button
                    key={value.id}
                    onClick={() => handleOptionChange(option.id, value.value)}
                    className={`px-4 py-2 border rounded-lg transition-colors ${
                      selectedOptions[option.id] === value.value
                        ? 'border-primary bg-primary text-white'
                        : 'border-gray-300 hover:border-gray-500'
                    }`}
                  >
                    {value.value}
                  </button>
                ))}
              </div>
            </div>
          ))}

          {/* æ•¸é‡ */}
          <div>
            <label className="block font-medium mb-2">æ•¸é‡</label>
            <div className="flex items-center gap-3">
              <button
                onClick={() => setQuantity((q) => Math.max(1, q - 1))}
                className="w-10 h-10 flex items-center justify-center border rounded-lg hover:bg-gray-100"
              >
                -
              </button>
              <span className="w-12 text-center text-lg font-medium">{quantity}</span>
              <button
                onClick={() => setQuantity((q) => q + 1)}
                className="w-10 h-10 flex items-center justify-center border rounded-lg hover:bg-gray-100"
              >
                +
              </button>
            </div>
          </div>

          {/* è¨Šæ¯ */}
          {message && (
            <div
              className={`p-3 rounded-lg ${
                message.type === 'success' ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'
              }`}
            >
              {message.text}
            </div>
          )}

          {/* åŠ å…¥è³¼ç‰©è»Š */}
          <button
            onClick={handleAddToCart}
            disabled={isAdding || isLoading || !config.features.cart}
            className="btn-primary w-full py-3 text-lg disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {isAdding ? 'åŠ å…¥ä¸­...' : 'åŠ å…¥è³¼ç‰©è»Š'}
          </button>

          {/* å…é‹æç¤º */}
          {config.shipping.freeShippingThreshold > 0 && (
            <p className="text-sm text-gray-500 text-center">
              ğŸšš æ»¿ {formatPrice(config.shipping.freeShippingThreshold)} å…é‹è²»
            </p>
          )}

          {/* å•†å“æè¿° */}
          {product.description && (
            <div className="border-t pt-6">
              <h2 className="font-bold mb-3">å•†å“èªªæ˜</h2>
              <div
                className="prose prose-sm max-w-none text-gray-600"
                dangerouslySetInnerHTML={{ __html: product.description }}
              />
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="config/store.json">
{
  "store": {
    "name": "æ•æ·å•†åº—",
    "shortName": "æ•æ·",
    "description": "AI é©…å‹•çš„é›»å•†è§£æ±ºæ–¹æ¡ˆ",
    "domain": "shop.minjie0326.com",
    "logo": "/tenant/logo.png",
    "favicon": "/tenant/favicon.ico"
  },
  "theme": {
    "primaryColor": "#000000",
    "secondaryColor": "#f5f5f5",
    "accentColor": "#dc2626",
    "fontFamily": "system-ui, -apple-system, sans-serif",
    "borderRadius": "0.5rem"
  },
  "medusa": {
    "backendUrl": "https://medusa-store-minjie-production.up.railway.app",
    "publishableKey": "pk_9e9c701859cf64dcc2679cb893ae10055f19f3aaa941eb7bcc95493e20256eb2",
    "regionId": "reg_01KFFT966Q197EXXNSKR3J8Q5T",
    "salesChannelId": "sc_01KG0DSC3T1GFK921DB7P7251N"
  },
  "gateway": {
    "url": "https://ecpay-gateway-production.up.railway.app",
    "paymentApiKey": "gk_1e301592bab9a09f42b572a839492a2e29f1fac8a642946e482f9938a60c7b5b",
    "logisticsApiKey": "gk_ff72ac9636b547d395c68f583645ff584bcc01022cdc6075a38c13cc06a39167"
  },
  "features": {
    "cart": true,
    "checkout": true,
    "cvsLogistics": true,
    "homeDelivery": true,
    "linePay": false,
    "memberSystem": false
  },
  "shipping": {
    "freeShippingThreshold": 1000,
    "cvsOptions": ["UNIMARTC2C", "FAMIC2C", "HILIFEC2C"],
    "homeDeliveryFee": 100,
    "cvsFee": 60
  },
  "contact": {
    "email": "support@minjie0326.com",
    "phone": "",
    "lineOA": "",
    "instagram": "",
    "facebook": ""
  },
  "seo": {
    "title": "æ•æ·å•†åº— | AI é›»å•†è§£æ±ºæ–¹æ¡ˆ",
    "description": "å°ˆæ¥­çš„é›»å•†å»ºç«™æœå‹™ï¼Œå¿«é€Ÿä¸Šç·šæ‚¨çš„ç¶²è·¯å•†åº—",
    "ogImage": "/tenant/og-image.png"
  }
}
</file>

<file path="lib/config.ts">
import storeConfig from '@/config/store.json';

// é¡å‹å®šç¾©
export interface StoreConfig {
  store: {
    name: string;
    shortName: string;
    description: string;
    domain: string;
    logo: string;
    favicon: string;
  };
  theme: {
    primaryColor: string;
    secondaryColor: string;
    accentColor: string;
    fontFamily: string;
    borderRadius: string;
  };
  medusa: {
    backendUrl: string;
    publishableKey: string;
    regionId: string;
    salesChannelId: string;
  };
  gateway: {
    url: string;
    paymentApiKey: string;
    logisticsApiKey: string;
  };
  features: {
    cart: boolean;
    checkout: boolean;
    cvsLogistics: boolean;
    homeDelivery: boolean;
    linePay: boolean;
    memberSystem: boolean;
  };
  shipping: {
    freeShippingThreshold: number;
    cvsOptions: string[];
    homeDeliveryFee: number;
    cvsFee: number;
  };
  contact: {
    email: string;
    phone: string;
    lineOA: string;
    instagram: string;
    facebook: string;
  };
  seo: {
    title: string;
    description: string;
    ogImage: string;
  };
}

// åŒ¯å‡ºè¨­å®š
export const config: StoreConfig = storeConfig as StoreConfig;

// ä¾¿æ·å­˜å–
export const store = config.store;
export const theme = config.theme;
export const medusa = config.medusa;
export const gateway = config.gateway;
export const features = config.features;
export const shipping = config.shipping;
export const contact = config.contact;
export const seo = config.seo;

// å·¥å…·å‡½å¼
export function formatPrice(amount: number, currency: string = 'TWD'): string {
  return new Intl.NumberFormat('zh-TW', {
    style: 'currency',
    currency,
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }).format(amount);
}

export function isFreeShipping(total: number): boolean {
  return total >= shipping.freeShippingThreshold;
}

export function getShippingFee(type: 'cvs' | 'home', total: number): number {
  if (isFreeShipping(total)) return 0;
  return type === 'cvs' ? shipping.cvsFee : shipping.homeDeliveryFee;
}
</file>

<file path="lib/gateway.ts">
import { gateway } from './config';

const GATEWAY_URL = gateway.url;

// ============ é€šç”¨ fetch ============

async function gatewayFetch<T>(
  endpoint: string,
  apiKey: string,
  options: RequestInit = {}
): Promise<T> {
  const url = `${GATEWAY_URL}${endpoint}`;

  const headers: HeadersInit = {
    'Content-Type': 'application/json',
    'x-api-key': apiKey,
    ...options.headers,
  };

  const response = await fetch(url, {
    ...options,
    headers,
  });

  const data = await response.json();

  if (!response.ok) {
    throw new Error(data.error || `Gateway Error: ${response.status}`);
  }

  return data;
}

// é‡‘æµ API
function paymentFetch<T>(endpoint: string, options: RequestInit = {}): Promise<T> {
  return gatewayFetch<T>(endpoint, gateway.paymentApiKey, options);
}

// ç‰©æµ API
function logisticsFetch<T>(endpoint: string, options: RequestInit = {}): Promise<T> {
  return gatewayFetch<T>(endpoint, gateway.logisticsApiKey, options);
}

// ============ é‡‘æµ API ============

export interface CheckoutRequest {
  amount: number;
  item_name: string;
  order_id?: string;
  customer_email?: string;
  customer_name?: string;
  customer_phone?: string;
  return_url?: string;
  metadata?: Record<string, any>;
}

export interface CheckoutResponse {
  success: boolean;
  transaction_id: string;
  merchant_trade_no: string;
  checkout_url: string;
  expires_at: string;
}

export async function createCheckout(data: CheckoutRequest): Promise<CheckoutResponse> {
  return paymentFetch<CheckoutResponse>('/api/v1/payment/checkout', {
    method: 'POST',
    body: JSON.stringify(data),
  });
}

// ============ ç‰©æµ API ============

export interface CvsMapRequest {
  cvs_type: 'UNIMARTC2C' | 'FAMIC2C' | 'HILIFEC2C';
  return_url?: string;
}

export interface CvsMapResponse {
  success: boolean;
  temp_trade_no: string;
  map_url: string;
}

export async function getCvsMap(data: CvsMapRequest): Promise<CvsMapResponse> {
  return logisticsFetch<CvsMapResponse>('/api/v1/logistics/cvs-map', {
    method: 'POST',
    body: JSON.stringify(data),
  });
}

export interface CvsSelection {
  temp_trade_no: string;
  store_id: string;
  store_name: string;
  address: string;
  telephone?: string;
  cvs_type?: string;
}

export async function getCvsSelection(tempTradeNo: string): Promise<{ success: boolean; selection: CvsSelection | null }> {
  return logisticsFetch(`/api/v1/logistics/cvs-selection/${tempTradeNo}`);
}

export interface CreateShipmentRequest {
  receiver_name: string;
  receiver_phone: string;
  receiver_email?: string;
  // è¶…å–
  receiver_store_id?: string;
  cvs_sub_type?: string;
  // å®…é…
  receiver_address?: string;
  receiver_zip_code?: string;
  // å•†å“
  goods_name: string;
  goods_amount?: number;
  // ä»£æ”¶
  is_collection?: boolean;
  collection_amount?: number;
  // é—œè¯
  order_id?: string;
  transaction_id?: string;
}

export interface ShipmentResponse {
  success: boolean;
  shipment: {
    id: string;
    merchant_trade_no: string;
    status: string;
    cvs_payment_no?: string;
    cvs_validation_no?: string;
  };
}

export async function createShipment(data: CreateShipmentRequest): Promise<ShipmentResponse> {
  return logisticsFetch<ShipmentResponse>('/api/v1/logistics/shipment', {
    method: 'POST',
    body: JSON.stringify(data),
  });
}

// ============ å·¥å…·å‡½å¼ ============

// è¶…å•†åç¨±å°æ‡‰
export const CVS_NAMES: Record<string, string> = {
  UNIMARTC2C: '7-ELEVEN',
  FAMIC2C: 'å…¨å®¶',
  HILIFEC2C: 'èŠçˆ¾å¯Œ',
};

// å–å¾—è¶…å•†é¡¯ç¤ºåç¨±
export function getCvsDisplayName(cvsType: string): string {
  return CVS_NAMES[cvsType] || cvsType;
}
</file>

<file path="lib/medusa.ts">
import { medusa } from './config';

const BACKEND_URL = medusa.backendUrl;
const PUBLISHABLE_KEY = medusa.publishableKey;
const REGION_ID = medusa.regionId;

// é€šç”¨ fetch å‡½å¼
async function medusaFetch<T>(
  endpoint: string,
  options: RequestInit = {}
): Promise<T> {
  const url = `${BACKEND_URL}${endpoint}`;
  
  const headers: HeadersInit = {
    'Content-Type': 'application/json',
    'x-publishable-api-key': PUBLISHABLE_KEY,
    ...options.headers,
  };

  const response = await fetch(url, {
    ...options,
    headers,
  });

  if (!response.ok) {
    const error = await response.json().catch(() => ({}));
    throw new Error(error.message || `API Error: ${response.status}`);
  }

  return response.json();
}

// ============ å•†å“ API ============

export interface Product {
  id: string;
  title: string;
  handle: string;
  description: string | null;
  thumbnail: string | null;
  images: Array<{ id: string; url: string }>;
  options: Array<{
    id: string;
    title: string;
    values: Array<{ id: string; value: string }>;
  }>;
  variants: Array<{
    id: string;
    title: string;
    sku: string | null;
    prices: Array<{
      amount: number;
      currency_code: string;
    }>;
    options: Array<{
      id: string;
      value: string;
      option_id: string;
    }>;
    inventory_quantity?: number;
    calculated_price?: {
      calculated_amount: number;
      original_amount: number;
      currency_code: string;
    };
  }>;
  created_at: string;
  updated_at: string;
}

export interface ProductsResponse {
  products: Product[];
  count: number;
  offset: number;
  limit: number;
}

export async function getProducts(params?: {
  limit?: number;
  offset?: number;
  collection_id?: string[];
}): Promise<ProductsResponse> {
  const searchParams = new URLSearchParams();
  searchParams.set('region_id', REGION_ID);
  
  if (params?.limit) searchParams.set('limit', String(params.limit));
  if (params?.offset) searchParams.set('offset', String(params.offset));
  if (params?.collection_id) {
    params.collection_id.forEach(id => searchParams.append('collection_id[]', id));
  }

  return medusaFetch<ProductsResponse>(`/store/products?${searchParams}`);
}

export async function getProduct(handle: string): Promise<{ product: Product }> {
  const searchParams = new URLSearchParams();
  searchParams.set('region_id', REGION_ID);
  
  return medusaFetch<{ product: Product }>(`/store/products/${handle}?${searchParams}`);
}

export async function getProductByHandle(handle: string): Promise<Product | null> {
  const searchParams = new URLSearchParams();
  searchParams.set('region_id', REGION_ID);
  searchParams.set('handle', handle);
  
  const response = await medusaFetch<ProductsResponse>(`/store/products?${searchParams}`);
  return response.products[0] || null;
}

// ============ è³¼ç‰©è»Š API ============

export interface CartItem {
  id: string;
  title: string;
  description: string | null;
  thumbnail: string | null;
  quantity: number;
  unit_price: number;
  subtotal: number;
  total: number;
  variant: {
    id: string;
    title: string;
    sku: string | null;
    product: {
      id: string;
      title: string;
      handle: string;
      thumbnail: string | null;
    };
  };
}

export interface Cart {
  id: string;
  email: string | null;
  items: CartItem[];
  region: {
    id: string;
    name: string;
    currency_code: string;
  };
  subtotal: number;
  shipping_total: number;
  discount_total: number;
  tax_total: number;
  total: number;
  shipping_address: Address | null;
  billing_address: Address | null;
  shipping_methods: ShippingMethod[];
}

export interface Address {
  first_name: string;
  last_name: string;
  phone: string;
  address_1: string;
  address_2: string | null;
  city: string;
  province: string | null;
  postal_code: string;
  country_code: string;
}

export interface ShippingMethod {
  id: string;
  name: string;
  price: number;
}

export async function createCart(): Promise<{ cart: Cart }> {
  return medusaFetch<{ cart: Cart }>('/store/carts', {
    method: 'POST',
    body: JSON.stringify({
      region_id: REGION_ID,
    }),
  });
}

export async function getCart(cartId: string): Promise<{ cart: Cart }> {
  return medusaFetch<{ cart: Cart }>(`/store/carts/${cartId}`);
}

export async function addToCart(
  cartId: string,
  variantId: string,
  quantity: number = 1
): Promise<{ cart: Cart }> {
  return medusaFetch<{ cart: Cart }>(`/store/carts/${cartId}/line-items`, {
    method: 'POST',
    body: JSON.stringify({
      variant_id: variantId,
      quantity,
    }),
  });
}

export async function updateCartItem(
  cartId: string,
  itemId: string,
  quantity: number
): Promise<{ cart: Cart }> {
  return medusaFetch<{ cart: Cart }>(`/store/carts/${cartId}/line-items/${itemId}`, {
    method: 'POST',
    body: JSON.stringify({ quantity }),
  });
}

export async function removeCartItem(
  cartId: string,
  itemId: string
): Promise<{ cart: Cart }> {
  return medusaFetch<{ cart: Cart }>(`/store/carts/${cartId}/line-items/${itemId}`, {
    method: 'DELETE',
  });
}

export async function updateCart(
  cartId: string,
  data: {
    email?: string;
    shipping_address?: Partial<Address>;
    billing_address?: Partial<Address>;
  }
): Promise<{ cart: Cart }> {
  return medusaFetch<{ cart: Cart }>(`/store/carts/${cartId}`, {
    method: 'POST',
    body: JSON.stringify(data),
  });
}

// ============ å·¥å…·å‡½å¼ ============

// å–å¾—è®Šé«”åƒ¹æ ¼ï¼ˆTWDï¼‰
export function getVariantPrice(variant: Product['variants'][0]): number {
  // å„ªå…ˆä½¿ç”¨è¨ˆç®—å¾Œçš„åƒ¹æ ¼ï¼ˆå«æŠ˜æ‰£ï¼‰
  if (variant.calculated_price) {
    return variant.calculated_price.calculated_amount;
  }
  
  // å¾ prices é™£åˆ—æ‰¾ TWD
  const twdPrice = variant.prices?.find(p => p.currency_code === 'twd');
  return twdPrice?.amount || 0;
}

// å–å¾—å•†å“æœ€ä½åƒ¹æ ¼
export function getProductLowestPrice(product: Product): number {
  if (!product.variants?.length) return 0;
  
  const prices = product.variants.map(v => getVariantPrice(v));
  return Math.min(...prices);
}

// æª¢æŸ¥æ˜¯å¦æœ‰æŠ˜æ‰£
export function hasDiscount(variant: Product['variants'][0]): boolean {
  if (!variant.calculated_price) return false;
  return variant.calculated_price.calculated_amount < variant.calculated_price.original_amount;
}
</file>

<file path="next.config.js">
/** @type {import('next').NextConfig} */
const nextConfig = {
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: '**',
      },
    ],
  },
};

module.exports = nextConfig;
</file>

<file path="package.json">
{
  "name": "storefront-template",
  "version": "1.0.0",
  "description": "E-commerce storefront template with Medusa backend",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "next": "14.1.0",
    "react": "18.2.0",
    "react-dom": "18.2.0"
  },
  "devDependencies": {
    "@types/node": "20.11.0",
    "@types/react": "18.2.48",
    "@types/react-dom": "18.2.18",
    "autoprefixer": "10.4.17",
    "postcss": "8.4.33",
    "tailwindcss": "3.4.1",
    "typescript": "5.3.3"
  },
  "engines": {
    "node": ">=18.0.0"
  }
}
</file>

<file path="postcss.config.js">
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
};
</file>

<file path="README.md">
# Storefront Template

é›»å•†å‰ç«¯æ¨¡æ¿ï¼Œä½¿ç”¨ Medusa ä½œç‚ºå¾Œç«¯ã€ECPay Gateway è™•ç†é‡‘æµç‰©æµã€‚

## å¿«é€Ÿé–‹å§‹

### 1. å®‰è£ä¾è³´

```bash
npm install
```

### 2. è¨­å®š `config/store.json`

ä¿®æ”¹ä»¥ä¸‹è¨­å®šï¼š

```json
{
  "store": {
    "name": "ä½ çš„å•†åº—åç¨±",
    "domain": "shop.yourdomain.com"
  },
  "medusa": {
    "backendUrl": "ä½ çš„ Medusa URL",
    "publishableKey": "ä½ çš„ Publishable Key",
    "regionId": "ä½ çš„ Region ID",
    "salesChannelId": "ä½ çš„ Sales Channel ID"
  },
  "gateway": {
    "url": "ä½ çš„ Gateway URL",
    "apiKey": "ä½ çš„ API Key"
  }
}
```

### 3. å•Ÿå‹•é–‹ç™¼ä¼ºæœå™¨

```bash
npm run dev
```

### 4. éƒ¨ç½²åˆ° Vercel

```bash
vercel --prod
```

## ç›®éŒ„çµæ§‹

```
â”œâ”€â”€ config/
â”‚   â””â”€â”€ store.json           # å•†åº—è¨­å®šï¼ˆå”¯ä¸€éœ€è¦ä¿®æ”¹çš„æª”æ¡ˆï¼‰
â”œâ”€â”€ public/
â”‚   â””â”€â”€ tenant/              # å•†åº—è³‡æºï¼ˆLogoã€Faviconï¼‰
â”œâ”€â”€ app/                     # Next.js é é¢
â”œâ”€â”€ components/              # React å…ƒä»¶
â”œâ”€â”€ lib/                     # å·¥å…·å‡½å¼
â””â”€â”€ styles/                  # å…¨åŸŸæ¨£å¼
```

## å®¢è£½åŒ–æŒ‡å—

### ä¿®æ”¹ä¸»é¡Œé¡è‰²

ç·¨è¼¯ `config/store.json` çš„ `theme` å€å¡Šï¼š

```json
{
  "theme": {
    "primaryColor": "#000000",
    "accentColor": "#dc2626"
  }
}
```

### æ›´æ› Logo

1. å°‡ Logo æ”¾åˆ° `public/tenant/logo.png`
2. æ›´æ–° `config/store.json` çš„ `store.logo` è·¯å¾‘

### å•Ÿç”¨/åœç”¨åŠŸèƒ½

```json
{
  "features": {
    "cart": true,
    "checkout": true,
    "cvsLogistics": true,
    "homeDelivery": true
  }
}
```

## æŠ€è¡“æ£§

- **æ¡†æ¶**: Next.js 14 (App Router)
- **æ¨£å¼**: Tailwind CSS
- **å¾Œç«¯**: Medusa v2.x
- **é‡‘æµ**: ECPay Gateway

## License

MIT
</file>

<file path="styles/globals.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  --color-primary: #000000;
  --color-secondary: #f5f5f5;
  --color-accent: #dc2626;
  --font-family: system-ui, -apple-system, sans-serif;
  --border-radius: 0.5rem;
}

/* åŸºæœ¬æ¨£å¼é‡ç½® */
body {
  font-family: var(--font-family);
  background-color: #ffffff;
  color: #1a1a1a;
}

/* æŒ‰éˆ•æ¨£å¼ */
@layer components {
  .btn {
    @apply inline-flex items-center justify-center px-4 py-2 font-medium transition-colors duration-200;
    border-radius: var(--border-radius);
  }
  
  .btn-primary {
    @apply btn bg-primary text-white hover:opacity-90;
  }
  
  .btn-secondary {
    @apply btn bg-secondary text-primary hover:bg-gray-200;
  }
  
  .btn-outline {
    @apply btn border-2 border-primary text-primary hover:bg-primary hover:text-white;
  }
  
  .btn-accent {
    @apply btn bg-accent text-white hover:opacity-90;
  }
}

/* è¼¸å…¥æ¡†æ¨£å¼ */
@layer components {
  .input {
    @apply w-full px-4 py-2 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent;
    border-radius: var(--border-radius);
  }
}

/* å¡ç‰‡æ¨£å¼ */
@layer components {
  .card {
    @apply bg-white shadow-sm hover:shadow-md transition-shadow duration-200;
    border-radius: var(--border-radius);
  }
}

/* åƒ¹æ ¼æ¨£å¼ */
.price {
  @apply text-lg font-bold;
}

.price-original {
  @apply text-gray-400 line-through text-sm;
}

.price-sale {
  @apply text-accent font-bold;
}

/* å‹•ç•« */
@keyframes slide-in-right {
  from {
    transform: translateX(100%);
  }
  to {
    transform: translateX(0);
  }
}

.animate-slide-in-right {
  animation: slide-in-right 0.3s ease-out;
}

@keyframes fade-in {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

.animate-fade-in {
  animation: fade-in 0.2s ease-out;
}
</file>

<file path="tailwind.config.js">
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    './app/**/*.{js,ts,jsx,tsx,mdx}',
    './components/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
    extend: {
      colors: {
        // å¯é€é CSS è®Šæ•¸è¦†å¯«
        primary: 'var(--color-primary, #000000)',
        secondary: 'var(--color-secondary, #f5f5f5)',
        accent: 'var(--color-accent, #dc2626)',
      },
      fontFamily: {
        sans: ['var(--font-family)', 'system-ui', '-apple-system', 'sans-serif'],
      },
      borderRadius: {
        DEFAULT: 'var(--border-radius, 0.5rem)',
      },
    },
  },
  plugins: [],
};
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "es5",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
</file>

</files>
